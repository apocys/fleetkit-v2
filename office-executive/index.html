<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpawnKit — Executive Office</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ═══════════════════════════════════════════════════════════════
           SpawnKit Executive Office v3 — Apple × Linear × Raycast
           Premium light-mode AI workspace. SS+ quality.
           SVG Avatars + Hierarchy View + Agent TODO Panel
           ═══════════════════════════════════════════════════════════════ */

        :root {
            /* ── iOS Brand Palette ──────────────────────────── */
            --exec-blue: #0071e3;
            --exec-blue-hover: #0077ed;
            --exec-blue-muted: rgba(0, 113, 227, 0.1);
            --exec-blue-glow: rgba(0, 113, 227, 0.2);
            --exec-white: #FFFFFF;
            --exec-gray-50: #F5F5F7;
            --exec-gray-100: #E5E5EA;
            --exec-gray-200: #D2D2D7;
            --exec-gray-300: #AEAEB2;
            --exec-gray-400: #86868b;
            --exec-gray-500: #636366;
            --exec-gray-600: #48484A;
            --exec-gray-700: #3A3A3C;
            --exec-gray-800: #2C2C2E;
            --exec-gray-900: #1C1C1E;
            --exec-black: #000000;

            /* ── Apple Dark Mode (Default) ──────────────────── */
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --bg-room: rgba(28, 28, 30, 0.85);
            --bg-room-hover: rgba(44, 44, 46, 0.95);
            --bg-frosted: rgba(29, 29, 31, 0.72);
            --text-primary: #f5f5f7;
            --text-secondary: #86868b;
            --text-tertiary: #636366;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-medium: rgba(255, 255, 255, 0.1);
            --border-strong: rgba(255, 255, 255, 0.16);

            /* ── Semantic / Status Colors ───────────────────── */
            --status-active: #30d158;
            --status-busy: #ffd60a;
            --status-idle: #636366;
            --status-error: #ff453a;
            --color-success: #30d158;
            --color-error: #ff453a;
            --color-warning: #ffd60a;
            --color-info: #64d2ff;

            /* ── Accent Colors ──────────────────────────────── */
            --color-accent: #0071e3;
            --color-accent-hover: #0077ed;
            --color-accent-active: #006edb;
            --color-accent-light: rgba(0, 113, 227, 0.1);

            /* ── Agent Brand Colors ─────────────────────────── */
            --color-ceo: #0071e3;
            --color-atlas: #BF5AF2;
            --color-forge: #FF9F0A;
            --color-hunter: #FF453A;
            --color-echo: #0A84FF;
            --color-sentinel: #30D158;

            /* ── Typography (Apple HIG) ─────────────────────── */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1.0625rem;
            --text-lg: 1.25rem;
            --text-xl: 1.375rem;

            /* ── Spacing (4px base) ─────────────────────────── */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;

            /* ── Border Radius (Apple) ──────────────────────── */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-pill: 980px;
            --radius-round: 50%;

            /* ── Shadows (Dark Mode) ────────────────────────── */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.4);
            --shadow-card: 0 2px 20px rgba(0, 0, 0, 0.06);

            /* ── Animation (Apple curves) ───────────────────── */
            --ease-smooth: cubic-bezier(0.2, 0.8, 0.2, 1);
            --ease-spring: cubic-bezier(0.25, 1, 0.5, 1);
            --ease-out: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ease-apple: cubic-bezier(0.4, 0, 0.2, 1);
            --duration-fast: 150ms;
            --duration-normal: 300ms;
            --duration-slow: 500ms;

            /* ── Layout ─────────────────────────────────────── */
            --room-radius: var(--radius-lg);
            --panel-width: 380px;
        }

        /* ═══════════════════════════════════════════════════
           Reset & Base
           ═══════════════════════════════════════════════════ */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: var(--font-family);
            font-size: 16px;
            line-height: 1.47;
            letter-spacing: -0.005em;
            background: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* ═══════════════════════════════════════════════════
           Ambient Background — Subtle Grain + Gradient
           ═══════════════════════════════════════════════════ */
        .exec-backdrop {
            position: fixed;
            inset: 0;
            z-index: 0;
            background:
                radial-gradient(ellipse 80% 60% at 50% 20%, rgba(0, 113, 227, 0.04) 0%, transparent 70%),
                radial-gradient(ellipse 60% 40% at 80% 80%, rgba(0, 113, 227, 0.02) 0%, transparent 60%),
                var(--bg-primary);
            pointer-events: none;
        }

        /* ── Floating Ambient Particles ─────────────────── */
        .exec-particles {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .exec-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: rgba(0, 113, 227, 0.08);
            border-radius: 50%;
            animation: particleDrift linear infinite;
        }

        .exec-particle:nth-child(1) {
            left: 15%;
            top: 30%;
            animation-duration: 28s;
            animation-delay: 0s;
        }
        .exec-particle:nth-child(2) {
            left: 70%;
            top: 60%;
            width: 2px;
            height: 2px;
            background: rgba(0, 113, 227, 0.1);
            animation-duration: 34s;
            animation-delay: -8s;
        }
        .exec-particle:nth-child(3) {
            left: 45%;
            top: 80%;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.03);
            animation-duration: 22s;
            animation-delay: -14s;
        }

        @keyframes particleDrift {
            0%   { transform: translate(0, 0) scale(1); opacity: 0; }
            10%  { opacity: 1; }
            50%  { transform: translate(40px, -60px) scale(1.3); }
            90%  { opacity: 1; }
            100% { transform: translate(-20px, -120px) scale(0.8); opacity: 0; }
        }

        /* ═══════════════════════════════════════════════════
           Main Layout Container
           ═══════════════════════════════════════════════════ */
        .exec-container {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* ═══════════════════════════════════════════════════
           View Toggle Bar
           ═══════════════════════════════════════════════════ */
        .exec-view-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 12px 24px 0;
            flex-shrink: 0;
        }

        .view-toggle-group {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.06);
            border: 0.5px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 3px;
            gap: 2px;
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
        }

        .view-toggle-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-family: var(--font-family);
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-apple);
            -webkit-tap-highlight-color: transparent;
            outline: none;
            white-space: nowrap;
        }

        .view-toggle-btn:hover {
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
        }

        .view-toggle-btn.active {
            background: rgba(255, 255, 255, 0.12);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .view-toggle-btn:focus-visible {
            outline: 2px solid var(--exec-blue);
            outline-offset: 2px;
        }

        .view-toggle-icon {
            font-size: 14px;
            line-height: 1;
        }

        /* ═══════════════════════════════════════════════════
           Office Floor — CSS Grid Layout (Grid View)
           ═══════════════════════════════════════════════════ */
        .exec-floor {
            flex: 1;
            padding: 16px 24px 24px;
            display: grid;
            grid-template-columns: 1fr 1.6fr 1fr;
            grid-template-rows: 1fr 1fr 0.8fr auto;
            gap: 12px;
            max-width: 1200px;
            max-height: calc(100vh - 112px);
            margin: 0 auto;
            width: 100%;
            transition: opacity 0.3s var(--ease-smooth);
        }

        .exec-floor.hidden {
            display: none;
        }

        /* ═══════════════════════════════════════════════════
           Hierarchy / Org Chart View
           ═══════════════════════════════════════════════════ */
        .exec-hierarchy {
            flex: 1;
            padding: 16px 24px 24px;
            display: none;
            flex-direction: column;
            align-items: center;
            max-width: 1200px;
            max-height: calc(100vh - 112px);
            margin: 0 auto;
            width: 100%;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--exec-gray-300) transparent;
        }

        .exec-hierarchy.visible {
            display: flex;
        }

        .exec-hierarchy::-webkit-scrollbar { width: 4px; }
        .exec-hierarchy::-webkit-scrollbar-thumb { background: var(--exec-gray-300); border-radius: 2px; }

        /* ── Org Tree Structure ──────────────────────────── */
        .org-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            padding: 12px 0;
            width: 100%;
        }

        /* ── Tree Node (generic) ────────────────────────── */
        .org-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .org-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 22px;
            background: var(--bg-room);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border: 0.5px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-apple);
            min-width: 180px;
        }

        .org-card:hover {
            background: var(--bg-room-hover);
            border-color: var(--border-medium);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .org-card--ceo {
            padding: 18px 28px;
            background: linear-gradient(135deg, rgba(28,28,30,0.95), rgba(44,44,46,0.85));
            border-color: var(--border-medium);
            box-shadow: var(--shadow-md);
        }

        .org-card--ceo:hover {
            box-shadow: var(--shadow-lg), 0 0 0 1px rgba(0, 113, 227, 0.15);
        }

        .org-card-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .org-card-info .agent-name {
            font-size: 14px;
            font-weight: 600;
        }

        .org-card-info .agent-role {
            font-size: 11px;
        }

        .org-card--ceo .org-card-info .agent-name {
            font-size: 16px;
            font-weight: 700;
        }

        .org-card--ceo .org-card-info .agent-role {
            font-size: 12px;
        }

        /* ── Tree Connector Lines ───────────────────────── */
        .org-connector {
            width: 2px;
            height: 28px;
            background: var(--border-medium);
            flex-shrink: 0;
        }

        .org-connector--branch {
            width: 2px;
            height: 20px;
            background: var(--border-medium);
        }

        .org-children {
            display: flex;
            justify-content: center;
            gap: 16px;
            position: relative;
            padding-top: 0;
        }

        /* Horizontal connecting bar above children */
        .org-children::before {
            content: '';
            position: absolute;
            top: 0;
            left: calc(50% - var(--bar-half-width, 200px));
            right: calc(50% - var(--bar-half-width, 200px));
            height: 2px;
            background: var(--border-medium);
        }

        .org-child {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ═══════════════════════════════════════════════════
           Room — Base Component
           ═══════════════════════════════════════════════════ */
        .exec-room {
            position: relative;
            background: var(--bg-room);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border: 0.5px solid var(--border-subtle);
            border-radius: var(--room-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition:
                background var(--duration-normal) var(--ease-apple),
                border-color var(--duration-normal) var(--ease-apple),
                transform var(--duration-normal) var(--ease-apple),
                box-shadow var(--duration-normal) var(--ease-apple);
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        .exec-room::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: radial-gradient(ellipse at 50% 0%, rgba(0,113,227,0.02) 0%, transparent 70%);
            pointer-events: none;
        }

        .exec-room:hover {
            background: var(--bg-room-hover);
            border-color: var(--border-medium);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .exec-room:focus-visible {
            outline: 2px solid var(--exec-blue);
            outline-offset: 2px;
        }

        .exec-room:active {
            transform: translateY(0);
        }

        /* ── Room Label (top-left) ──────────────────────── */
        .exec-room-label {
            position: absolute;
            top: 12px;
            left: 16px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: var(--text-tertiary);
        }

        /* ═══════════════════════════════════════════════════
           CEO Room — Hero Room (center-top, spans full width)
           ═══════════════════════════════════════════════════ */
        .exec-room--ceo {
            grid-column: 1 / -1;
            grid-row: 1;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 32px;
            padding: 28px 36px;
            background: linear-gradient(135deg,
                rgba(28, 28, 30, 0.95) 0%,
                rgba(44, 44, 46, 0.85) 100%
            );
            border-color: var(--border-medium);
        }

        .exec-room--ceo::after {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(
                135deg,
                rgba(0, 113, 227, 0.15) 0%,
                rgba(0, 113, 227, 0) 40%,
                rgba(0, 113, 227, 0) 60%,
                rgba(0, 113, 227, 0.1) 100%
            );
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            animation: ceoBorderShift 8s ease-in-out infinite alternate;
        }

        @keyframes ceoBorderShift {
            0%   { opacity: 0.5; }
            50%  { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .exec-room--ceo:hover {
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(0, 113, 227, 0.15);
        }

        .ceo-content {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .ceo-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .ceo-info .agent-name {
            font-size: 18px;
            font-weight: 700;
        }

        .ceo-info .agent-role {
            font-size: 13px;
        }

        /* ── Mailbox Button ─────────────────────────────── */
        .ceo-mailbox {
            position: absolute;
            top: 16px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 18px;
            background: var(--exec-blue-muted);
            border: 1px solid rgba(0, 113, 227, 0.2);
            border-radius: var(--radius-pill);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-apple);
            font-family: inherit;
            color: var(--exec-blue);
            font-size: 13px;
            font-weight: 600;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        .ceo-mailbox:hover {
            background: rgba(0, 113, 227, 0.2);
            border-color: rgba(0, 113, 227, 0.4);
            transform: translateY(-1px);
        }

        .ceo-mailbox:focus-visible {
            outline: 2px solid var(--exec-blue);
            outline-offset: 2px;
        }

        .ceo-mailbox-icon {
            font-size: 18px;
            line-height: 1;
        }

        .ceo-mailbox-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: var(--exec-blue);
            color: var(--exec-white);
            font-size: 11px;
            font-weight: 700;
            border-radius: 9px;
            line-height: 1;
        }

        /* ═══════════════════════════════════════════════════
           Agent Avatar — SVG Container
           ═══════════════════════════════════════════════════ */
        .agent-avatar {
            position: relative;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.3s var(--ease-spring), box-shadow 0.3s var(--ease-smooth);
            overflow: hidden;
        }

        .agent-avatar svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .agent-avatar--lg {
            width: 56px;
            height: 56px;
        }

        .exec-room:hover .agent-avatar,
        .org-card:hover .agent-avatar {
            transform: scale(1.08);
        }

        /* ── Status Dot ─────────────────────────────────── */
        .agent-status-dot {
            position: absolute;
            bottom: 1px;
            right: 1px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--bg-secondary);
            transition: background var(--duration-normal) var(--ease-apple);
            z-index: 2;
        }

        .agent-status-dot--active { background: var(--status-active); }
        .agent-status-dot--busy   { background: var(--status-busy); }
        .agent-status-dot--idle   { background: var(--status-idle); }

        /* ── Agent Text ─────────────────────────────────── */
        .agent-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .agent-role {
            font-size: 11px;
            font-weight: 400;
            color: var(--text-tertiary);
            line-height: 1.2;
        }

        /* ═══════════════════════════════════════════════════
           Agent Rooms — Grid Placement
           ═══════════════════════════════════════════════════ */
        .exec-room--atlas    { grid-column: 1; grid-row: 2; }
        .exec-room--forge    { grid-column: 2; grid-row: 2; }
        .exec-room--hunter   { grid-column: 3; grid-row: 2; }
        .exec-room--echo     { grid-column: 1; grid-row: 3; }
        .exec-room--meeting  { grid-column: 2; grid-row: 3; }
        .exec-room--sentinel { grid-column: 3; grid-row: 3; }

        /* ═══════════════════════════════════════════════════
           Meeting Room — Boardroom
           ═══════════════════════════════════════════════════ */
        .exec-room--meeting {
            background: linear-gradient(135deg, rgba(28, 28, 30, 0.9), rgba(44, 44, 46, 0.9));
            border: 0.5px solid var(--border-medium);
            cursor: pointer;
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
            padding: 18px 22px;
        }

        .exec-room--meeting:hover {
            background: linear-gradient(135deg, rgba(44, 44, 46, 0.95), rgba(58, 58, 60, 0.95));
            border-color: var(--border-strong);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .meeting-status {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        .meeting-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .meeting-icon {
            font-size: 24px;
            opacity: 0.7;
        }

        .meeting-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--exec-blue);
            color: var(--exec-white);
            font-size: 11px;
            font-weight: 700;
            border-radius: 10px;
            line-height: 1;
            animation: meetingPulse 3s ease-in-out infinite;
        }

        @keyframes meetingPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(0, 113, 227, 0.7);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 0 4px rgba(0, 113, 227, 0);
                transform: scale(1.05);
            }
        }

        .meeting-preview {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 100%;
        }

        .meeting-active {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            padding: 4px 8px;
            background: rgba(0, 113, 227, 0.08);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--exec-blue);
        }

        /* ═══════════════════════════════════════════════════
           Agent Detail Expand Panel (in-place)
           ═══════════════════════════════════════════════════ */
        .agent-detail {
            display: none;
            width: 100%;
            padding-top: 8px;
            border-top: 1px solid var(--border-subtle);
            margin-top: 4px;
        }

        .agent-detail.visible {
            display: block;
            animation: detailSlideIn 0.3s var(--ease-smooth);
        }

        @keyframes detailSlideIn {
            from { opacity: 0; transform: translateY(-4px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .agent-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 11px;
        }

        .agent-detail-label {
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .agent-detail-value {
            color: var(--text-secondary);
            font-weight: 400;
            text-align: right;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ═══════════════════════════════════════════════════
           Mailbox Slide-In Panel
           ═══════════════════════════════════════════════════ */
        .mailbox-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s var(--ease-smooth);
        }

        .mailbox-overlay.open {
            pointer-events: auto;
            opacity: 1;
        }

        .mailbox-overlay.open .mailbox-backdrop {
            opacity: 1;
        }

        .mailbox-overlay.open .mailbox-panel {
            transform: translateX(0);
        }

        .mailbox-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.35s var(--ease-smooth);
        }

        .mailbox-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: var(--panel-width);
            max-width: 90vw;
            height: 100%;
            background: var(--bg-secondary);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-left: 0.5px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s var(--ease-apple);
            box-shadow: var(--shadow-lg);
        }

        .mailbox-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 0.5px solid var(--border-subtle);
            flex-shrink: 0;
        }

        .mailbox-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mailbox-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
            border-radius: var(--radius-round);
            cursor: pointer;
            font-size: 16px;
            transition: all var(--duration-fast) var(--ease-apple);
            font-family: inherit;
            -webkit-tap-highlight-color: transparent;
        }

        .mailbox-close:hover {
            background: rgba(255, 255, 255, 0.14);
            color: var(--text-primary);
        }

        .mailbox-close:focus-visible {
            outline: 2px solid var(--exec-blue);
            outline-offset: 2px;
        }

        .mailbox-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
            scrollbar-width: thin;
            scrollbar-color: var(--exec-gray-300) transparent;
        }

        .mailbox-messages::-webkit-scrollbar {
            width: 4px;
        }

        .mailbox-messages::-webkit-scrollbar-thumb {
            background: var(--exec-gray-300);
            border-radius: 2px;
        }

        /* ── Message Item ───────────────────────────────── */
        .mail-item {
            display: flex;
            gap: 12px;
            padding: 14px 24px;
            transition: background 0.2s var(--ease-smooth);
            cursor: pointer;
            position: relative;
        }

        .mail-item:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .mail-item--read {
            opacity: 0.7;
        }

        .mail-item--read .mail-preview {
            color: var(--text-tertiary);
        }

        .mail-unread-dot {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: var(--exec-blue);
            border-radius: 50%;
            animation: unreadPulse 2s ease-in-out infinite;
        }

        @keyframes unreadPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .mail-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: var(--exec-white);
            flex-shrink: 0;
            overflow: hidden;
        }

        .mail-avatar svg {
            width: 100%;
            height: 100%;
        }

        .mail-content {
            flex: 1;
            min-width: 0;
        }

        .mail-header {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 3px;
        }

        .mail-sender {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .mail-time {
            font-size: 11px;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }

        .mail-preview {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mail-divider {
            height: 1px;
            background: var(--border-subtle);
            margin: 0 24px;
        }

        /* ═══════════════════════════════════════════════════
           Agent TODO Panel — Slide-In from Right
           ═══════════════════════════════════════════════════ */
        .todo-overlay {
            position: fixed;
            inset: 0;
            z-index: 200;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s var(--ease-smooth);
        }

        .todo-overlay.open {
            pointer-events: auto;
            opacity: 1;
        }

        .todo-overlay.open .todo-backdrop {
            opacity: 1;
        }

        .todo-overlay.open .todo-panel {
            transform: translateX(0);
        }

        .todo-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.35s var(--ease-smooth);
        }

        .todo-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: var(--panel-width);
            max-width: 90vw;
            height: 100%;
            background: var(--bg-secondary);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-left: 0.5px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s var(--ease-apple);
            box-shadow: var(--shadow-lg);
        }

        .todo-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px 16px;
            border-bottom: 0.5px solid var(--border-subtle);
            flex-shrink: 0;
        }

        .todo-agent-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .todo-agent-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .todo-agent-avatar svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .todo-agent-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .todo-agent-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .todo-agent-role {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-tertiary);
            line-height: 1.2;
        }

        .todo-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
            border-radius: var(--radius-round);
            cursor: pointer;
            font-size: 16px;
            transition: all var(--duration-fast) var(--ease-apple);
            font-family: inherit;
            -webkit-tap-highlight-color: transparent;
        }

        .todo-close:hover {
            background: rgba(255, 255, 255, 0.14);
            color: var(--text-primary);
        }

        .todo-close:focus-visible {
            outline: 2px solid var(--exec-blue);
            outline-offset: 2px;
        }

        .todo-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--exec-gray-300) transparent;
        }

        .todo-content::-webkit-scrollbar {
            width: 4px;
        }

        .todo-content::-webkit-scrollbar-thumb {
            background: var(--exec-gray-300);
            border-radius: 2px;
        }

        /* ── TODO Sections ──────────────────────────────── */
        .todo-section {
            padding: 20px 24px;
            border-bottom: 0.5px solid var(--border-subtle);
        }

        .todo-section:last-child {
            border-bottom: none;
        }

        .todo-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 12px;
        }

        .todo-current-task {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .todo-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        .todo-icon {
            font-size: 16px;
            line-height: 1;
            width: 18px;
            text-align: center;
            flex-shrink: 0;
        }

        .todo-text {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.3;
            flex: 1;
        }

        .todo-item--done .todo-text {
            color: var(--text-tertiary);
            text-decoration: line-through;
        }

        .todo-item--progress .todo-text {
            color: var(--text-primary);
        }

        .todo-item--pending .todo-text {
            color: var(--text-secondary);
        }

        /* ── Skills Section ─────────────────────────────── */
        .todo-skills {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .skill-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .skill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .skill-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .skill-percentage {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
        }

        .skill-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 3px;
            overflow: hidden;
        }

        .skill-progress {
            height: 100%;
            background: var(--exec-blue);
            border-radius: 3px;
            transition: width 0.6s var(--ease-smooth);
        }

        /* ═══════════════════════════════════════════════════════════════
           Meeting Room Panel — Similar to TODO Panel
           ═══════════════════════════════════════════════════════════════ */
        .meeting-overlay {
            position: fixed;
            inset: 0;
            z-index: 200;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s var(--ease-smooth);
        }

        .meeting-overlay.open {
            pointer-events: auto;
            opacity: 1;
        }

        .meeting-overlay.open .meeting-backdrop {
            opacity: 1;
        }

        .meeting-overlay.open .meeting-panel {
            transform: translateX(0);
        }

        .meeting-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.35s var(--ease-smooth);
        }

        .meeting-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: var(--panel-width);
            max-width: 90vw;
            height: 100%;
            background: var(--bg-secondary);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-left: 0.5px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s var(--ease-apple);
            box-shadow: var(--shadow-lg);
        }

        .meeting-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px 16px;
            border-bottom: 0.5px solid var(--border-subtle);
            flex-shrink: 0;
        }

        .meeting-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meeting-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
            border-radius: var(--radius-round);
            cursor: pointer;
            font-size: 16px;
            transition: all var(--duration-fast) var(--ease-apple);
            font-family: inherit;
            -webkit-tap-highlight-color: transparent;
        }

        .meeting-close:hover {
            background: rgba(255, 255, 255, 0.14);
            color: var(--text-primary);
        }

        .meeting-close:focus-visible {
            outline: 2px solid var(--exec-blue);
            outline-offset: 2px;
        }

        .meeting-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--exec-gray-300) transparent;
        }

        .meeting-content::-webkit-scrollbar {
            width: 4px;
        }

        .meeting-content::-webkit-scrollbar-thumb {
            background: var(--exec-gray-300);
            border-radius: 2px;
        }

        /* ── Meeting Sections ──────────────────────────── */
        .meeting-section {
            padding: 20px 24px;
            border-bottom: 0.5px solid var(--border-subtle);
        }

        .meeting-section:last-child {
            border-bottom: none;
        }

        .meeting-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 12px;
        }

        .meeting-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .meeting-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 14px 16px;
            background: rgba(0, 113, 227, 0.06);
            border-left: 3px solid var(--exec-blue);
            border-radius: var(--radius-md);
        }

        .meeting-item--active {
            border-left-color: #ff453a;
            background: rgba(255, 69, 58, 0.06);
        }

        .meeting-item--scheduled {
            border-left-color: #ffd60a;
            background: rgba(255, 214, 10, 0.06);
        }

        .meeting-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meeting-item-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .meeting-item-status {
            font-size: 11px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meeting-item--active .meeting-item-status {
            background: #FF453A;
            color: white;
        }

        .meeting-item--scheduled .meeting-item-status {
            background: #FFD60A;
            color: #8B6914;
        }

        .meeting-item-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .meeting-participants {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .meeting-participant {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: white;
            background: var(--exec-blue);
            overflow: hidden;
        }

        .meeting-participant svg {
            width: 100%;
            height: 100%;
        }

        /* ── Sub-Agent Display in Hierarchy ──────────── */
        .org-sub-level {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .org-sub-level-demo {
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .org-sub-children {
            display: flex;
            gap: 12px;
        }

        .org-sub-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: rgba(0, 113, 227, 0.06);
            border: 0.5px solid rgba(0, 113, 227, 0.15);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-apple);
            min-width: 100px;
        }

        .org-sub-card:hover {
            background: rgba(0, 113, 227, 0.12);
            border-color: rgba(0, 113, 227, 0.3);
            transform: translateY(-1px);
        }

        .sub-agent-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .sub-agent-role {
            font-size: 10px;
            font-weight: 400;
            color: var(--text-tertiary);
            line-height: 1.2;
        }

        /* ═══════════════════════════════════════════════════
           Status Bar — Frosted Glass Bottom Bar
           ═══════════════════════════════════════════════════ */
        .exec-statusbar {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 24px;
            background: var(--bg-frosted);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-top: 0.5px solid var(--border-subtle);
            flex-shrink: 0;
        }

        .statusbar-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }

        .statusbar-item {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .statusbar-item-icon {
            font-size: 14px;
        }

        .statusbar-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--status-active);
            animation: statusPulse 2.5s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .statusbar-separator {
            width: 1px;
            height: 16px;
            background: var(--border-subtle);
        }

        /* ── Command Input ──────────────────────────────── */
        .exec-command-input {
            flex: 1;
            position: relative;
        }

        .exec-command-input input {
            width: 100%;
            height: 40px;
            padding: 0 16px 0 38px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: var(--text-sm);
            font-weight: 400;
            outline: none;
            transition:
                border-color var(--duration-fast) var(--ease-apple),
                background var(--duration-fast) var(--ease-apple),
                box-shadow var(--duration-fast) var(--ease-apple);
        }

        .exec-command-input input::placeholder {
            color: var(--text-tertiary);
        }

        .exec-command-input input:focus {
            background: var(--bg-tertiary);
            border-color: var(--exec-blue);
            box-shadow: 0 0 0 3px var(--exec-blue-muted);
        }

        .exec-command-input .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: 15px;
            pointer-events: none;
            transition: color 0.25s var(--ease-smooth);
        }

        .exec-command-input input:focus ~ .input-icon {
            color: var(--exec-blue);
        }

        /* ═══════════════════════════════════════════════════
           Responsive — Mobile / Small Viewports
           ═══════════════════════════════════════════════════ */
        @media (max-width: 768px) {
            .exec-floor {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto;
                gap: 10px;
                padding: 16px;
                max-height: none;
                overflow-y: auto;
            }

            .exec-room--ceo {
                grid-column: 1 / -1;
                grid-row: auto;
                flex-direction: column;
                gap: 16px;
                padding: 20px;
            }

            .ceo-content {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .ceo-mailbox {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 8px;
            }

            .exec-room--atlas    { grid-column: 1; grid-row: auto; }
            .exec-room--forge    { grid-column: 2; grid-row: auto; }
            .exec-room--hunter   { grid-column: 1; grid-row: auto; }
            .exec-room--echo     { grid-column: 2; grid-row: auto; }
            .exec-room--meeting  { grid-column: 1 / -1; grid-row: auto; }
            .exec-room--sentinel { grid-column: 1 / -1; grid-row: auto; }

            .exec-room {
                padding: 16px;
                min-height: 100px;
            }

            .agent-avatar { width: 40px; height: 40px; }
            .agent-avatar--lg { width: 48px; height: 48px; }

            .statusbar-info { gap: 10px; }
            .statusbar-item { font-size: 11px; }

            .mailbox-panel,
            .todo-panel,
            .meeting-panel,
            .spawn-panel { 
                width: 100vw; 
            }

            .spawn-char-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            /* Hierarchy responsive */
            .org-children {
                flex-wrap: wrap;
                gap: 12px;
            }

            .org-card {
                min-width: 140px;
                padding: 10px 14px;
                gap: 10px;
            }

            .org-card .agent-avatar {
                width: 36px;
                height: 36px;
            }
        }

        @media (max-width: 480px) {
            .exec-floor {
                grid-template-columns: 1fr;
                padding: 12px;
            }

            .exec-room--atlas,
            .exec-room--forge,
            .exec-room--hunter,
            .exec-room--echo,
            .exec-room--sentinel {
                grid-column: 1;
            }

            .exec-statusbar {
                flex-direction: column;
                gap: 10px;
                padding: 12px 16px;
            }

            .statusbar-info {
                width: 100%;
                justify-content: center;
            }

            .org-children {
                flex-direction: column;
                align-items: center;
            }

            .org-children::before {
                display: none;
            }
        }

        /* ═══════════════════════════════════════════════════
           Accessibility — Focus-Visible Ring
           ═══════════════════════════════════════════════════ */
        :focus-visible {
            outline: 2px solid var(--exec-blue);
            outline-offset: 2px;
        }

        /* Disable outline for mouse users */
        :focus:not(:focus-visible) {
            outline: none;
        }

        /* ═══════════════════════════════════════════════════
           Idle State — Pulse Animation
           ═══════════════════════════════════════════════════ */
        .agent-status-dot--idle {
            background: var(--status-idle);
            animation: idlePulse 3s ease-in-out infinite;
        }

        @keyframes idlePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.85); }
        }

        .agent-idle-label {
            font-size: 11px;
            color: var(--text-tertiary);
            font-weight: 400;
            margin-top: 2px;
        }

        /* ═══════════════════════════════════════════════════
           Agent Detail Panel — 420px Slide-In (Feature 1)
           ═══════════════════════════════════════════════════ */
        .detail-overlay {
            position: fixed;
            inset: 0;
            z-index: 200;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s var(--ease-smooth);
        }
        .detail-overlay.open {
            pointer-events: auto;
            opacity: 1;
        }
        .detail-overlay.open .detail-backdrop { opacity: 1; }
        .detail-overlay.open .detail-panel { transform: translateX(0); }
        .detail-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.35s var(--ease-smooth);
        }
        .detail-panel {
            position: absolute;
            top: 0; right: 0;
            width: 420px;
            max-width: 90vw;
            height: 100%;
            background: var(--bg-secondary);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-left: 0.5px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s var(--ease-apple);
            box-shadow: var(--shadow-lg);
        }
        .detail-hero {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 24px 24px 20px;
            border-bottom: 0.5px solid var(--border-subtle);
        }
        .detail-hero-avatar {
            width: 64px; height: 64px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }
        .detail-hero-avatar svg { width: 100%; height: 100%; display: block; }
        .detail-hero-status {
            position: absolute; bottom: 2px; right: 2px;
            width: 14px; height: 14px; border-radius: 50%;
            border: 2.5px solid var(--bg-secondary);
            z-index: 2;
        }
        .detail-hero-info { flex: 1; min-width: 0; }
        .detail-hero-name { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        .detail-hero-role { font-size: 13px; color: var(--text-tertiary); font-weight: 500; }
        .detail-hero-task {
            font-size: 12px; color: var(--exec-blue);
            margin-top: 4px; font-weight: 500;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .detail-close {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border: none; background: rgba(255, 255, 255, 0.08); color: var(--text-secondary);
            border-radius: var(--radius-round); cursor: pointer; font-size: 16px;
            transition: all var(--duration-fast) var(--ease-apple); font-family: inherit;
            flex-shrink: 0;
        }
        .detail-close:hover { background: rgba(255, 255, 255, 0.14); color: var(--text-primary); }
        .detail-body {
            flex: 1; overflow-y: auto; padding: 0;
            scrollbar-width: thin; scrollbar-color: var(--exec-gray-300) transparent;
        }
        .detail-body::-webkit-scrollbar { width: 4px; }
        .detail-body::-webkit-scrollbar-thumb { background: var(--exec-gray-300); border-radius: 2px; }
        .detail-section {
            padding: 18px 24px;
            border-bottom: 0.5px solid var(--border-subtle);
        }
        .detail-section:last-child { border-bottom: none; }
        .detail-section-title {
            font-size: 11px; font-weight: 600; color: var(--text-tertiary);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
        }
        .detail-metrics {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .detail-metric {
            padding: 12px 14px; background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }
        .detail-metric-value {
            font-size: 16px; font-weight: 700; color: var(--text-primary);
        }
        .detail-metric-label {
            font-size: 11px; color: var(--text-tertiary); margin-top: 2px;
        }
        .detail-todo-item {
            display: flex; align-items: center; gap: 10px;
            padding: 6px 0; font-size: 13px;
        }
        .detail-todo-icon { width: 18px; text-align: center; flex-shrink: 0; }
        .detail-todo-text { flex: 1; color: var(--text-primary); line-height: 1.3; }
        .detail-todo-item--done .detail-todo-text {
            color: var(--text-tertiary); text-decoration: line-through;
        }
        .detail-skill-chips {
            display: flex; flex-wrap: wrap; gap: 8px;
        }
        .detail-skill-chip {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 5px 12px; background: var(--exec-blue-muted);
            border-radius: 20px; font-size: 12px; font-weight: 500;
            color: var(--exec-blue);
        }
        .detail-soul-excerpt {
            font-size: 13px; color: var(--text-secondary);
            line-height: 1.5; white-space: pre-wrap;
            max-height: 200px; overflow-y: auto;
        }

        /* ═══════════════════════════════════════════════════
           CEO Chat Panel (Feature 2)
           ═══════════════════════════════════════════════════ */
        .chat-overlay {
            position: fixed;
            inset: 0;
            z-index: 250;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s var(--ease-smooth);
        }
        .chat-overlay.open {
            pointer-events: auto;
            opacity: 1;
        }
        .chat-overlay.open .chat-backdrop { opacity: 1; }
        .chat-overlay.open .chat-panel { transform: translateY(0); }
        .chat-backdrop {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.35s var(--ease-smooth);
        }
        .chat-panel {
            position: absolute;
            bottom: 0; right: 0;
            width: 480px; max-width: 100vw;
            height: 70vh;
            background: var(--bg-secondary);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-top-left-radius: var(--radius-xl);
            border-top-right-radius: var(--radius-xl);
            border-left: 0.5px solid var(--border-subtle);
            border-top: 0.5px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s var(--ease-apple);
            box-shadow: 0 -8px 40px rgba(0,0,0,0.3);
        }
        .chat-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 20px; border-bottom: 0.5px solid var(--border-subtle);
            flex-shrink: 0;
        }
        .chat-title {
            font-size: 15px; font-weight: 700; color: var(--text-primary);
            display: flex; align-items: center; gap: 8px;
        }
        .chat-title-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--status-active);
            animation: statusPulse 2.5s ease-in-out infinite;
        }
        .chat-close {
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border: none; background: rgba(255, 255, 255, 0.08); color: var(--text-secondary);
            border-radius: var(--radius-round); cursor: pointer; font-size: 14px;
            transition: all var(--duration-fast) var(--ease-apple); font-family: inherit;
        }
        .chat-close:hover { background: rgba(255, 255, 255, 0.14); color: var(--text-primary); }
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 16px 20px;
            display: flex; flex-direction: column; gap: 12px;
            scrollbar-width: thin; scrollbar-color: var(--exec-gray-300) transparent;
        }
        .chat-messages::-webkit-scrollbar { width: 4px; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--exec-gray-300); border-radius: 2px; }
        .chat-msg {
            max-width: 80%; padding: 10px 14px;
            border-radius: var(--radius-lg); font-size: var(--text-sm); line-height: 1.45;
            animation: chatMsgIn 0.25s var(--ease-apple);
        }
        @keyframes chatMsgIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-msg--user {
            align-self: flex-end;
            background: var(--exec-blue);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-msg--system {
            align-self: flex-start;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }
        .chat-msg-time {
            font-size: 10px; opacity: 0.6; margin-top: 4px;
        }
        .chat-msg--user .chat-msg-time { text-align: right; }
        .chat-input-bar {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 20px; border-top: 0.5px solid var(--border-subtle);
            flex-shrink: 0;
        }
        .chat-input {
            flex: 1; height: 40px; padding: 0 16px;
            background: var(--bg-tertiary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-pill); color: var(--text-primary);
            font-family: var(--font-family); font-size: var(--text-sm);
            outline: none; transition: border-color var(--duration-fast), box-shadow var(--duration-fast);
        }
        .chat-input:focus {
            border-color: var(--exec-blue);
            box-shadow: 0 0 0 3px var(--exec-blue-muted);
        }
        .chat-input::placeholder { color: var(--text-tertiary); }
        .chat-send {
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            background: var(--exec-blue); color: white;
            border: none; border-radius: var(--radius-round); cursor: pointer;
            font-size: 16px; transition: all var(--duration-fast) var(--ease-apple);
            flex-shrink: 0;
        }
        .chat-send:hover { background: var(--exec-blue-hover); transform: translateY(-1px); }
        .chat-send:active { transform: scale(0.95); }
        .chat-empty {
            flex: 1; display: flex; align-items: center; justify-content: center;
            color: var(--text-tertiary); font-size: 13px; text-align: center;
            padding: 40px;
        }

        /* ═══════════════════════════════════════════════════
           Cron / Calendar Overlay (Feature 4)
           ═══════════════════════════════════════════════════ */
        .cron-overlay {
            position: fixed; inset: 0; z-index: 200;
            pointer-events: none; opacity: 0;
            transition: opacity 0.3s var(--ease-smooth);
        }
        .cron-overlay.open { pointer-events: auto; opacity: 1; }
        .cron-overlay.open .cron-backdrop { opacity: 1; }
        .cron-overlay.open .cron-panel { transform: translateX(0); }
        .cron-backdrop {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.5); opacity: 0;
            transition: opacity 0.35s var(--ease-smooth);
        }
        .cron-panel {
            position: absolute; top: 0; right: 0;
            width: 420px; max-width: 90vw; height: 100%;
            background: var(--bg-secondary);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-left: 0.5px solid var(--border-subtle);
            display: flex; flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s var(--ease-apple);
            box-shadow: var(--shadow-lg);
        }
        .cron-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 24px; border-bottom: 0.5px solid var(--border-subtle);
            flex-shrink: 0;
        }
        .cron-title {
            font-size: 17px; font-weight: 700; color: var(--text-primary);
            display: flex; align-items: center; gap: 8px;
        }
        .cron-close {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border: none; background: rgba(255, 255, 255, 0.08); color: var(--text-secondary);
            border-radius: var(--radius-round); cursor: pointer; font-size: 16px;
            transition: all var(--duration-fast) var(--ease-apple); font-family: inherit;
        }
        .cron-close:hover { background: rgba(255, 255, 255, 0.14); color: var(--text-primary); }
        .cron-body {
            flex: 1; overflow-y: auto; padding: 0;
            scrollbar-width: thin; scrollbar-color: var(--exec-gray-300) transparent;
        }
        .cron-body::-webkit-scrollbar { width: 4px; }
        .cron-body::-webkit-scrollbar-thumb { background: var(--exec-gray-300); border-radius: 2px; }
        .cron-group {
            padding: 18px 24px;
            border-bottom: 0.5px solid var(--border-subtle);
        }
        .cron-group:last-child { border-bottom: none; }
        .cron-group-title {
            font-size: 11px; font-weight: 600; color: var(--text-tertiary);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
        }
        .cron-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 14px; background: var(--bg-tertiary);
            border-radius: var(--radius-md); margin-bottom: 8px;
            transition: background var(--duration-fast) var(--ease-apple);
        }
        .cron-item:last-child { margin-bottom: 0; }
        .cron-item:hover { background: rgba(255, 255, 255, 0.08); }
        .cron-item-icon { font-size: 20px; flex-shrink: 0; }
        .cron-item-info { flex: 1; min-width: 0; }
        .cron-item-name {
            font-size: 13px; font-weight: 600; color: var(--text-primary);
        }
        .cron-item-schedule {
            font-size: 11px; color: var(--text-tertiary); margin-top: 2px;
        }
        .cron-item-next {
            font-size: 11px; color: var(--exec-blue); margin-top: 1px;
        }
        .cron-item-status {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 3px 8px; border-radius: 6px;
            font-size: 10px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; flex-shrink: 0;
        }
        .cron-item-status--active { background: rgba(48,209,88,0.15); color: #30D158; }
        .cron-item-status--paused { background: rgba(255,214,10,0.15); color: #B89B00; }
        .cron-item-status--error { background: rgba(255,69,58,0.15); color: #FF453A; }
        .cron-toggle {
            width: 36px; height: 20px;
            background: var(--exec-gray-300);
            border-radius: 10px; border: none;
            cursor: pointer; position: relative;
            transition: background 0.25s; flex-shrink: 0;
        }
        .cron-toggle::after {
            content: ''; position: absolute;
            top: 2px; left: 2px;
            width: 16px; height: 16px;
            background: white; border-radius: 50%;
            transition: transform 0.25s var(--ease-smooth);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .cron-toggle.on { background: var(--status-active); }
        .cron-toggle.on::after { transform: translateX(16px); }
        .cron-empty {
            padding: 40px 24px; text-align: center;
            color: var(--text-tertiary); font-size: 13px;
        }

        /* ═══════════════════════════════════════════════════
           Memory View Overlay (Feature 5)
           ═══════════════════════════════════════════════════ */
        .memory-overlay {
            position: fixed; inset: 0; z-index: 200;
            pointer-events: none; opacity: 0;
            transition: opacity 0.3s var(--ease-smooth);
        }
        .memory-overlay.open { pointer-events: auto; opacity: 1; }
        .memory-overlay.open .memory-backdrop { opacity: 1; }
        .memory-overlay.open .memory-panel { transform: translateX(0); }
        .memory-backdrop {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.5); opacity: 0;
            transition: opacity 0.35s var(--ease-smooth);
        }
        .memory-panel {
            position: absolute; top: 0; right: 0;
            width: 500px; max-width: 90vw; height: 100%;
            background: var(--bg-secondary);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-left: 0.5px solid var(--border-subtle);
            display: flex; flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s var(--ease-apple);
            box-shadow: var(--shadow-lg);
        }
        .memory-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 24px; border-bottom: 0.5px solid var(--border-subtle);
            flex-shrink: 0;
        }
        .memory-title {
            font-size: 17px; font-weight: 700; color: var(--text-primary);
            display: flex; align-items: center; gap: 8px;
        }
        .memory-close {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border: none; background: rgba(255, 255, 255, 0.08); color: var(--text-secondary);
            border-radius: var(--radius-round); cursor: pointer; font-size: 16px;
            transition: all var(--duration-fast) var(--ease-apple); font-family: inherit;
        }
        .memory-close:hover { background: rgba(255, 255, 255, 0.14); color: var(--text-primary); }
        .memory-body {
            flex: 1; overflow-y: auto; padding: 0;
            scrollbar-width: thin; scrollbar-color: var(--exec-gray-300) transparent;
        }
        .memory-body::-webkit-scrollbar { width: 4px; }
        .memory-body::-webkit-scrollbar-thumb { background: var(--exec-gray-300); border-radius: 2px; }
        .memory-section {
            padding: 18px 24px;
            border-bottom: 0.5px solid var(--border-subtle);
        }
        .memory-section:last-child { border-bottom: none; }
        .memory-section-title {
            font-size: 11px; font-weight: 600; color: var(--text-tertiary);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
        }
        .memory-content-md {
            font-size: 13px; color: var(--text-secondary);
            line-height: 1.6;
        }
        .memory-content-md h1, .memory-content-md h2, .memory-content-md h3 {
            color: var(--text-primary); margin: 14px 0 6px; font-weight: 700;
        }
        .memory-content-md h1 { font-size: 18px; }
        .memory-content-md h2 { font-size: 15px; }
        .memory-content-md h3 { font-size: 13px; }
        .memory-content-md ul, .memory-content-md ol {
            padding-left: 18px; margin: 6px 0;
        }
        .memory-content-md li { margin: 3px 0; }
        .memory-content-md strong { color: var(--text-primary); }
        .memory-content-md code {
            background: var(--bg-tertiary); padding: 1px 5px;
            border-radius: 4px; font-size: 12px;
        }
        .memory-golden-rules {
            background: rgba(255, 214, 10, 0.08);
            border: 1px solid rgba(255, 214, 10, 0.2);
            border-radius: 10px; padding: 14px 16px;
            margin-bottom: 12px;
        }
        .memory-golden-rules-title {
            font-size: 12px; font-weight: 700; color: #B89B00;
            margin-bottom: 8px;
        }
        .memory-daily-list { display: flex; flex-direction: column; gap: 6px; }
        .memory-daily-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 12px; background: var(--bg-tertiary);
            border-radius: 8px; font-size: 12px; color: var(--text-secondary);
            cursor: default;
        }
        .memory-daily-item-date { font-weight: 600; color: var(--text-primary); min-width: 80px; }
        .memory-daily-item-size { color: var(--text-tertiary); margin-left: auto; }
        .memory-readonly {
            display: flex; align-items: center; gap: 6px;
            padding: 8px 14px; background: rgba(0,122,255,0.06);
            border-radius: 8px; font-size: 11px; color: var(--exec-blue);
            font-weight: 500; margin-top: 12px;
        }

        /* ═══════════════════════════════════════════════════
           Status Bar Action Buttons
           ═══════════════════════════════════════════════════ */
        .statusbar-action {
            display: flex; align-items: center; gap: 5px;
            padding: 6px 12px; background: transparent;
            border: 0.5px solid var(--border-subtle); border-radius: var(--radius-pill);
            cursor: pointer; font-family: var(--font-family);
            font-size: var(--text-xs); font-weight: 500; color: var(--text-tertiary);
            transition: all var(--duration-fast) var(--ease-apple);
            white-space: nowrap;
        }
        .statusbar-action:hover {
            background: rgba(255,255,255,0.06); border-color: var(--border-medium);
            color: var(--text-secondary);
        }
        .statusbar-action-icon { font-size: 14px; }

        /* ═══════════════════════════════════════════════════
           Mailbox — Priority Flags & Dispatch (Feature 3/8)
           ═══════════════════════════════════════════════════ */
        .mail-flags {
            display: flex; align-items: center; gap: 6px;
            margin-top: 4px;
        }
        .mail-flag {
            font-size: 10px; padding: 1px 6px;
            border-radius: 4px; font-weight: 600;
        }
        .mail-flag--urgent { background: rgba(255,69,58,0.12); color: #FF453A; }
        .mail-flag--normal { background: rgba(255,214,10,0.12); color: #B89B00; }
        .mail-flag--info { background: rgba(48,209,88,0.12); color: #30D158; }
        .mail-dispatch {
            display: flex; align-items: center; gap: 4px;
            font-size: 10px; color: var(--text-tertiary); margin-top: 4px;
        }
        .mail-dispatch-arrow { color: var(--exec-blue); }
        
        /* ═══════════════════════════════════════════════════
           Decommission Animation (NEW #7)
           ═══════════════════════════════════════════════════ */
        @keyframes decommissionFade {
            0% { opacity: 1; transform: scale(1); filter: brightness(1); }
            30% { opacity: 0.8; transform: scale(1.02); filter: brightness(1.3); }
            60% { opacity: 0.4; transform: scale(0.95); filter: brightness(0.7) blur(2px); }
            100% { opacity: 0; transform: scale(0.8); filter: brightness(0) blur(8px); }
        }
        @keyframes decommissionParticles {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 0; transform: translateY(-20px) scale(0); }
        }
        .decommission-anim {
            animation: decommissionFade 800ms var(--ease-smooth) forwards;
            pointer-events: none;
        }
        .decommission-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--exec-blue);
            border-radius: 50%;
            animation: decommissionParticles 800ms ease-out forwards;
        }

        /* ═══════════════════════════════════════════════════
           Toast Notification
           ═══════════════════════════════════════════════════ */
        .exec-toast {
            position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            padding: 12px 24px; background: rgba(44, 44, 46, 0.95);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            color: var(--text-primary); border-radius: var(--radius-pill); font-size: var(--text-sm);
            font-weight: 500; z-index: 999;
            opacity: 0; transition: all var(--duration-normal) var(--ease-apple);
            pointer-events: none;
            box-shadow: var(--shadow-lg);
            border: 0.5px solid var(--border-subtle);
        }
        .exec-toast.show {
            opacity: 1; transform: translateX(-50%) translateY(0);
        }

        /* ═══════════════════════════════════════════════════
           Onboarding — First-Run Walkthrough
           ═══════════════════════════════════════════════════ */
        .onboarding-overlay {
            position: fixed;
            inset: 0;
            z-index: 9000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s var(--ease-smooth);
        }
        .onboarding-overlay.active {
            pointer-events: auto;
            opacity: 1;
        }

        /* Dark scrim behind everything */
        .onboarding-scrim {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.72);
            transition: opacity 0.4s var(--ease-smooth);
        }

        /* Spotlight cutout — positioned dynamically via JS */
        .onboarding-spotlight {
            position: absolute;
            border-radius: 16px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.72);
            transition: all 0.5s var(--ease-smooth);
            z-index: 1;
            pointer-events: none;
        }
        .onboarding-spotlight::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: inherit;
            border: 2px solid rgba(0, 113, 227, 0.4);
            animation: spotlightPulse 2s ease-in-out infinite;
        }
        @keyframes spotlightPulse {
            0%, 100% { border-color: rgba(0, 113, 227, 0.4); box-shadow: 0 0 12px rgba(0,113,227,0.1); }
            50% { border-color: rgba(0, 113, 227, 0.7); box-shadow: 0 0 24px rgba(0,113,227,0.2); }
        }

        /* Card — the text content for each step */
        .onboarding-card {
            position: absolute;
            z-index: 2;
            width: 380px;
            max-width: calc(100vw - 48px);
            padding: 28px 32px 24px;
            background: rgba(28, 28, 30, 0.92);
            backdrop-filter: saturate(180%) blur(24px);
            -webkit-backdrop-filter: saturate(180%) blur(24px);
            border: 0.5px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.4s var(--ease-apple), transform 0.4s var(--ease-apple);
        }
        .onboarding-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Welcome step — centered, larger */
        .onboarding-card--welcome {
            width: 440px;
            text-align: center;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            padding: 40px 44px 36px;
        }
        .onboarding-card--welcome.visible {
            transform: translate(-50%, -50%) scale(1);
        }

        /* Complete step — centered */
        .onboarding-card--complete {
            width: 440px;
            text-align: center;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            padding: 40px 44px 36px;
        }
        .onboarding-card--complete.visible {
            transform: translate(-50%, -50%) scale(1);
        }

        .onboarding-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 20px;
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.2);
        }
        .onboarding-avatar svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .onboarding-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.25;
            letter-spacing: -0.02em;
        }

        .onboarding-text {
            font-size: 15px;
            font-weight: 400;
            color: var(--text-secondary);
            line-height: 1.55;
            margin-bottom: 24px;
        }

        .onboarding-cta {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 28px;
            background: var(--exec-blue);
            color: white;
            border: none;
            border-radius: var(--radius-pill);
            font-family: var(--font-family);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-apple);
            -webkit-tap-highlight-color: transparent;
        }
        .onboarding-cta:hover {
            background: var(--exec-blue-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 113, 227, 0.35);
        }
        .onboarding-cta:active {
            transform: translateY(0);
        }
        .onboarding-cta:focus-visible {
            outline: 2px solid var(--exec-blue);
            outline-offset: 3px;
        }

        /* Step indicators (dots) */
        .onboarding-dots {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9001;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            background: rgba(44, 44, 46, 0.6);
            backdrop-filter: saturate(180%) blur(12px);
            -webkit-backdrop-filter: saturate(180%) blur(12px);
            border-radius: var(--radius-pill);
            border: 0.5px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.4s var(--ease-apple);
        }
        .onboarding-dots.visible {
            opacity: 1;
        }
        .onboarding-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.35);
            transition: all 0.3s var(--ease-smooth);
            cursor: pointer;
        }
        .onboarding-dot.active {
            background: white;
            width: 24px;
            border-radius: 4px;
        }

        /* Skip link */
        .onboarding-skip {
            position: fixed;
            top: 20px;
            right: 24px;
            z-index: 9002;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-family: var(--font-family);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s var(--ease-smooth);
            opacity: 0;
            -webkit-tap-highlight-color: transparent;
        }
        .onboarding-skip.visible {
            opacity: 1;
        }
        .onboarding-skip:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
            color: white;
        }
        .onboarding-skip:focus-visible {
            outline: 2px solid white;
            outline-offset: 2px;
        }

        /* Responsive onboarding */
        @media (max-width: 768px) {
            .onboarding-card {
                width: calc(100vw - 32px);
                max-width: 380px;
                padding: 24px;
            }
            .onboarding-card--welcome,
            .onboarding-card--complete {
                width: calc(100vw - 32px);
                max-width: 400px;
                padding: 32px 28px;
            }
            .onboarding-title { font-size: 19px; }
            .onboarding-text { font-size: 14px; }
            .onboarding-avatar { width: 60px; height: 60px; }
        }

        @media (max-width: 480px) {
            .onboarding-card--welcome,
            .onboarding-card--complete {
                padding: 28px 20px;
            }
            .onboarding-dots { bottom: 20px; }
            .onboarding-skip { top: 12px; right: 12px; }
        }

        /* ═══════════════════════════════════════════════════
           Spawn Agent Card — Dashed Placeholder
           ═══════════════════════════════════════════════════ */
        .exec-room--spawn {
            border: 2px dashed var(--border-medium);
            background: transparent;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s var(--ease-smooth);
            min-height: 120px;
        }
        .exec-room--spawn:hover {
            border-color: var(--exec-blue);
            background: rgba(0, 113, 227, 0.04);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 113, 227, 0.1);
        }
        .exec-room--spawn::before { display: none; }
        .spawn-icon {
            width: 48px; height: 48px;
            border-radius: var(--radius-round);
            background: var(--exec-blue-muted);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: var(--exec-blue);
            transition: all var(--duration-normal) var(--ease-spring);
        }
        .exec-room--spawn:hover .spawn-icon {
            transform: scale(1.1) rotate(90deg);
            background: rgba(0, 113, 227, 0.15);
        }
        .spawn-label {
            font-size: 13px; font-weight: 600;
            color: var(--text-tertiary);
            transition: color 0.3s;
        }
        .exec-room--spawn:hover .spawn-label {
            color: var(--exec-blue);
        }

        /* ═══════════════════════════════════════════════════
           Spawn Agent Panel — 500px Slide-In
           ═══════════════════════════════════════════════════ */
        .spawn-overlay {
            position: fixed; inset: 0; z-index: 200;
            pointer-events: none; opacity: 0;
            transition: opacity 0.3s var(--ease-smooth);
        }
        .spawn-overlay.open {
            pointer-events: auto; opacity: 1;
        }
        .spawn-overlay.open .spawn-backdrop { opacity: 1; }
        .spawn-overlay.open .spawn-panel { transform: translateX(0); }
        .spawn-backdrop {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.5); opacity: 0;
            transition: opacity 0.35s var(--ease-smooth);
        }
        .spawn-panel {
            position: absolute; top: 0; right: 0;
            width: 500px; max-width: 90vw; height: 100%;
            background: var(--bg-secondary);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-left: 0.5px solid var(--border-subtle);
            display: flex; flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s var(--ease-apple);
            box-shadow: var(--shadow-lg);
        }
        .spawn-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 24px; border-bottom: 0.5px solid var(--border-subtle);
            flex-shrink: 0;
        }
        .spawn-title {
            font-size: 17px; font-weight: 700; color: var(--text-primary);
            display: flex; align-items: center; gap: 8px;
        }
        .spawn-close {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border: none; background: rgba(255, 255, 255, 0.08); color: var(--text-secondary);
            border-radius: var(--radius-round); cursor: pointer; font-size: 16px;
            transition: all var(--duration-fast) var(--ease-apple); font-family: inherit;
        }
        .spawn-close:hover { background: rgba(255, 255, 255, 0.14); color: var(--text-primary); }
        .spawn-close:focus-visible { outline: 2px solid var(--exec-blue); outline-offset: 2px; }
        .spawn-body {
            flex: 1; overflow-y: auto; padding: 0;
            scrollbar-width: thin; scrollbar-color: var(--exec-gray-300) transparent;
        }
        .spawn-body::-webkit-scrollbar { width: 4px; }
        .spawn-body::-webkit-scrollbar-thumb { background: var(--exec-gray-300); border-radius: 2px; }

        /* ── Steps Progress ─────────────────────────── */
        .spawn-steps {
            display: flex; align-items: center; justify-content: center;
            gap: 0; padding: 16px 24px;
            border-bottom: 0.5px solid var(--border-subtle);
        }
        .spawn-step-indicator {
            display: flex; align-items: center; gap: 8px;
        }
        .spawn-step-num {
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700;
            background: var(--bg-tertiary); color: var(--text-tertiary);
            border: 2px solid var(--border-subtle);
            transition: all 0.3s var(--ease-smooth);
        }
        .spawn-step-indicator.active .spawn-step-num {
            background: var(--exec-blue); color: white;
            border-color: var(--exec-blue);
        }
        .spawn-step-indicator.done .spawn-step-num {
            background: var(--status-active); color: white;
            border-color: var(--status-active);
        }
        .spawn-step-label {
            font-size: 12px; font-weight: 500; color: var(--text-tertiary);
            transition: color 0.3s;
        }
        .spawn-step-indicator.active .spawn-step-label { color: var(--text-primary); }
        .spawn-step-indicator.done .spawn-step-label { color: var(--status-active); }
        .spawn-step-divider {
            width: 32px; height: 2px;
            background: var(--border-subtle); margin: 0 8px;
            transition: background 0.3s;
        }
        .spawn-step-divider.done { background: var(--status-active); }

        /* ── Step Content ───────────────────────────── */
        .spawn-step-content {
            display: none; padding: 24px;
            animation: spawnStepIn 0.3s var(--ease-smooth);
        }
        .spawn-step-content.active { display: block; }
        @keyframes spawnStepIn {
            from { opacity: 0; transform: translateX(12px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ── Character Grid ─────────────────────────── */
        .spawn-section-title {
            font-size: 13px; font-weight: 600; color: var(--text-secondary);
            margin-bottom: 16px;
        }
        .spawn-char-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        .spawn-char-option {
            display: flex; flex-direction: column;
            align-items: center; gap: 6px;
            padding: 12px 8px; border-radius: var(--radius-md);
            border: 1.5px solid var(--border-subtle);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-apple);
        }
        .spawn-char-option:hover {
            border-color: var(--border-medium);
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .spawn-char-option.selected {
            border-color: var(--exec-blue);
            background: rgba(0, 113, 227, 0.08);
            box-shadow: 0 0 0 3px var(--exec-blue-muted);
        }
        .spawn-char-option:focus-visible {
            outline: 2px solid var(--exec-blue); outline-offset: 2px;
        }
        .spawn-char-avatar {
            width: 48px; height: 48px; border-radius: 50%;
            overflow: hidden;
        }
        .spawn-char-avatar svg { width: 100%; height: 100%; display: block; }
        .spawn-char-name {
            font-size: 10px; font-weight: 500; color: var(--text-tertiary);
            text-align: center;
        }

        /* ── Form Fields ────────────────────────────── */
        .spawn-field {
            margin-bottom: 16px;
        }
        .spawn-field label {
            display: block; font-size: 12px; font-weight: 600;
            color: var(--text-secondary); margin-bottom: 6px;
        }
        .spawn-field input,
        .spawn-field textarea {
            width: 100%; padding: 10px 16px;
            border-radius: var(--radius-md); border: 1px solid var(--border-medium);
            background: var(--bg-tertiary); color: var(--text-primary);
            font-family: var(--font-family); font-size: var(--text-sm);
            outline: none; transition: border-color var(--duration-fast), box-shadow var(--duration-fast);
            resize: vertical;
        }
        .spawn-field input:focus,
        .spawn-field textarea:focus {
            border-color: var(--exec-blue);
            box-shadow: 0 0 0 3px var(--exec-blue-muted);
        }
        .spawn-field input::placeholder,
        .spawn-field textarea::placeholder { color: var(--text-tertiary); }
        .spawn-field textarea { min-height: 80px; }

        /* ── Traits Tags ────────────────────────────── */
        .spawn-traits-container {
            display: flex; flex-wrap: wrap; gap: 6px;
            padding: 8px 10px; min-height: 40px;
            border-radius: 10px; border: 1px solid var(--border-medium);
            background: var(--bg-tertiary);
            cursor: text; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .spawn-traits-container:focus-within {
            border-color: var(--exec-blue);
            box-shadow: 0 0 0 3px var(--exec-blue-muted);
        }
        .spawn-trait-tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 3px 10px; background: var(--exec-blue-muted);
            border-radius: 12px; font-size: 12px; font-weight: 500;
            color: var(--exec-blue);
        }
        .spawn-trait-tag button {
            background: none; border: none; cursor: pointer;
            color: var(--exec-blue); font-size: 14px; padding: 0;
            line-height: 1; opacity: 0.6;
        }
        .spawn-trait-tag button:hover { opacity: 1; }
        .spawn-traits-input {
            border: none; background: transparent; outline: none;
            font-family: var(--font-family); font-size: 12px;
            color: var(--text-primary); flex: 1; min-width: 80px;
            padding: 2px 0;
        }
        .spawn-traits-input::placeholder { color: var(--text-tertiary); }

        /* ── Skills Multi-Select ────────────────────── */
        .spawn-skills-grid {
            display: flex; flex-wrap: wrap; gap: 8px;
        }
        .spawn-skill-option {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 6px 14px; border-radius: var(--radius-pill);
            border: 1px solid var(--border-medium);
            background: var(--bg-tertiary);
            font-size: var(--text-xs); font-weight: 500; color: var(--text-secondary);
            cursor: pointer; transition: all var(--duration-fast) var(--ease-apple);
            user-select: none;
        }
        .spawn-skill-option:hover {
            border-color: var(--exec-blue);
            color: var(--exec-blue);
        }
        .spawn-skill-option.selected {
            border-color: var(--exec-blue);
            background: var(--exec-blue-muted);
            color: var(--exec-blue);
        }
        .spawn-skill-option:focus-visible {
            outline: 2px solid var(--exec-blue); outline-offset: 2px;
        }

        /* ── Navigation Buttons ─────────────────────── */
        .spawn-nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 24px; border-top: 0.5px solid var(--border-subtle);
            flex-shrink: 0;
        }
        .spawn-btn {
            padding: 12px 24px; border-radius: var(--radius-pill);
            font-family: var(--font-family); font-size: 0.9375rem; font-weight: 600;
            cursor: pointer; transition: all var(--duration-fast) var(--ease-apple);
            border: none;
        }
        .spawn-btn--secondary {
            background: transparent; color: var(--text-secondary);
            border: 1.5px solid var(--border-medium);
        }
        .spawn-btn--secondary:hover {
            background: rgba(255, 255, 255, 0.06); color: var(--text-primary);
        }
        .spawn-btn--primary {
            background: var(--exec-blue); color: white;
        }
        .spawn-btn--primary:hover {
            background: var(--exec-blue-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 113, 227, 0.35);
        }
        .spawn-btn--primary:active { transform: translateY(0); }
        .spawn-btn--deploy {
            background: #30d158;
            color: white; padding: 12px 32px; font-size: 15px;
        }
        .spawn-btn--deploy:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(48, 209, 88, 0.3);
        }
        .spawn-btn:disabled {
            opacity: 0.5; cursor: not-allowed;
            transform: none !important; box-shadow: none !important;
        }
        .spawn-btn:focus-visible {
            outline: 2px solid var(--exec-blue); outline-offset: 2px;
        }

        /* ── Review Summary ─────────────────────────── */
        .spawn-review {
            display: flex; flex-direction: column; gap: 16px;
        }
        .spawn-review-card {
            padding: 16px 20px; background: var(--bg-tertiary);
            border-radius: var(--radius-lg); border: 0.5px solid var(--border-subtle);
        }
        .spawn-review-header {
            display: flex; align-items: center; gap: 16px;
            margin-bottom: 14px;
        }
        .spawn-review-avatar {
            width: 56px; height: 56px; border-radius: 50%;
            overflow: hidden; flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .spawn-review-avatar svg { width: 100%; height: 100%; display: block; }
        .spawn-review-name {
            font-size: 18px; font-weight: 700; color: var(--text-primary);
        }
        .spawn-review-role {
            font-size: 13px; color: var(--text-tertiary);
        }
        .spawn-review-row {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 6px 0; font-size: 13px;
        }
        .spawn-review-label {
            font-weight: 600; color: var(--text-secondary); flex-shrink: 0;
        }
        .spawn-review-value {
            color: var(--text-primary); text-align: right;
            max-width: 65%; word-break: break-word;
        }
        .spawn-review-traits {
            display: flex; flex-wrap: wrap; gap: 4px; justify-content: flex-end;
        }
        .spawn-review-trait {
            padding: 2px 8px; background: var(--exec-blue-muted);
            border-radius: 10px; font-size: 11px; font-weight: 500;
            color: var(--exec-blue);
        }

        /* ── Deploy Animation ───────────────────────── */
        @keyframes deployPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(48, 209, 88, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 12px rgba(48, 209, 88, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(48, 209, 88, 0); }
        }
        @keyframes deploySlideIn {
            0% { opacity: 0; transform: scale(0.85) translateY(20px); }
            60% { opacity: 1; transform: scale(1.05) translateY(-4px); }
            100% { transform: scale(1) translateY(0); }
        }
        .deploy-anim {
            animation: deploySlideIn 0.6s var(--ease-spring);
        }
        .deploy-pulse {
            animation: deployPulse 0.8s ease-out;
        }

        /* ── Custom Agent Room (spawned agents) ─────── */
        .exec-room--custom {
            position: relative;
        }
        .exec-room--custom .custom-decommission {
            position: absolute; top: 8px; right: 8px;
            width: 24px; height: 24px; border-radius: 6px;
            border: none; background: rgba(255, 69, 58, 0.1);
            color: var(--status-error); cursor: pointer;
            font-size: 12px; display: flex; align-items: center;
            justify-content: center; opacity: 0;
            transition: all 0.2s var(--ease-smooth);
        }
        .exec-room--custom:hover .custom-decommission { opacity: 1; }
        .exec-room--custom .custom-decommission:hover {
            background: rgba(255, 69, 58, 0.2);
        }

        /* ── Grid auto-rows for dynamic agents ──────── */
        .exec-floor--expanded {
            grid-template-rows: 1fr repeat(auto-fill, 1fr) 0.8fr;
        }

        /* ═══════════════════════════════════════════════════
           Reduced Motion
           ═══════════════════════════════════════════════════ */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>

    <!-- ═══ Ambient Background ═══ -->
    <div class="exec-backdrop" aria-hidden="true"></div>
    <div class="exec-particles" aria-hidden="true">
        <div class="exec-particle"></div>
        <div class="exec-particle"></div>
        <div class="exec-particle"></div>
    </div>

    <!-- ═══ SVG Avatar Definitions (hidden, referenced by use) ═══ -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
        <defs>
            <!-- ── ApoMac: Tech CEO with glasses ── -->
            <symbol id="avatar-ceo" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#007AFF"/>
                <circle cx="24" cy="20" r="10" fill="#F5D6B8"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#1C1C1E"/>
                <!-- Hair -->
                <path d="M14 17c0-6 4.5-11 10-11s10 5 10 11c0 1-.2 2-.5 2.8-.8-4-4.5-7-9.5-7s-8.7 3-9.5 7c-.3-.8-.5-1.8-.5-2.8z" fill="#3A3A3C"/>
                <!-- Glasses -->
                <rect x="15.5" y="17.5" width="7" height="5.5" rx="2.5" fill="none" stroke="#1C1C1E" stroke-width="1.5"/>
                <rect x="25.5" y="17.5" width="7" height="5.5" rx="2.5" fill="none" stroke="#1C1C1E" stroke-width="1.5"/>
                <line x1="22.5" y1="20" x2="25.5" y2="20" stroke="#1C1C1E" stroke-width="1.2"/>
                <!-- Eyes behind glasses -->
                <circle cx="19" cy="20.2" r="1.2" fill="#1C1C1E"/>
                <circle cx="29" cy="20.2" r="1.2" fill="#1C1C1E"/>
                <!-- Smile -->
                <path d="M20 24.5c0 0 2 2.5 4 2.5s4-2.5 4-2.5" fill="none" stroke="#C4856A" stroke-width="1" stroke-linecap="round"/>
            </symbol>

            <!-- ── Atlas: Professional / Organized (neat hair, tie) ── -->
            <symbol id="avatar-atlas" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#BF5AF2"/>
                <circle cx="24" cy="20" r="10" fill="#E8C9A0"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#4A3668"/>
                <!-- Tie -->
                <polygon points="24,29 22,34 24,36 26,34" fill="#9B59B6"/>
                <!-- Neat side-parted hair -->
                <path d="M14 17c0-6 4.5-11 10-11s10 5 10 11v1c0-5-3.5-9-7-9-2 0-3.5.8-4.5 2C21 9.5 19 10 17 12c-1.5 1.5-2.5 3-3 5z" fill="#2C1810"/>
                <!-- Eyes -->
                <ellipse cx="19.5" cy="19.5" rx="1.3" ry="1.5" fill="#1C1C1E"/>
                <ellipse cx="28.5" cy="19.5" rx="1.3" ry="1.5" fill="#1C1C1E"/>
                <!-- Subtle smile -->
                <path d="M21 24c0 0 1.5 2 3 2s3-2 3-2" fill="none" stroke="#B5896E" stroke-width="1" stroke-linecap="round"/>
            </symbol>

            <!-- ── Forge: Engineer with hard hat ── -->
            <symbol id="avatar-forge" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#FF9F0A"/>
                <circle cx="24" cy="21" r="10" fill="#D4A87A"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#5C3D1E"/>
                <!-- Hard hat -->
                <path d="M12 17h24v2c0 1-1 2-2 2H14c-1 0-2-1-2-2v-2z" fill="#FFD60A"/>
                <path d="M14 17c0-5 4.5-9 10-9s10 4 10 9H14z" fill="#FFD60A"/>
                <rect x="12" y="16.5" width="24" height="2" rx="1" fill="#E8B800"/>
                <!-- Hat stripe -->
                <rect x="14" y="12" width="20" height="1.5" rx="0.75" fill="#E8B800"/>
                <!-- Eyes — determined -->
                <rect x="18" y="19" width="3" height="2" rx="1" fill="#1C1C1E"/>
                <rect x="27" y="19" width="3" height="2" rx="1" fill="#1C1C1E"/>
                <!-- Confident grin -->
                <path d="M20 25c0 0 2 2 4 2s4-2 4-2" fill="none" stroke="#A07050" stroke-width="1.2" stroke-linecap="round"/>
            </symbol>

            <!-- ── Hunter: Sharp / Aggressive (angular features, sharp eyes) ── -->
            <symbol id="avatar-hunter" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#FF453A"/>
                <circle cx="24" cy="20" r="10" fill="#E8C9A0"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#1C1C1E"/>
                <!-- Spiky/angular hair -->
                <path d="M14 16l3-8 4 5 3-6 3 4 4-5 3 7 2-3v6c0-6-4-11-10-11S14 10 14 16z" fill="#8B0000"/>
                <!-- Sharp eyes — angled brows -->
                <line x1="16" y1="17" x2="21" y2="18.5" stroke="#1C1C1E" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="32" y1="17" x2="27" y2="18.5" stroke="#1C1C1E" stroke-width="1.5" stroke-linecap="round"/>
                <circle cx="19" cy="20" r="1.4" fill="#1C1C1E"/>
                <circle cx="29" cy="20" r="1.4" fill="#1C1C1E"/>
                <!-- Smirk -->
                <path d="M21 24.5c0 0 1 1.5 3 1.5 3 0 4-2.5 4-2.5" fill="none" stroke="#B5896E" stroke-width="1" stroke-linecap="round"/>
            </symbol>

            <!-- ── Echo: Creative / Artistic (colorful, beret/headband) ── -->
            <symbol id="avatar-echo" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#0A84FF"/>
                <circle cx="24" cy="21" r="10" fill="#F0D5B8"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#2A6CB5"/>
                <!-- Wavy/creative hair -->
                <path d="M14 18c0-6 4.5-11 10-11s10 5 10 11c-1-3-4-6-7-6-1.5 0-3 .5-4 1.5C22 12 20 11 17.5 12 15.5 13 14.5 15 14 18z" fill="#5B3A8C"/>
                <!-- Beret/headband -->
                <path d="M13 15c2-3 6-5 11-5s9 2 11 5" fill="none" stroke="#FF6B9D" stroke-width="2.5" stroke-linecap="round"/>
                <circle cx="32" cy="13" r="2" fill="#FF6B9D"/>
                <!-- Expressive eyes -->
                <ellipse cx="19.5" cy="20" rx="1.5" ry="1.8" fill="#1C1C1E"/>
                <ellipse cx="28.5" cy="20" rx="1.5" ry="1.8" fill="#1C1C1E"/>
                <!-- Eye sparkles -->
                <circle cx="20.2" cy="19.2" r="0.6" fill="white"/>
                <circle cx="29.2" cy="19.2" r="0.6" fill="white"/>
                <!-- Happy smile -->
                <path d="M20 25c0 0 2 3 4 3s4-3 4-3" fill="none" stroke="#C4856A" stroke-width="1" stroke-linecap="round"/>
            </symbol>

            <!-- ── Sentinel: Vigilant Guard (helmet visor, alert eyes) ── -->
            <symbol id="avatar-sentinel" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#30D158"/>
                <circle cx="24" cy="21" r="10" fill="#D4B896"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#1B3A1B"/>
                <!-- Guard helmet / visor -->
                <path d="M13 18c0-7 5-12 11-12s11 5 11 12H13z" fill="#2D5A2D"/>
                <path d="M13 18h22v2c0 1-1 1.5-2 1.5H15c-1 0-2-.5-2-1.5v-2z" fill="#1B3A1B"/>
                <!-- Visor slit with glowing eyes -->
                <rect x="15" y="18" width="18" height="3.5" rx="1.5" fill="#0A1A0A" opacity="0.8"/>
                <!-- Alert scanning eyes -->
                <circle cx="20" cy="19.8" r="1.5" fill="#30D158"/>
                <circle cx="20" cy="19.8" r="0.7" fill="#FFFFFF"/>
                <circle cx="28" cy="19.8" r="1.5" fill="#30D158"/>
                <circle cx="28" cy="19.8" r="0.7" fill="#FFFFFF"/>
                <!-- Stoic line mouth -->
                <line x1="21" y1="26" x2="27" y2="26" stroke="#A07050" stroke-width="1.2" stroke-linecap="round"/>
            </symbol>
            <!-- ── Spark: Data Analyst (blue tones, charts vibe) ── -->
            <symbol id="avatar-spark" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#5856D6"/>
                <circle cx="24" cy="20" r="10" fill="#F0D5B8"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#3A2D6B"/>
                <!-- Short neat hair -->
                <path d="M14 17c0-6 4.5-11 10-11s10 5 10 11c0 .5-.1 1-.2 1.5C33 14 29 11 24 11s-9 3-9.8 7.5c-.1-.5-.2-1-.2-1.5z" fill="#1C1C1E"/>
                <!-- Round glasses -->
                <circle cx="19" cy="19.5" r="3.5" fill="none" stroke="#5856D6" stroke-width="1.2"/>
                <circle cx="29" cy="19.5" r="3.5" fill="none" stroke="#5856D6" stroke-width="1.2"/>
                <line x1="22.5" y1="19.5" x2="25.5" y2="19.5" stroke="#5856D6" stroke-width="1"/>
                <!-- Eyes -->
                <circle cx="19" cy="19.8" r="1.1" fill="#1C1C1E"/>
                <circle cx="29" cy="19.8" r="1.1" fill="#1C1C1E"/>
                <!-- Thinking smile -->
                <path d="M21 24.5c0 0 1.5 1.5 3 1.5s3-1.5 3-1.5" fill="none" stroke="#C4856A" stroke-width="1" stroke-linecap="round"/>
            </symbol>

            <!-- ── Nova: Content Writer (warm tones, creative) ── -->
            <symbol id="avatar-nova" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#FF6B9D"/>
                <circle cx="24" cy="20" r="10" fill="#F5D6B8"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#8B3A5E"/>
                <!-- Long flowing hair -->
                <path d="M13 19c0-7 5-13 11-13s11 6 11 13c0 2-.5 3.5-1.2 5-1-5-4.5-8.5-9.8-8.5S14.5 17 13.5 22c-.3-1-.5-2-.5-3z" fill="#D4488C"/>
                <path d="M13 19c0 3 1 6 2 8-1 4-1 8-1 8l3-3c1 2 3.5 3.5 7 3.5s6-1.5 7-3.5l3 3s0-4-1-8c1-2 2-5 2-8" fill="none" stroke="#D4488C" stroke-width="2" stroke-linecap="round" opacity="0.4"/>
                <!-- Bright eyes with lashes -->
                <ellipse cx="19.5" cy="19.5" rx="1.4" ry="1.6" fill="#1C1C1E"/>
                <ellipse cx="28.5" cy="19.5" rx="1.4" ry="1.6" fill="#1C1C1E"/>
                <circle cx="20.2" cy="18.8" r="0.5" fill="white"/>
                <circle cx="29.2" cy="18.8" r="0.5" fill="white"/>
                <!-- Warm smile -->
                <path d="M20 24c0 0 2 3 4 3s4-3 4-3" fill="none" stroke="#C4856A" stroke-width="1.2" stroke-linecap="round"/>
            </symbol>

            <!-- ── Bolt: DevOps Engineer (yellow/electric) ── -->
            <symbol id="avatar-bolt" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#FFD60A"/>
                <circle cx="24" cy="20" r="10" fill="#D4A87A"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#5C4A1E"/>
                <!-- Mohawk-style hair -->
                <path d="M20 7c2-2 4-2 6-1 2 1 3 3 3 5v4c-2-3-5-5-8-5-2 0-4 1-5 3V10c0-1 2-2 4-3z" fill="#E8B800"/>
                <rect x="21" y="4" width="6" height="8" rx="2" fill="#E8B800"/>
                <!-- Determined eyes -->
                <rect x="17" y="19" width="4" height="2.5" rx="1.2" fill="#1C1C1E"/>
                <rect x="27" y="19" width="4" height="2.5" rx="1.2" fill="#1C1C1E"/>
                <!-- Lightning bolt earring -->
                <path d="M35 18l-2 3h2l-2 3" fill="none" stroke="#FFD60A" stroke-width="1.2" stroke-linecap="round"/>
                <!-- Smirk -->
                <path d="M20 25c0 0 2 1.5 4 1.5s4-1.5 4-1.5" fill="none" stroke="#A07050" stroke-width="1" stroke-linecap="round"/>
            </symbol>

            <!-- ── Pixel: Designer (teal/mint) ── -->
            <symbol id="avatar-pixel" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#64D2FF"/>
                <circle cx="24" cy="20" r="10" fill="#F0D5B8"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#1A5C6B"/>
                <!-- Messy creative hair with streak -->
                <path d="M14 16c0-6 4.5-11 10-11s10 5 10 11c0 1-.2 2-.4 2.8-1-4-4.5-7-9.6-7s-8.6 3-9.6 7c-.2-.8-.4-1.8-.4-2.8z" fill="#2D7A8C"/>
                <path d="M18 7c1-1 3 0 4 1 1 1 0 3-1 3" fill="#64D2FF" opacity="0.8"/>
                <!-- Big creative eyes -->
                <ellipse cx="19" cy="19.5" rx="1.6" ry="1.8" fill="#1C1C1E"/>
                <ellipse cx="29" cy="19.5" rx="1.6" ry="1.8" fill="#1C1C1E"/>
                <circle cx="19.7" cy="18.8" r="0.6" fill="white"/>
                <circle cx="29.7" cy="18.8" r="0.6" fill="white"/>
                <!-- Pencil behind ear -->
                <line x1="35" y1="12" x2="33" y2="18" stroke="#FFD60A" stroke-width="1.5" stroke-linecap="round"/>
                <circle cx="35" cy="12" r="1" fill="#FF453A"/>
                <!-- Enthusiastic grin -->
                <path d="M19 24c0 0 2.5 3.5 5 3.5s5-3.5 5-3.5" fill="none" stroke="#C4856A" stroke-width="1" stroke-linecap="round"/>
            </symbol>

            <!-- ── Cipher: Security Expert (dark/green) ── -->
            <symbol id="avatar-cipher" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#1C3A1C"/>
                <circle cx="24" cy="20" r="10" fill="#D4B896"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#0A1A0A"/>
                <!-- Hood/tactical look -->
                <path d="M12 20c0-8 5.5-14 12-14s12 6 12 14c0 1-.2 2-.5 3-1.5-6-5.5-10-11.5-10S14 14 12.5 20c-.3-1-.5-2-.5-3z" fill="#1C1C1E"/>
                <path d="M12 20c0 2 .5 3.5 1.5 5l-1 2h23l-1-2c1-1.5 1.5-3 1.5-5" fill="#1C1C1E" opacity="0.6"/>
                <!-- Glowing eyes -->
                <circle cx="19" cy="20" r="1.5" fill="#30D158"/>
                <circle cx="19" cy="20" r="0.6" fill="#FFFFFF"/>
                <circle cx="29" cy="20" r="1.5" fill="#30D158"/>
                <circle cx="29" cy="20" r="0.6" fill="#FFFFFF"/>
                <!-- Stoic mouth -->
                <line x1="21" y1="25.5" x2="27" y2="25.5" stroke="#A07050" stroke-width="1" stroke-linecap="round"/>
            </symbol>

            <!-- ── Flux: Researcher (warm purple) ── -->
            <symbol id="avatar-flux" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="24" fill="#AF52DE"/>
                <circle cx="24" cy="21" r="10" fill="#E8C9A0"/>
                <path d="M14 42c0-8 4.5-14 10-14s10 6 10 14" fill="#5A2D7A"/>
                <!-- Curly professorial hair -->
                <path d="M13 17c0-7 5-12 11-12s11 5 11 12" fill="#4A2D6B"/>
                <circle cx="15" cy="14" r="2.5" fill="#4A2D6B"/>
                <circle cx="19" cy="11" r="3" fill="#4A2D6B"/>
                <circle cx="24" cy="9" r="3" fill="#4A2D6B"/>
                <circle cx="29" cy="11" r="3" fill="#4A2D6B"/>
                <circle cx="33" cy="14" r="2.5" fill="#4A2D6B"/>
                <!-- Reading glasses -->
                <rect x="16" y="18.5" width="6" height="4.5" rx="2" fill="none" stroke="#AF52DE" stroke-width="1"/>
                <rect x="26" y="18.5" width="6" height="4.5" rx="2" fill="none" stroke="#AF52DE" stroke-width="1"/>
                <line x1="22" y1="20.5" x2="26" y2="20.5" stroke="#AF52DE" stroke-width="0.8"/>
                <!-- Thoughtful eyes -->
                <circle cx="19" cy="20.5" r="1" fill="#1C1C1E"/>
                <circle cx="29" cy="20.5" r="1" fill="#1C1C1E"/>
                <!-- Beard -->
                <path d="M18 26c0 3 3 5 6 5s6-2 6-5" fill="#3A2040" opacity="0.5"/>
                <!-- Wise smile -->
                <path d="M21 25c0 0 1.5 1.5 3 1.5s3-1.5 3-1.5" fill="none" stroke="#B5896E" stroke-width="1" stroke-linecap="round"/>
            </symbol>
        </defs>
    </svg>

    <!-- ═══ Main Container ═══ -->
    <div class="exec-container">

        <!-- ═══ View Toggle ═══ -->
        <div class="exec-view-toggle">
            <div class="view-toggle-group" role="tablist" aria-label="View mode">
                <button class="view-toggle-btn active" role="tab" aria-selected="true" aria-controls="gridView" id="tabGrid" data-view="grid">
                    <span class="view-toggle-icon" aria-hidden="true">⊞</span>
                    <span>Office Grid</span>
                </button>
                <button class="view-toggle-btn" role="tab" aria-selected="false" aria-controls="hierarchyView" id="tabHierarchy" data-view="hierarchy">
                    <span class="view-toggle-icon" aria-hidden="true">⋮⋮</span>
                    <span>Org Chart</span>
                </button>
            </div>
        </div>

        <!-- ═══ Office Floor Grid (Grid View) ═══ -->
        <div class="exec-floor" id="gridView" role="tabpanel" aria-labelledby="tabGrid">

            <!-- ── CEO Room ────────────────────────────── -->
            <div class="exec-room exec-room--ceo" role="button" tabindex="0" aria-label="CEO Office — ApoMac" data-agent="ceo">
                <span class="exec-room-label">CEO Office</span>
                <div class="ceo-content">
                    <div class="agent-avatar agent-avatar--lg" aria-hidden="true">
                        <svg><use href="#avatar-ceo"/></svg>
                        <span class="agent-status-dot agent-status-dot--active" aria-label="Active"></span>
                    </div>
                    <div class="ceo-info">
                        <span class="agent-name">ApoMac</span>
                        <span class="agent-role">Chief Executive Officer</span>
                    </div>
                </div>
                <button class="ceo-mailbox" aria-label="Open mailbox — 3 unread messages" id="mailboxBtn">
                    <span class="ceo-mailbox-icon" aria-hidden="true">📬</span>
                    <span>Inbox</span>
                    <span class="ceo-mailbox-badge" id="mailboxBadge">3</span>
                </button>

                <!-- CEO Detail (hidden by default) -->
                <div class="agent-detail" id="detail-ceo">
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Status</span>
                        <span class="agent-detail-value">🟢 Active</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Current Task</span>
                        <span class="agent-detail-value">Reviewing team roadmap</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Tasks Today</span>
                        <span class="agent-detail-value">12</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Uptime</span>
                        <span class="agent-detail-value">4h 23m</span>
                    </div>
                </div>
            </div>

            <!-- ── Atlas Room ──────────────────────────── -->
            <div class="exec-room exec-room--atlas" role="button" tabindex="0" aria-label="Atlas — COO" data-agent="atlas">
                <span class="exec-room-label">Atlas</span>
                <div class="agent-avatar" aria-hidden="true">
                    <svg><use href="#avatar-atlas"/></svg>
                    <span class="agent-status-dot agent-status-dot--active" aria-label="Active"></span>
                </div>
                <span class="agent-name">Atlas</span>
                <span class="agent-role">COO</span>
                <div class="agent-detail" id="detail-atlas">
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Status</span>
                        <span class="agent-detail-value">🟢 Active</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Current Task</span>
                        <span class="agent-detail-value">Coordinating workflows</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Tasks Today</span>
                        <span class="agent-detail-value">8</span>
                    </div>
                </div>
            </div>

            <!-- ── Forge Room ──────────────────────────── -->
            <div class="exec-room exec-room--forge" role="button" tabindex="0" aria-label="Forge — CTO" data-agent="forge">
                <span class="exec-room-label">Forge</span>
                <div class="agent-avatar" aria-hidden="true">
                    <svg><use href="#avatar-forge"/></svg>
                    <span class="agent-status-dot agent-status-dot--busy" aria-label="Busy"></span>
                </div>
                <span class="agent-name">Forge</span>
                <span class="agent-role">CTO</span>
                <div class="agent-detail" id="detail-forge">
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Status</span>
                        <span class="agent-detail-value">🟡 Building</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Current Task</span>
                        <span class="agent-detail-value">Executive theme build</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Tasks Today</span>
                        <span class="agent-detail-value">5</span>
                    </div>
                </div>
            </div>

            <!-- ── Hunter Room ─────────────────────────── -->
            <div class="exec-room exec-room--hunter" role="button" tabindex="0" aria-label="Hunter — CRO" data-agent="hunter">
                <span class="exec-room-label">Hunter</span>
                <div class="agent-avatar" aria-hidden="true">
                    <svg><use href="#avatar-hunter"/></svg>
                    <span class="agent-status-dot agent-status-dot--active" aria-label="Active"></span>
                </div>
                <span class="agent-name">Hunter</span>
                <span class="agent-role">CRO</span>
                <div class="agent-detail" id="detail-hunter">
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Status</span>
                        <span class="agent-detail-value">🟢 Active</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Current Task</span>
                        <span class="agent-detail-value">Prospecting leads</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Tasks Today</span>
                        <span class="agent-detail-value">14</span>
                    </div>
                </div>
            </div>

            <!-- ── Echo Room ───────────────────────────── -->
            <div class="exec-room exec-room--echo" role="button" tabindex="0" aria-label="Echo — CMO" data-agent="echo">
                <span class="exec-room-label">Echo</span>
                <div class="agent-avatar" aria-hidden="true">
                    <svg><use href="#avatar-echo"/></svg>
                    <span class="agent-status-dot agent-status-dot--idle" aria-label="Idle"></span>
                </div>
                <span class="agent-name">Echo</span>
                <span class="agent-role">CMO</span>
                <div class="agent-detail" id="detail-echo">
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Status</span>
                        <span class="agent-detail-value">⚪ Idle</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Current Task</span>
                        <span class="agent-detail-value">Awaiting assignments</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Tasks Today</span>
                        <span class="agent-detail-value">3</span>
                    </div>
                </div>
            </div>

            <!-- ── Meeting Room / Boardroom ────────────── -->
            <div class="exec-room exec-room--meeting" role="button" tabindex="0" aria-label="Active Boardroom — Click to view meetings" data-room="meeting">
                <span class="exec-room-label">Boardroom</span>
                <div class="meeting-status">
                    <span class="meeting-icon" aria-hidden="true">🏛️</span>
                    <span class="meeting-label">Active Meetings</span>
                    <span class="meeting-count" id="meetingCount">2</span>
                </div>
                <div class="meeting-preview" id="meetingPreview">
                    <div class="meeting-active" style="color:var(--text-tertiary);font-size:11px;">Loading...</div>
                </div>
            </div>

            <!-- ── Sentinel Room ───────────────────────── -->
            <div class="exec-room exec-room--sentinel" role="button" tabindex="0" aria-label="Sentinel — QA & Security" data-agent="sentinel">
                <span class="exec-room-label">Sentinel</span>
                <div class="agent-avatar" aria-hidden="true">
                    <svg><use href="#avatar-sentinel"/></svg>
                    <span class="agent-status-dot agent-status-dot--active" aria-label="Active"></span>
                </div>
                <span class="agent-name">Sentinel</span>
                <span class="agent-role">QA & Security</span>
                <div class="agent-detail" id="detail-sentinel">
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Status</span>
                        <span class="agent-detail-value">🟢 Active</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Current Task</span>
                        <span class="agent-detail-value">Monitoring systems</span>
                    </div>
                    <div class="agent-detail-row">
                        <span class="agent-detail-label">Tasks Today</span>
                        <span class="agent-detail-value">7</span>
                    </div>
                </div>
            </div>

            <!-- ── Spawn Agent Card ──────────────────── -->
            <div class="exec-room exec-room--spawn" role="button" tabindex="0" aria-label="Spawn a new agent" id="spawnAgentCard">
                <div class="spawn-icon" aria-hidden="true">+</div>
                <span class="spawn-label">Spawn Agent</span>
            </div>

        </div>
        <!-- /exec-floor -->

        <!-- ═══ Hierarchy / Org Chart View ═══ -->
        <div class="exec-hierarchy" id="hierarchyView" role="tabpanel" aria-labelledby="tabHierarchy">
            <div class="org-tree">
                <!-- CEO at top -->
                <div class="org-node">
                    <div class="org-card org-card--ceo" data-agent="ceo" tabindex="0" role="button" aria-label="ApoMac — CEO">
                        <div class="agent-avatar agent-avatar--lg" aria-hidden="true">
                            <svg><use href="#avatar-ceo"/></svg>
                            <span class="agent-status-dot agent-status-dot--active"></span>
                        </div>
                        <div class="org-card-info">
                            <span class="agent-name">ApoMac</span>
                            <span class="agent-role">Chief Executive Officer</span>
                        </div>
                    </div>
                </div>

                <!-- Connector down -->
                <div class="org-connector"></div>

                <!-- C-Level children -->
                <div class="org-children" style="--bar-half-width: 340px;">
                    <!-- Atlas -->
                    <div class="org-child">
                        <div class="org-connector--branch"></div>
                        <div class="org-card" data-agent="atlas" tabindex="0" role="button" aria-label="Atlas — COO">
                            <div class="agent-avatar" aria-hidden="true">
                                <svg><use href="#avatar-atlas"/></svg>
                                <span class="agent-status-dot agent-status-dot--active"></span>
                            </div>
                            <div class="org-card-info">
                                <span class="agent-name">Atlas</span>
                                <span class="agent-role">COO</span>
                            </div>
                        </div>
                    </div>

                    <!-- Forge -->
                    <div class="org-child">
                        <div class="org-connector--branch"></div>
                        <div class="org-card" data-agent="forge" tabindex="0" role="button" aria-label="Forge — CTO">
                            <div class="agent-avatar" aria-hidden="true">
                                <svg><use href="#avatar-forge"/></svg>
                                <span class="agent-status-dot agent-status-dot--busy"></span>
                            </div>
                            <div class="org-card-info">
                                <span class="agent-name">Forge</span>
                                <span class="agent-role">CTO</span>
                            </div>
                        </div>
                    </div>

                    <!-- Echo -->
                    <div class="org-child">
                        <div class="org-connector--branch"></div>
                        <div class="org-card" data-agent="echo" tabindex="0" role="button" aria-label="Echo — CMO">
                            <div class="agent-avatar" aria-hidden="true">
                                <svg><use href="#avatar-echo"/></svg>
                                <span class="agent-status-dot agent-status-dot--idle"></span>
                            </div>
                            <div class="org-card-info">
                                <span class="agent-name">Echo</span>
                                <span class="agent-role">CMO</span>
                            </div>
                        </div>
                    </div>

                    <!-- Hunter -->
                    <div class="org-child">
                        <div class="org-connector--branch"></div>
                        <div class="org-card" data-agent="hunter" tabindex="0" role="button" aria-label="Hunter — CRO">
                            <div class="agent-avatar" aria-hidden="true">
                                <svg><use href="#avatar-hunter"/></svg>
                                <span class="agent-status-dot agent-status-dot--active"></span>
                            </div>
                            <div class="org-card-info">
                                <span class="agent-name">Hunter</span>
                                <span class="agent-role">CRO</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sentinel -->
                    <div class="org-child">
                        <div class="org-connector--branch"></div>
                        <div class="org-card" data-agent="sentinel" tabindex="0" role="button" aria-label="Sentinel — QA & Security">
                            <div class="agent-avatar" aria-hidden="true">
                                <svg><use href="#avatar-sentinel"/></svg>
                                <span class="agent-status-dot agent-status-dot--active"></span>
                            </div>
                            <div class="org-card-info">
                                <span class="agent-name">Sentinel</span>
                                <span class="agent-role">QA & Security</span>
                            </div>
                        </div>
                        
                        <!-- Sub-agents under Sentinel -->
                        <div class="org-sub-level">
                            <div class="org-connector"></div>
                            <div class="org-sub-children">
                                <div class="org-sub-card">
                                    <div class="sub-agent-name">CodeGuard</div>
                                    <div class="sub-agent-role">Security Scanner</div>
                                </div>
                                <div class="org-sub-card">
                                    <div class="sub-agent-name">QualityBot</div>
                                    <div class="sub-agent-role">Test Automation</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Show sub-agents example for one C-level -->
                <div class="org-sub-level-demo">
                    <div class="org-connector"></div>
                    <div class="org-children" style="--bar-half-width: 120px; margin-top: 16px;">
                        <!-- Example sub-agents under Atlas -->
                        <div class="org-child">
                            <div class="org-connector--branch"></div>
                            <div class="org-sub-card">
                                <div class="sub-agent-name">TaskMaster</div>
                                <div class="sub-agent-role">Workflow Automation</div>
                            </div>
                        </div>
                        <div class="org-child">
                            <div class="org-connector--branch"></div>
                            <div class="org-sub-card">
                                <div class="sub-agent-name">DocBot</div>
                                <div class="sub-agent-role">Documentation</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /exec-hierarchy -->

        <!-- ═══ Status Bar (Bottom) ═══ -->
        <div class="exec-statusbar" role="status" aria-label="Office status bar">
            <div class="statusbar-info">
                <div class="statusbar-item">
                    <span class="statusbar-dot" aria-hidden="true"></span>
                    <span>Executive Office</span>
                </div>
                <div class="statusbar-separator" aria-hidden="true"></div>
                <div class="statusbar-item">
                    <span class="statusbar-item-icon" aria-hidden="true">👥</span>
                    <span id="statusAgentCount">6 Agents</span>
                </div>
                <div class="statusbar-separator" aria-hidden="true"></div>
                <div class="statusbar-item">
                    <span class="statusbar-item-icon" aria-hidden="true">⚡</span>
                    <span id="statusSystem">All systems nominal</span>
                </div>
            </div>
            <button class="statusbar-action" id="missionsBtn" aria-label="Missions">
                <span class="statusbar-action-icon" aria-hidden="true">🎯</span>
                <span>Missions</span>
            </button>
            <button class="statusbar-action" id="cronBtn" aria-label="Cron jobs">
                <span class="statusbar-action-icon" aria-hidden="true">📅</span>
                <span>Crons</span>
            </button>
            <button class="statusbar-action" id="memoryBtn" aria-label="Memory">
                <span class="statusbar-action-icon" aria-hidden="true">🧠</span>
                <span>Memory</span>
            </button>
            <button class="statusbar-action" id="chatBtn" aria-label="Chat with CEO">
                <span class="statusbar-action-icon" aria-hidden="true">💬</span>
                <span>Chat</span>
            </button>
            <button class="statusbar-action" id="settingsBtn" aria-label="Settings">
                <span class="statusbar-action-icon" aria-hidden="true">⚙️</span>
                <span>Settings</span>
            </button>
            <button class="statusbar-action" id="soundToggleBtn" aria-label="Toggle sounds" title="Toggle UI sounds">
                <span class="statusbar-action-icon" aria-hidden="true" id="soundToggleIcon">🔊</span>
                <span id="soundToggleLabel">Sound</span>
            </button>
            <div class="exec-command-input">
                <input
                    type="text"
                    placeholder="Type a command or press 💬 to chat..."
                    aria-label="Command input"
                    id="commandInput"
                    autocomplete="off"
                    spellcheck="false"
                />
                <span class="input-icon" aria-hidden="true">⌘</span>
            </div>
        </div>

    </div>
    <!-- /exec-container -->

    <!-- ═══ Mailbox Slide-In Panel ═══ -->
    <div class="mailbox-overlay" id="mailboxOverlay" role="dialog" aria-modal="true" aria-label="CEO Mailbox">
        <div class="mailbox-backdrop" id="mailboxBackdrop"></div>
        <div class="mailbox-panel">
            <div class="mailbox-header">
                <div class="mailbox-title">
                    <span aria-hidden="true">📬</span>
                    Inbox
                </div>
                <button class="mailbox-close" id="mailboxClose" aria-label="Close mailbox">×</button>
            </div>
            <div class="mailbox-messages" id="mailboxMessages">
                <!-- Messages populated by JS -->
            </div>
        </div>
    </div>

    <!-- ═══ Agent TODO Panel ═══ -->
    <div class="todo-overlay" id="todoOverlay" role="dialog" aria-modal="true" aria-labelledby="todoTitle">
        <div class="todo-backdrop" id="todoBackdrop"></div>
        <div class="todo-panel">
            <div class="todo-header">
                <div class="todo-agent-info" id="todoAgentInfo">
                    <div class="todo-agent-avatar" id="todoAvatar">
                        <!-- Avatar populated by JS -->
                    </div>
                    <div class="todo-agent-details">
                        <div class="todo-agent-name" id="todoName">Agent Name</div>
                        <div class="todo-agent-role" id="todoRole">Agent Role</div>
                    </div>
                </div>
                <button class="todo-close" id="todoClose" aria-label="Close TODO panel">×</button>
            </div>
            <div class="todo-content" id="todoContent">
                <!-- Content populated by JS -->
            </div>
        </div>
    </div>

    <!-- ═══ Meeting Room Panel ═══ -->
    <div class="meeting-overlay" id="meetingOverlay" role="dialog" aria-modal="true" aria-labelledby="meetingTitle">
        <div class="meeting-backdrop" id="meetingBackdrop"></div>
        <div class="meeting-panel">
            <div class="meeting-header">
                <div class="meeting-title" id="meetingTitle">
                    <span aria-hidden="true">🏛️</span>
                    Executive Boardroom
                </div>
                <button class="meeting-close" id="meetingClose" aria-label="Close meeting panel">×</button>
            </div>
            <div class="meeting-content" id="meetingContent">
                <!-- Content populated by JS -->
            </div>
        </div>
    </div>

    <!-- ═══ Agent Detail Panel (Feature 1) ═══ -->
    <div class="detail-overlay" id="detailOverlay" role="dialog" aria-modal="true" aria-label="Agent Details">
        <div class="detail-backdrop" id="detailBackdrop"></div>
        <div class="detail-panel">
            <div class="detail-hero">
                <div class="detail-hero-avatar" id="detailAvatar">
                    <div class="detail-hero-status" id="detailStatusDot"></div>
                </div>
                <div class="detail-hero-info">
                    <div class="detail-hero-name" id="detailName">Agent</div>
                    <div class="detail-hero-role" id="detailRole">Role</div>
                    <div class="detail-hero-task" id="detailTask">—</div>
                </div>
                <button class="detail-close" id="detailClose" aria-label="Close">×</button>
            </div>
            <div class="detail-body" id="detailBody"></div>
        </div>
    </div>

    <!-- ═══ CEO Chat Panel (Feature 2) ═══ -->
    <div class="chat-overlay" id="chatOverlay" role="dialog" aria-modal="true" aria-label="CEO Chat">
        <div class="chat-backdrop" id="chatBackdrop"></div>
        <div class="chat-panel">
            <div class="chat-header">
                <div class="chat-title">
                    <span class="chat-title-dot"></span>
                    CEO Chat
                </div>
                <button class="chat-close" id="chatClose" aria-label="Close chat">×</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-empty" id="chatEmpty">No messages yet. Send a mission to the CEO.</div>
            </div>
            <div class="chat-input-bar">
                <select id="chatRouteSelect" style="padding:4px 8px;border-radius:8px;border:1px solid var(--border-medium);background:var(--bg-tertiary);color:var(--text-secondary);font-size:11px;font-family:var(--font-family);cursor:pointer;flex-shrink:0;" title="Route message to...">
                    <option value="ceo">📬 Direct to CEO</option>
                    <option value="atlas">📊 Via Atlas (COO)</option>
                    <option value="forge">🔨 Via Forge (CTO)</option>
                    <option value="hunter">💰 Via Hunter (CRO)</option>
                    <option value="echo">📢 Via Echo (CMO)</option>
                    <option value="sentinel">🛡️ Via Sentinel (QA)</option>
                </select>
                <input class="chat-input" id="chatInput" type="text" placeholder="Send a mission..." autocomplete="off" spellcheck="false" style="flex:1;" />
                <button class="chat-send" id="chatSend" aria-label="Send">↑</button>
            </div>
        </div>
    </div>

    <!-- ═══ Cron / Calendar Overlay (Feature 4) ═══ -->
    <div class="cron-overlay" id="cronOverlay" role="dialog" aria-modal="true" aria-label="Cron Jobs">
        <div class="cron-backdrop" id="cronBackdrop"></div>
        <div class="cron-panel">
            <div class="cron-header">
                <div class="cron-title">
                    <span aria-hidden="true">📅</span>
                    Scheduled Jobs
                </div>
                <button class="cron-close" id="cronClose" aria-label="Close">×</button>
            </div>
            <div class="cron-body" id="cronBody">
                <div class="cron-empty">Loading cron jobs…</div>
            </div>
        </div>
    </div>

    <!-- ═══ Memory View Overlay (Feature 5) ═══ -->
    <div class="memory-overlay" id="memoryOverlay" role="dialog" aria-modal="true" aria-label="Memory View">
        <div class="memory-backdrop" id="memoryBackdrop"></div>
        <div class="memory-panel">
            <div class="memory-header">
                <div class="memory-title">
                    <span aria-hidden="true">🧠</span>
                    Fleet Memory
                </div>
                <button class="memory-close" id="memoryClose" aria-label="Close">×</button>
            </div>
            <div class="memory-body" id="memoryBody">
                <div class="cron-empty">Loading memory…</div>
            </div>
        </div>
    </div>

    <!-- ═══ Missions Panel (NEW #2) ═══ -->
    <div class="cron-overlay" id="missionsOverlay" role="dialog" aria-modal="true" aria-label="Missions">
        <div class="cron-backdrop" id="missionsBackdrop"></div>
        <div class="cron-panel">
            <div class="cron-header">
                <div class="cron-title">
                    <span aria-hidden="true">🎯</span>
                    Active Missions
                </div>
                <button class="cron-close" id="missionsClose" aria-label="Close">×</button>
            </div>
            <div class="cron-body" id="missionsBody">
                <div class="cron-empty">Loading missions…</div>
            </div>
        </div>
    </div>

    <!-- ═══ Settings Panel (NEW #3 + NEW #5) ═══ -->
    <div class="cron-overlay" id="settingsOverlay" role="dialog" aria-modal="true" aria-label="Settings">
        <div class="cron-backdrop" id="settingsBackdrop"></div>
        <div class="cron-panel" style="max-width:500px;">
            <div class="cron-header">
                <div class="cron-title">
                    <span aria-hidden="true">⚙️</span>
                    Settings
                </div>
                <button class="cron-close" id="settingsClose" aria-label="Close">×</button>
            </div>
            <div class="cron-body" id="settingsBody">
                <div class="cron-empty">Loading settings…</div>
            </div>
        </div>
    </div>

    <!-- ═══ Spawn Agent Panel ═══ -->
    <div class="spawn-overlay" id="spawnOverlay" role="dialog" aria-modal="true" aria-label="Spawn New Agent">
        <div class="spawn-backdrop" id="spawnBackdrop"></div>
        <div class="spawn-panel">
            <div class="spawn-header">
                <div class="spawn-title">
                    <span aria-hidden="true">🚀</span>
                    Recruit New Executive
                </div>
                <button class="spawn-close" id="spawnClose" aria-label="Close">×</button>
            </div>
            <!-- Step indicators -->
            <div class="spawn-steps" id="spawnSteps">
                <div class="spawn-step-indicator active" data-step="1">
                    <div class="spawn-step-num">1</div>
                    <div class="spawn-step-label">Character</div>
                </div>
                <div class="spawn-step-divider"></div>
                <div class="spawn-step-indicator" data-step="2">
                    <div class="spawn-step-num">2</div>
                    <div class="spawn-step-label">Configure</div>
                </div>
                <div class="spawn-step-divider"></div>
                <div class="spawn-step-indicator" data-step="3">
                    <div class="spawn-step-num">3</div>
                    <div class="spawn-step-label">Deploy</div>
                </div>
            </div>
            <div class="spawn-body" id="spawnBody">
                <!-- Step 1: Choose Character -->
                <div class="spawn-step-content active" id="spawnStep1">
                    <div class="spawn-section-title">Choose a character for your new executive</div>
                    <div class="spawn-char-grid" id="spawnCharGrid" role="radiogroup" aria-label="Character selection">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <!-- Step 2: Configure Agent -->
                <div class="spawn-step-content" id="spawnStep2">
                    <div class="spawn-field">
                        <label for="spawnName">Name</label>
                        <input type="text" id="spawnName" placeholder="e.g. Nova, Cipher, Phoenix..." autocomplete="off" maxlength="20" />
                    </div>
                    <div class="spawn-field">
                        <label for="spawnRole">Role</label>
                        <input type="text" id="spawnRole" placeholder="e.g. Data Analyst, Content Writer..." autocomplete="off" maxlength="40" />
                    </div>
                    <div class="spawn-field">
                        <label>Traits</label>
                        <div class="spawn-traits-container" id="spawnTraitsContainer">
                            <input type="text" class="spawn-traits-input" id="spawnTraitsInput" placeholder="Type and press Enter..." />
                        </div>
                    </div>
                    <div class="spawn-field">
                        <label>Skills</label>
                        <div class="spawn-skills-grid" id="spawnSkillsGrid">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="spawn-field">
                        <label for="spawnSoul">SOUL (personality & instructions)</label>
                        <textarea id="spawnSoul" placeholder="Define this agent's personality, behavior, and instructions...&#10;&#10;Example: You are a meticulous data analyst who values accuracy above all. You double-check every number and present findings with clear visualizations." rows="5"></textarea>
                    </div>
                </div>
                <!-- Step 3: Review & Deploy -->
                <div class="spawn-step-content" id="spawnStep3">
                    <div class="spawn-review" id="spawnReview">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <!-- Navigation -->
            <div class="spawn-nav" id="spawnNav">
                <button class="spawn-btn spawn-btn--secondary" id="spawnPrevBtn" style="visibility:hidden;">← Back</button>
                <button class="spawn-btn spawn-btn--primary" id="spawnNextBtn" disabled>Next →</button>
            </div>
        </div>
    </div>

    <!-- ═══ Onboarding Overlay ═══ -->
    <div class="onboarding-overlay" id="onboardingOverlay" role="dialog" aria-modal="true" aria-label="Welcome walkthrough">
        <div class="onboarding-scrim" id="onboardingScrim"></div>
        <div class="onboarding-spotlight" id="onboardingSpotlight" aria-hidden="true"></div>
        <div class="onboarding-card" id="onboardingCard" role="alertdialog" aria-labelledby="onboardingTitle" aria-describedby="onboardingText">
            <div class="onboarding-avatar" id="onboardingAvatar" aria-hidden="true">
                <svg><use href="#avatar-ceo"/></svg>
            </div>
            <div class="onboarding-title" id="onboardingTitle"></div>
            <div class="onboarding-text" id="onboardingText"></div>
            <button class="onboarding-cta" id="onboardingCta" aria-label="Continue walkthrough"></button>
        </div>
    </div>
    <button class="onboarding-skip" id="onboardingSkip" aria-label="Skip walkthrough">Skip</button>
    <div class="onboarding-dots" id="onboardingDots" role="tablist" aria-label="Walkthrough progress">
        <div class="onboarding-dot active" role="tab" aria-label="Step 1 of 5" aria-selected="true" tabindex="0"></div>
        <div class="onboarding-dot" role="tab" aria-label="Step 2 of 5" aria-selected="false" tabindex="-1"></div>
        <div class="onboarding-dot" role="tab" aria-label="Step 3 of 5" aria-selected="false" tabindex="-1"></div>
        <div class="onboarding-dot" role="tab" aria-label="Step 4 of 5" aria-selected="false" tabindex="-1"></div>
        <div class="onboarding-dot" role="tab" aria-label="Step 5 of 5" aria-selected="false" tabindex="-1"></div>
    </div>

    <!-- ═══ Toast ═══ -->
    <div class="exec-toast" id="execToast"></div>

    <!-- ═══════════════════════════════════════════════════
         JavaScript — Interactions & State Bridge
         ═══════════════════════════════════════════════════ -->
    <!-- Real Data Configuration for Sycopa's fleet-relay -->
    <script>
        window.OC_RELAY_URL = 'http://localhost:18790';
        window.OC_RELAY_TOKEN = 'sk-oc-proxy-spawnkit-2026';
    </script>
    <script src="../src/data-bridge.js"></script>
    <script>
    // Read config from setup wizard (if available)
    try {
      const setupConfig = JSON.parse(localStorage.getItem('spawnkit-config') || '{}');
      if (setupConfig.userName) {
        // Replace "ApoMac" with the user's name in the CEO card
        document.addEventListener('DOMContentLoaded', () => {
          const ceoNames = document.querySelectorAll('[data-agent="ceo"] .agent-name, .ceo-name');
          ceoNames.forEach(el => el.textContent = setupConfig.userName);
        });
      }
      if (setupConfig.ceoName) {
        // Replace CEO agent name
        document.addEventListener('DOMContentLoaded', () => {
          const ceoLabels = document.querySelectorAll('[data-agent="ceo"] .agent-label');
          ceoLabels.forEach(el => el.textContent = setupConfig.ceoName);
        });
      }
    } catch(e) { /* ignore */ }

    (function() {
        'use strict';

        /* ═══════════════════════════════════════════════
           SoundEngine — Web Audio API Synthesized Sounds
           Premium, subtle, Apple/Linear quality
           ═══════════════════════════════════════════════ */

        var SoundEngine = (function() {
            var ctx = null;
            var enabled = true;
            var initialized = false;
            var ambientNode = null;
            var ambientGain = null;

            // Load preference
            try {
                var pref = localStorage.getItem('spawnkit-sound-enabled');
                if (pref !== null) enabled = pref === 'true';
            } catch(e) {}

            // Respect prefers-reduced-motion
            if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                enabled = false;
            }

            function getCtx() {
                if (!ctx) {
                    try {
                        ctx = new (window.AudioContext || window.webkitAudioContext)();
                    } catch(e) { return null; }
                }
                if (ctx.state === 'suspended') ctx.resume();
                return ctx;
            }

            function isEnabled() { return enabled && getCtx() !== null; }

            // ── Utility: create a gain envelope ──
            function makeGain(ac, volume, attackMs, decayMs, startTime) {
                var g = ac.createGain();
                g.gain.setValueAtTime(0, startTime);
                g.gain.linearRampToValueAtTime(volume, startTime + attackMs / 1000);
                g.gain.linearRampToValueAtTime(0, startTime + (attackMs + decayMs) / 1000);
                return g;
            }

            // ── Utility: filtered noise burst ──
            function noiseBurst(ac, dest, startTime, durationMs, filterFreq, filterQ, volume) {
                var len = ac.sampleRate * (durationMs / 1000);
                var buf = ac.createBuffer(1, len, ac.sampleRate);
                var data = buf.getChannelData(0);
                for (var i = 0; i < len; i++) data[i] = (Math.random() * 2 - 1);
                var src = ac.createBufferSource();
                src.buffer = buf;
                var filt = ac.createBiquadFilter();
                filt.type = 'bandpass';
                filt.frequency.value = filterFreq;
                filt.Q.value = filterQ;
                var g = makeGain(ac, volume, durationMs * 0.1, durationMs * 0.9, startTime);
                src.connect(filt);
                filt.connect(g);
                g.connect(dest);
                src.start(startTime);
                src.stop(startTime + durationMs / 1000);
            }

            return {
                get enabled() { return enabled; },

                toggle: function() {
                    enabled = !enabled;
                    try { localStorage.setItem('spawnkit-sound-enabled', enabled.toString()); } catch(e) {}
                    // Stop ambient if disabling
                    if (!enabled && ambientNode) {
                        try { ambientGain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3); } catch(e) {}
                        ambientNode = null;
                    }
                    return enabled;
                },

                setEnabled: function(val) {
                    enabled = !!val;
                    try { localStorage.setItem('spawnkit-sound-enabled', enabled.toString()); } catch(e) {}
                    if (!enabled && ambientNode) {
                        try { ambientGain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3); } catch(e) {}
                        ambientNode = null;
                    }
                },

                // ── Panel open: soft whoosh sweep up (200ms) ──
                whooshOpen: function() {
                    if (!isEnabled()) return;
                    var ac = getCtx(); var t = ac.currentTime;
                    var osc = ac.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(200, t);
                    osc.frequency.exponentialRampToValueAtTime(800, t + 0.18);
                    var g = ac.createGain();
                    g.gain.setValueAtTime(0, t);
                    g.gain.linearRampToValueAtTime(0.06, t + 0.03);
                    g.gain.linearRampToValueAtTime(0.04, t + 0.1);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
                    // Add subtle noise for texture
                    noiseBurst(ac, ac.destination, t, 120, 2000, 0.5, 0.015);
                    osc.connect(g);
                    g.connect(ac.destination);
                    osc.start(t);
                    osc.stop(t + 0.22);
                },

                // ── Panel close: reverse whoosh sweep down (150ms) ──
                whooshClose: function() {
                    if (!isEnabled()) return;
                    var ac = getCtx(); var t = ac.currentTime;
                    var osc = ac.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, t);
                    osc.frequency.exponentialRampToValueAtTime(150, t + 0.14);
                    var g = ac.createGain();
                    g.gain.setValueAtTime(0, t);
                    g.gain.linearRampToValueAtTime(0.05, t + 0.02);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
                    noiseBurst(ac, ac.destination, t, 100, 1500, 0.5, 0.012);
                    osc.connect(g);
                    g.connect(ac.destination);
                    osc.start(t);
                    osc.stop(t + 0.17);
                },

                // ── Button click: subtle tap pulse (50ms) ──
                click: function() {
                    if (!isEnabled()) return;
                    var ac = getCtx(); var t = ac.currentTime;
                    var osc = ac.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(1800, t);
                    osc.frequency.exponentialRampToValueAtTime(1200, t + 0.04);
                    var g = ac.createGain();
                    g.gain.setValueAtTime(0.04, t);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
                    osc.connect(g);
                    g.connect(ac.destination);
                    osc.start(t);
                    osc.stop(t + 0.06);
                },

                // ── Button hover: very subtle tick (10ms) ──
                tick: function() {
                    if (!isEnabled()) return;
                    var ac = getCtx(); var t = ac.currentTime;
                    var osc = ac.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = 2400;
                    var g = ac.createGain();
                    g.gain.setValueAtTime(0.015, t);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.012);
                    osc.connect(g);
                    g.connect(ac.destination);
                    osc.start(t);
                    osc.stop(t + 0.015);
                },

                // ── Toast notification: gentle two-tone ascending chime (300ms) ──
                chime: function() {
                    if (!isEnabled()) return;
                    var ac = getCtx(); var t = ac.currentTime;
                    // First tone
                    var o1 = ac.createOscillator();
                    o1.type = 'sine';
                    o1.frequency.value = 880; // A5
                    var g1 = ac.createGain();
                    g1.gain.setValueAtTime(0, t);
                    g1.gain.linearRampToValueAtTime(0.06, t + 0.01);
                    g1.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
                    o1.connect(g1); g1.connect(ac.destination);
                    o1.start(t); o1.stop(t + 0.16);
                    // Second tone (higher)
                    var o2 = ac.createOscillator();
                    o2.type = 'sine';
                    o2.frequency.value = 1174.66; // D6
                    var g2 = ac.createGain();
                    g2.gain.setValueAtTime(0, t + 0.1);
                    g2.gain.linearRampToValueAtTime(0.05, t + 0.11);
                    g2.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
                    o2.connect(g2); g2.connect(ac.destination);
                    o2.start(t + 0.1); o2.stop(t + 0.32);
                },

                // ── Send message: iOS-like send swoosh ──
                sendSwoosh: function() {
                    if (!isEnabled()) return;
                    var ac = getCtx(); var t = ac.currentTime;
                    // Quick ascending sweep
                    var osc = ac.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, t);
                    osc.frequency.exponentialRampToValueAtTime(1400, t + 0.08);
                    osc.frequency.exponentialRampToValueAtTime(1800, t + 0.12);
                    var g = ac.createGain();
                    g.gain.setValueAtTime(0, t);
                    g.gain.linearRampToValueAtTime(0.06, t + 0.02);
                    g.gain.linearRampToValueAtTime(0.04, t + 0.07);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
                    // Subtle noise swoosh layer
                    noiseBurst(ac, ac.destination, t, 100, 3000, 0.8, 0.02);
                    osc.connect(g);
                    g.connect(ac.destination);
                    osc.start(t);
                    osc.stop(t + 0.17);
                },

                // ── Agent status change: soft ping ──
                ping: function() {
                    if (!isEnabled()) return;
                    var ac = getCtx(); var t = ac.currentTime;
                    var osc = ac.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = 1046.5; // C6
                    var g = ac.createGain();
                    g.gain.setValueAtTime(0, t);
                    g.gain.linearRampToValueAtTime(0.05, t + 0.005);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.25);
                    osc.connect(g);
                    g.connect(ac.destination);
                    osc.start(t);
                    osc.stop(t + 0.27);
                },

                // ── Decommission: dramatic descending tone (600ms) ──
                decommission: function() {
                    if (!isEnabled()) return;
                    var ac = getCtx(); var t = ac.currentTime;
                    // Main descending tone
                    var o1 = ac.createOscillator();
                    o1.type = 'sawtooth';
                    o1.frequency.setValueAtTime(800, t);
                    o1.frequency.exponentialRampToValueAtTime(100, t + 0.6);
                    var filt = ac.createBiquadFilter();
                    filt.type = 'lowpass';
                    filt.frequency.setValueAtTime(3000, t);
                    filt.frequency.exponentialRampToValueAtTime(200, t + 0.6);
                    var g1 = ac.createGain();
                    g1.gain.setValueAtTime(0, t);
                    g1.gain.linearRampToValueAtTime(0.06, t + 0.02);
                    g1.gain.linearRampToValueAtTime(0.04, t + 0.3);
                    g1.gain.exponentialRampToValueAtTime(0.001, t + 0.6);
                    o1.connect(filt); filt.connect(g1); g1.connect(ac.destination);
                    o1.start(t); o1.stop(t + 0.65);
                    // Sub bass rumble
                    var o2 = ac.createOscillator();
                    o2.type = 'sine';
                    o2.frequency.setValueAtTime(120, t + 0.1);
                    o2.frequency.exponentialRampToValueAtTime(40, t + 0.6);
                    var g2 = ac.createGain();
                    g2.gain.setValueAtTime(0, t + 0.1);
                    g2.gain.linearRampToValueAtTime(0.04, t + 0.15);
                    g2.gain.exponentialRampToValueAtTime(0.001, t + 0.6);
                    o2.connect(g2); g2.connect(ac.destination);
                    o2.start(t + 0.1); o2.stop(t + 0.65);
                },

                // ── New mail: notification ding — three ascending tones ──
                mailDing: function() {
                    if (!isEnabled()) return;
                    var ac = getCtx(); var t = ac.currentTime;
                    var notes = [783.99, 987.77, 1318.51]; // G5, B5, E6
                    notes.forEach(function(freq, i) {
                        var osc = ac.createOscillator();
                        osc.type = 'sine';
                        osc.frequency.value = freq;
                        var g = ac.createGain();
                        var offset = i * 0.09;
                        g.gain.setValueAtTime(0, t + offset);
                        g.gain.linearRampToValueAtTime(0.05, t + offset + 0.008);
                        g.gain.exponentialRampToValueAtTime(0.001, t + offset + 0.2);
                        osc.connect(g); g.connect(ac.destination);
                        osc.start(t + offset);
                        osc.stop(t + offset + 0.22);
                    });
                },

                // ── Office ambiance: barely perceptible low hum ──
                startAmbient: function() {
                    if (!isEnabled()) return;
                    var ac = getCtx();
                    if (ambientNode) return; // Already running
                    var t = ac.currentTime;
                    // Very low drone
                    var osc = ac.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = 60;
                    // Subtle LFO modulation
                    var lfo = ac.createOscillator();
                    lfo.type = 'sine';
                    lfo.frequency.value = 0.08;
                    var lfoGain = ac.createGain();
                    lfoGain.gain.value = 2; // ±2Hz wobble
                    lfo.connect(lfoGain);
                    lfoGain.connect(osc.frequency);
                    // Master gain — very quiet
                    ambientGain = ac.createGain();
                    ambientGain.gain.setValueAtTime(0, t);
                    ambientGain.gain.linearRampToValueAtTime(0.008, t + 2); // Fade in over 2s
                    osc.connect(ambientGain);
                    ambientGain.connect(ac.destination);
                    osc.start(t);
                    lfo.start(t);
                    ambientNode = osc;
                    ambientNode._lfo = lfo;
                },

                stopAmbient: function() {
                    if (!ambientNode) return;
                    try {
                        var ac = getCtx(); var t = ac.currentTime;
                        ambientGain.gain.linearRampToValueAtTime(0, t + 0.5);
                        var node = ambientNode;
                        setTimeout(function() {
                            try { node.stop(); node._lfo.stop(); } catch(e) {}
                        }, 600);
                        ambientNode = null;
                    } catch(e) {}
                },

                get ambientRunning() { return !!ambientNode; }
            };
        })();

        // Expose for debugging
        window.__SoundEngine = SoundEngine;

        /* ═══════════════════════════════════════════════
           Configuration & Mock Data
           ═══════════════════════════════════════════════ */

        // Get user's setup config for personalization
        var setupConfig = {};
        try {
            setupConfig = JSON.parse(localStorage.getItem('spawnkit-config') || '{}');
        } catch(e) {}

        /* Check if spawnkitAPI is available (Electron preload) */
        // spawnkitAPI reference — isAvailable() is async, resolved at init time
        var API = (typeof window.spawnkitAPI !== 'undefined') ? window.spawnkitAPI : null;

        var AGENTS = {
            ceo:      { name: setupConfig.userName || 'ApoMac', role: setupConfig.ceoName || 'CEO', color: '#007AFF', status: 'active', task: 'Orchestrating fleet operations' },
            atlas:    { name: 'Atlas',    role: 'COO',           color: '#BF5AF2', status: 'idle', task: '' },
            forge:    { name: 'Forge',    role: 'CTO',           color: '#FF9F0A', status: 'idle', task: '' },
            hunter:   { name: 'Hunter',   role: 'CRO',           color: '#FF453A', status: 'idle', task: '' },
            echo:     { name: 'Echo',     role: 'CMO',           color: '#0A84FF', status: 'idle', task: '' },
            sentinel: { name: 'Sentinel', role: 'QA & Security', color: '#30D158', status: 'idle', task: '' },
        };

        /* Default skills by role (Feature 6 fallback) */
        var DEFAULT_SKILLS = {
            ceo:      ['🎯 Orchestration', '📊 Strategy', '🔮 Vision', '👥 Leadership'],
            atlas:    ['⚙️ Operations', '📋 Process', '📝 Docs', '🔄 Workflows'],
            forge:    ['🛠️ Engineering', '🔒 Security', '🏗️ Architecture', '⚡ Perf'],
            hunter:   ['💰 Revenue', '📈 Growth', '🎯 Sales', '🔍 Research'],
            echo:     ['🎨 Brand', '📱 Content', '🎬 Video', '✍️ Copy'],
            sentinel: ['🛡️ Audit', '✅ QA', '⚠️ Risk', '🔍 Review']
        };

        /* Live data caches */
        var liveSessionData = null;
        var liveCronData = null;
        var liveMemoryData = null;
        var chatHistory = [];

        /* Pre-fetch cron + memory data for panels */
        function prefetchPanelData() {
            if (!API) return;
            try { liveCronData = API.getCrons(); } catch(e) {}
            try { liveMemoryData = API.getMemory(); } catch(e) {}
        }
        prefetchPanelData();
        setInterval(prefetchPanelData, 30000);

        /* SVG avatar ID map for mailbox rendering */
        var AVATAR_MAP = {
            'ApoMac': 'avatar-ceo',
            [setupConfig.userName || 'ApoMac']: 'avatar-ceo',
            'Atlas': 'avatar-atlas',
            'Forge': 'avatar-forge',
            'Hunter': 'avatar-hunter',
            'Echo': 'avatar-echo',
            'Sentinel': 'avatar-sentinel'
        };

        // Live messages loaded from transcript
        var LIVE_MESSAGES = [];

        /* Agent TODO Data — Live from spawnkitAPI */  
        var LIVE_AGENT_DATA = {};
        
        /* ── Load Live Agent Data — REAL per-agent TODO.md + SKILLS.md ──────── */
        async function loadLiveAgentData() {
            var agentIds = ['ceo', 'atlas', 'forge', 'hunter', 'echo', 'sentinel'];
            
            if (!window.spawnkitAPI || !await window.spawnkitAPI.isAvailable()) {
                console.log('🏢 [Executive] No live data — showing empty state');
                LIVE_AGENT_DATA = {};
                agentIds.forEach(function(id) {
                    LIVE_AGENT_DATA[id] = {
                        currentTask: 'Connect to OpenClaw for live data',
                        todos: [],
                        skills: []
                    };
                });
                return;
            }
            
            try {
                // Load per-agent TODO and skills in parallel
                var todoPromises = agentIds.map(function(id) {
                    return window.spawnkitAPI.getAgentTodos(id);
                });
                var skillPromises = agentIds.map(function(id) {
                    return window.spawnkitAPI.getAgentSkills(id);
                });
                
                var allTodos = await Promise.all(todoPromises);
                var allSkills = await Promise.all(skillPromises);
                
                LIVE_AGENT_DATA = {};
                agentIds.forEach(function(id, i) {
                    var todoData = allTodos[i] || { todos: [], currentTask: 'Standby' };
                    var skillsData = allSkills[i] || [];
                    
                    LIVE_AGENT_DATA[id] = {
                        currentTask: todoData.currentTask || 'Standby',
                        todos: todoData.todos || [],
                        skills: skillsData.map(function(s, idx) {
                            return { name: s.name || s.dirName || 'Skill', percentage: Math.max(70, 95 - idx * 5), description: s.description || '' };
                        })
                    };
                });
                
                console.log('🏢 [Executive] Loaded REAL per-agent data for', Object.keys(LIVE_AGENT_DATA).length, 'agents');
            } catch (e) {
                console.warn('🏢 [Executive] Failed to load agent data:', e);
                LIVE_AGENT_DATA = {};
                agentIds.forEach(function(id) {
                    LIVE_AGENT_DATA[id] = {
                        currentTask: 'Error loading data',
                        todos: [],
                        skills: []
                    };
                });
            }
        }

        /* ═══════════════════════════════════════════════
           DOM References
           ═══════════════════════════════════════════════ */

        var mailboxBtn      = document.getElementById('mailboxBtn');
        var mailboxOverlay  = document.getElementById('mailboxOverlay');
        var mailboxBackdrop = document.getElementById('mailboxBackdrop');
        var mailboxClose    = document.getElementById('mailboxClose');
        var mailboxMessages = document.getElementById('mailboxMessages');
        var commandInput    = document.getElementById('commandInput');
        var gridView        = document.getElementById('gridView');
        var hierarchyView   = document.getElementById('hierarchyView');
        var tabGrid         = document.getElementById('tabGrid');
        var tabHierarchy    = document.getElementById('tabHierarchy');

        // TODO Panel elements
        var todoOverlay     = document.getElementById('todoOverlay');
        var todoBackdrop    = document.getElementById('todoBackdrop');
        var todoClose       = document.getElementById('todoClose');
        var todoAvatar      = document.getElementById('todoAvatar');
        var todoName        = document.getElementById('todoName');
        var todoRole        = document.getElementById('todoRole');
        var todoContent     = document.getElementById('todoContent');

        // Meeting Panel elements
        var meetingOverlay  = document.getElementById('meetingOverlay');
        var meetingBackdrop = document.getElementById('meetingBackdrop');
        var meetingClose    = document.getElementById('meetingClose');
        var meetingContent  = document.getElementById('meetingContent');
        
        // Chat/Cron/Memory panel elements — declared in unified implementation below

        /* ═══════════════════════════════════════════════
           View Toggle — Grid / Hierarchy
           ═══════════════════════════════════════════════ */

        function switchView(view) {
            if (view === 'grid') {
                gridView.classList.remove('hidden');
                hierarchyView.classList.remove('visible');
                tabGrid.classList.add('active');
                tabGrid.setAttribute('aria-selected', 'true');
                tabHierarchy.classList.remove('active');
                tabHierarchy.setAttribute('aria-selected', 'false');
            } else {
                gridView.classList.add('hidden');
                hierarchyView.classList.add('visible');
                tabHierarchy.classList.add('active');
                tabHierarchy.setAttribute('aria-selected', 'true');
                tabGrid.classList.remove('active');
                tabGrid.setAttribute('aria-selected', 'false');
            }
        }

        tabGrid.addEventListener('click', function() { switchView('grid'); });
        tabHierarchy.addEventListener('click', function() { switchView('hierarchy'); });

        // Keyboard nav for tabs
        document.querySelector('.view-toggle-group').addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                e.preventDefault();
                var current = document.querySelector('.view-toggle-btn.active');
                var next = e.key === 'ArrowRight' ? tabHierarchy : tabGrid;
                switchView(next.dataset.view);
                next.focus();
            }
        });

        /* ═══════════════════════════════════════════════
           Mailbox Panel — Open / Close
           ═══════════════════════════════════════════════ */

        function openMailbox(e) {
            if (e) e.stopPropagation();
            closeTodoPanel();
            closeDetailPanel();
            mailboxOverlay.classList.add('open');
            mailboxClose.focus();
            document.body.style.overflow = 'hidden';
            SoundEngine.whooshOpen();
        }

        function closeMailbox() {
            if (mailboxOverlay.classList.contains('open')) SoundEngine.whooshClose();
            mailboxOverlay.classList.remove('open');
            document.body.style.overflow = '';
            mailboxBtn.focus();
        }

        mailboxBtn.addEventListener('click', openMailbox);
        mailboxBackdrop.addEventListener('click', closeMailbox);
        mailboxClose.addEventListener('click', closeMailbox);
        
        /* Chat/Cron/Memory panels — see unified implementation below (Forge v3) */

        /* ═══════════════════════════════════════════════
           TODO Panel — Open / Close
           ═══════════════════════════════════════════════ */

        /* ═══════════════════════════════════════════════
           Agent Detail Panel — NEW (Feature 1)
           Uses the new detail-overlay with rich content
           ═══════════════════════════════════════════════ */
        var detailOverlay  = document.getElementById('detailOverlay');
        var detailBackdrop = document.getElementById('detailBackdrop');
        var detailClose    = document.getElementById('detailClose');

        async function openDetailPanel(agentId) {
            closeMailbox();
            closeTodoPanel();

            var agent = AGENTS[agentId];
            if (!agent) return;

            // Hero section
            var avatarId = AVATAR_MAP[agent.name];
            var avatarEl = document.getElementById('detailAvatar');
            if (avatarId) {
                avatarEl.innerHTML = '<svg><use href="#' + avatarId + '"/></svg><div class="detail-hero-status" id="detailStatusDot"></div>';
            } else {
                avatarEl.innerHTML = '<div style="width:64px;height:64px;border-radius:50%;background:' + agent.color + ';display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px;font-weight:700">' + agent.name.charAt(0) + '</div>';
            }
            var sc = (agent.status === 'active' || agent.status === 'working') ? 'var(--status-active)' :
                     (agent.status === 'busy' || agent.status === 'building') ? 'var(--status-busy)' : 'var(--status-idle)';
            var dot = document.getElementById('detailStatusDot');
            if (dot) dot.style.background = sc;

            document.getElementById('detailName').textContent = agent.name;
            document.getElementById('detailRole').textContent = agent.role;
            document.getElementById('detailTask').textContent = agent.task || (agent.status === 'idle' ? '💤 Idle' : '—');

            // Build body
            var body = '';

            // Metrics section
            body += '<div class="detail-section"><div class="detail-section-title">Metrics</div>';
            body += '<div class="detail-metrics">';
            body += '<div class="detail-metric"><div class="detail-metric-value">' + (['active','working','busy','building'].indexOf(agent.status) >= 0 ? '🟢' : '💤') + '</div><div class="detail-metric-label">Status</div></div>';
            body += '<div class="detail-metric"><div class="detail-metric-value">—</div><div class="detail-metric-label">Tokens Used</div></div>';
            body += '<div class="detail-metric"><div class="detail-metric-value">—</div><div class="detail-metric-label">API Calls</div></div>';
            body += '<div class="detail-metric"><div class="detail-metric-value">—</div><div class="detail-metric-label">Last Active</div></div>';
            body += '</div></div>';

            // Try to get live data for metrics — use async pattern
            if (API) {
                (async function() {
                    try {
                        var metricsData = await API.getMetrics();
                        if (metricsData && metricsData.agentBreakdown && metricsData.agentBreakdown[agentId]) {
                            var ab = metricsData.agentBreakdown[agentId];
                            var metricsEls = document.querySelectorAll('#detailBody .detail-metric-value');
                            if (metricsEls.length >= 4) {
                                if (ab.tokens) metricsEls[1].textContent = ab.tokens.toLocaleString();
                                if (ab.apiCalls) metricsEls[2].textContent = ab.apiCalls.toString();
                                if (ab.lastActive) metricsEls[3].textContent = ab.lastActive;
                            }
                        }
                    } catch(e) { console.warn('Metrics load error:', e); }
                })();
            }

            // TODO list section — from REAL live data only
            var todoData = LIVE_AGENT_DATA[agentId];
            if (todoData) {
                body += '<div class="detail-section"><div class="detail-section-title">Current Task</div>';
                body += '<div style="font-size:14px;font-weight:500;color:var(--text-primary)">' + (todoData.currentTask || agent.task || 'Idle') + '</div>';
                body += '</div>';

                if (todoData.todos && todoData.todos.length) {
                    body += '<div class="detail-section"><div class="detail-section-title">TODO List</div>';
                    todoData.todos.forEach(function(todo) {
                        body += '<div class="detail-todo-item' + (todo.status === 'done' ? ' detail-todo-item--done' : '') + '">';
                        body += '<span class="detail-todo-icon">' + todo.icon + '</span>';
                        body += '<span class="detail-todo-text">' + todo.text + '</span>';
                        body += '</div>';
                    });
                    body += '</div>';
                }
            }

            // Skills section — from real per-agent SKILLS.md (FIX #5) + management (NEW #1)
            var agentSkills = (todoData && todoData.skills && todoData.skills.length) ? todoData.skills : [];
            if (agentSkills.length > 0) {
                body += '<div class="detail-section"><div class="detail-section-title">Skills</div>';
                body += '<div class="detail-skill-chips" id="detailSkillChips">';
                agentSkills.forEach(function(s, idx) {
                    body += '<span class="detail-skill-chip" data-skill-idx="' + idx + '">' + (s.name || s) + ' <button class="skill-remove-btn" data-skill-name="' + (s.name || s) + '" title="Remove skill" style="background:none;border:none;cursor:pointer;color:var(--text-tertiary);font-size:11px;margin-left:4px;padding:0 2px;">×</button></span>';
                });
                body += '</div>';
                body += '<button class="detail-add-skill-btn" id="addSkillBtn" style="margin-top:8px;padding:6px 14px;border-radius:8px;border:1px dashed var(--border-medium);background:transparent;color:var(--exec-blue);font-size:12px;font-weight:500;cursor:pointer;">+ Add Skill</button>';
                body += '</div>';
            } else {
                body += '<div class="detail-section"><div class="detail-section-title">Skills</div>';
                body += '<div style="color:var(--text-tertiary);font-size:13px;">No skills defined in SKILLS.md</div>';
                body += '<button class="detail-add-skill-btn" id="addSkillBtn" style="margin-top:8px;padding:6px 14px;border-radius:8px;border:1px dashed var(--border-medium);background:transparent;color:var(--exec-blue);font-size:12px;font-weight:500;cursor:pointer;">+ Add Skill</button>';
                body += '</div>';
            }

            // SOUL excerpt + Edit button (NEW #4)
            if (API) {
                try {
                    var agentInfo = await API.getAgentInfo(agentId);
                    if (agentInfo && agentInfo.soul) {
                        var excerpt = agentInfo.soul.substring(0, 500);
                        body += '<div class="detail-section"><div class="detail-section-title">Soul (Personality)</div>';
                        body += '<div class="detail-soul-excerpt" id="soulExcerpt">' + excerpt.replace(/</g,'&lt;').replace(/>/g,'&gt;') + (agentInfo.soul.length > 500 ? '…' : '') + '</div>';
                        
                        // Edit button — disabled for sub-agents
                        if (agentId !== 'ceo') {
                            body += '<button class="detail-edit-btn" id="editAgentBtn" style="margin-top:8px;padding:6px 14px;border-radius:8px;border:1px solid var(--exec-blue);background:transparent;color:var(--exec-blue);font-size:12px;font-weight:500;cursor:pointer;">✏️ Edit Agent</button>';
                        }
                        body += '</div>';
                    }
                } catch(e) {}
            }

            document.getElementById('detailBody').innerHTML = body;
            
            // Wire up skill management buttons (NEW #1)
            var addSkillBtn = document.getElementById('addSkillBtn');
            if (addSkillBtn && API) {
                addSkillBtn.addEventListener('click', async function() {
                    try {
                        var available = await API.listAvailableSkills();
                        if (!available || available.length === 0) {
                            showToast('No skills found in workspace/skills/');
                            return;
                        }
                        // Show simple dropdown
                        var dropdown = document.createElement('div');
                        dropdown.style.cssText = 'position:absolute;background:var(--bg-secondary);border:1px solid var(--border-medium);border-radius:10px;padding:8px;z-index:999;box-shadow:0 8px 30px rgba(0,0,0,0.12);max-height:200px;overflow-y:auto;';
                        available.forEach(function(skill) {
                            var item = document.createElement('div');
                            item.textContent = skill.name;
                            item.style.cssText = 'padding:6px 12px;cursor:pointer;font-size:13px;border-radius:6px;';
                            item.onmouseover = function() { item.style.background = 'var(--bg-tertiary)'; };
                            item.onmouseout = function() { item.style.background = ''; };
                            item.onclick = async function() {
                                dropdown.remove();
                                // Add skill to agent
                                var currentSkills = (todoData && todoData.skills) ? todoData.skills.slice() : [];
                                currentSkills.push({ name: skill.name, description: skill.description || '', location: skill.location || '' });
                                var result = await API.saveAgentSkills(agentId, currentSkills);
                                if (result && result.success) {
                                    showToast('✅ Skill "' + skill.name + '" added');
                                    await loadLiveAgentData();
                                    openDetailPanel(agentId);
                                } else {
                                    showToast('⚠️ Failed to add skill');
                                }
                            };
                            dropdown.appendChild(item);
                        });
                        addSkillBtn.parentElement.style.position = 'relative';
                        addSkillBtn.parentElement.appendChild(dropdown);
                        // Close on click outside
                        setTimeout(function() {
                            document.addEventListener('click', function closeDropdown(e) {
                                if (!dropdown.contains(e.target)) { dropdown.remove(); document.removeEventListener('click', closeDropdown); }
                            });
                        }, 10);
                    } catch(e) { showToast('Error loading skills'); }
                });
            }
            
            // Wire up skill remove buttons
            document.querySelectorAll('.skill-remove-btn').forEach(function(btn) {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    var skillName = btn.dataset.skillName;
                    if (!API) return;
                    var currentSkills = (todoData && todoData.skills) ? todoData.skills.filter(function(s) { return (s.name || s) !== skillName; }) : [];
                    var result = await API.saveAgentSkills(agentId, currentSkills);
                    if (result && result.success) {
                        showToast('🗑️ Skill "' + skillName + '" removed');
                        await loadLiveAgentData();
                        openDetailPanel(agentId);
                    }
                });
            });
            
            // Wire up Edit Agent button (NEW #4)
            var editBtn = document.getElementById('editAgentBtn');
            if (editBtn && API) {
                editBtn.addEventListener('click', function() {
                    var soulEl = document.getElementById('soulExcerpt');
                    if (!soulEl) return;
                    
                    // Replace soul excerpt with inline editor
                    var editHtml = '<div class="soul-editor" style="display:flex;flex-direction:column;gap:8px;">';
                    editHtml += '<label style="font-size:11px;color:var(--text-tertiary);">Name</label>';
                    editHtml += '<input type="text" id="editName" value="' + (agent.name || '') + '" style="padding:6px 10px;border-radius:8px;border:1px solid var(--border-medium);font-size:13px;background:var(--bg-tertiary);color:var(--text-primary);" />';
                    editHtml += '<label style="font-size:11px;color:var(--text-tertiary);">Role</label>';
                    editHtml += '<input type="text" id="editRole" value="' + (agent.role || '') + '" style="padding:6px 10px;border-radius:8px;border:1px solid var(--border-medium);font-size:13px;background:var(--bg-tertiary);color:var(--text-primary);" />';
                    editHtml += '<label style="font-size:11px;color:var(--text-tertiary);">Traits</label>';
                    editHtml += '<input type="text" id="editTraits" placeholder="e.g. meticulous, strategic" style="padding:6px 10px;border-radius:8px;border:1px solid var(--border-medium);font-size:13px;background:var(--bg-tertiary);color:var(--text-primary);" />';
                    editHtml += '<div style="display:flex;gap:8px;margin-top:4px;">';
                    editHtml += '<button id="saveEditBtn" style="padding:6px 16px;border-radius:8px;border:none;background:var(--exec-blue);color:#fff;font-size:12px;font-weight:500;cursor:pointer;">Save</button>';
                    editHtml += '<button id="cancelEditBtn" style="padding:6px 16px;border-radius:8px;border:1px solid var(--border-medium);background:transparent;color:var(--text-secondary);font-size:12px;cursor:pointer;">Cancel</button>';
                    editHtml += '</div></div>';
                    
                    soulEl.innerHTML = editHtml;
                    editBtn.style.display = 'none';
                    
                    document.getElementById('cancelEditBtn').addEventListener('click', function() {
                        openDetailPanel(agentId);
                    });
                    
                    document.getElementById('saveEditBtn').addEventListener('click', async function() {
                        var name = document.getElementById('editName').value.trim();
                        var role = document.getElementById('editRole').value.trim();
                        var traits = document.getElementById('editTraits').value.trim();
                        var result = await API.saveAgentSoul(agentId, { name: name, role: role, traits: traits });
                        if (result && result.success) {
                            showToast('✅ Agent updated');
                            openDetailPanel(agentId);
                        } else {
                            showToast('⚠️ Failed to save: ' + (result.error || 'unknown'));
                        }
                    });
                });
            }

            detailOverlay.classList.add('open');
            detailClose.focus();
            document.body.style.overflow = 'hidden';
            SoundEngine.whooshOpen();
        }

        function closeDetailPanel() {
            if (detailOverlay.classList.contains('open')) SoundEngine.whooshClose();
            detailOverlay.classList.remove('open');
            document.body.style.overflow = '';
        }

        detailBackdrop.addEventListener('click', closeDetailPanel);
        detailClose.addEventListener('click', closeDetailPanel);

        /* Keep the old openTodoPanel as a wrapper for backwards compat */
        function openTodoPanel(agentId) {
            openDetailPanel(agentId);
        }

        function closeTodoPanel() {
            todoOverlay.classList.remove('open');
            closeDetailPanel();
            document.body.style.overflow = '';
        }

        todoBackdrop.addEventListener('click', closeTodoPanel);
        todoClose.addEventListener('click', closeTodoPanel);

        /* ═══════════════════════════════════════════════
           Meeting Panel — Open / Close
           ═══════════════════════════════════════════════ */

        async function openMeetingPanel() {
            closeTodoPanel(); // Close TODO panel if open
            closeMailbox();   // Close mailbox if open

            // Build meeting content from REAL active subagents (FIX #7)
            var content = '';

            // Active meetings = active sub-agent sessions
            content += '<div class="meeting-section">';
            content += '<div class="meeting-section-title">Active Work Sessions</div>';
            content += '<div class="meeting-list">';
            
            var activeSubagents = [];
            if (API) {
                try {
                    activeSubagents = await API.getActiveSubagents();
                } catch(e) { console.warn('Failed to load active subagents:', e); }
            }
            
            if (activeSubagents && activeSubagents.length > 0) {
                activeSubagents.forEach(function(sa) {
                    var duration = sa.durationMs ? Math.floor(sa.durationMs / 60000) + 'm' : '—';
                    var parentAvatar = sa.parentAgent || 'main';
                    var avatarMap = { forge: 'avatar-forge', atlas: 'avatar-atlas', hunter: 'avatar-hunter', echo: 'avatar-echo', sentinel: 'avatar-sentinel', main: 'avatar-ceo' };
                    var avatarId = avatarMap[parentAvatar] || 'avatar-ceo';
                    
                    content += '<div class="meeting-item meeting-item--active">';
                    content += '<div class="meeting-item-header">';
                    content += '<div class="meeting-item-title">🔴 ' + (sa.label || 'Sub-agent ' + sa.id) + '</div>';
                    content += '<div class="meeting-item-status">' + duration + '</div>';
                    content += '</div>';
                    content += '<div class="meeting-item-description">Active sub-agent under ' + (sa.parentAgent || 'main') + '</div>';
                    content += '<div class="meeting-participants">';
                    content += '<div class="meeting-participant"><svg><use href="#' + avatarId + '"/></svg></div>';
                    content += '</div>';
                    content += '</div>';
                });
            } else {
                content += '<div class="meeting-item" style="opacity:0.6">';
                content += '<div class="meeting-item-header">';
                content += '<div class="meeting-item-title">💤 No active work sessions</div>';
                content += '</div>';
                content += '<div class="meeting-item-description">All sub-agents have completed their tasks.</div>';
                content += '</div>';
            }

            content += '</div>';
            content += '</div>';

            // Recently completed sessions section (from sessions data)
            content += '<div class="meeting-section">';
            content += '<div class="meeting-section-title">Recent</div>';
            content += '<div class="meeting-list">';
            
            if (API) {
                try {
                    var sessions = await API.getSessions();
                    var completed = (sessions.subagents || []).filter(function(sa) { return sa.status === 'completed'; }).slice(0, 4);
                    if (completed.length > 0) {
                        completed.forEach(function(sa) {
                            content += '<div class="meeting-item">';
                            content += '<div class="meeting-item-header">';
                            content += '<div class="meeting-item-title">✅ ' + (sa.name || sa.label || sa.id) + '</div>';
                            content += '<div class="meeting-item-status">Completed</div>';
                            content += '</div>';
                            content += '<div class="meeting-item-description">' + (sa.task || 'Task completed') + '</div>';
                            content += '</div>';
                        });
                    } else {
                        content += '<div class="meeting-item" style="opacity:0.5">';
                        content += '<div class="meeting-item-description">No recently completed sessions</div>';
                        content += '</div>';
                    }
                } catch(e) {
                    content += '<div class="meeting-item"><div class="meeting-item-description">Could not load session data</div></div>';
                }
            }

            meetingContent.innerHTML = content;

            // Show panel
            meetingOverlay.classList.add('open');
            meetingClose.focus();
            document.body.style.overflow = 'hidden';
            SoundEngine.whooshOpen();
        }

        function closeMeetingPanel() {
            if (meetingOverlay.classList.contains('open')) SoundEngine.whooshClose();
            meetingOverlay.classList.remove('open');
            document.body.style.overflow = '';
        }

        meetingBackdrop.addEventListener('click', closeMeetingPanel);
        meetingClose.addEventListener('click', closeMeetingPanel);

        // Close panels on Escape — all overlays
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('spawnOverlay') && document.getElementById('spawnOverlay').classList.contains('open')) {
                    if (window._closeSpawnPanel) window._closeSpawnPanel();
                } else if (document.getElementById('missionsOverlay').classList.contains('open')) {
                    closeMissionsPanel();
                } else if (document.getElementById('settingsOverlay').classList.contains('open')) {
                    closeSettingsPanel();
                } else if (document.getElementById('chatOverlay').classList.contains('open')) {
                    closeChatPanel();
                } else if (document.getElementById('cronOverlay').classList.contains('open')) {
                    closeCronPanel();
                } else if (document.getElementById('memoryOverlay').classList.contains('open')) {
                    closeMemoryPanel();
                } else if (detailOverlay.classList.contains('open')) {
                    closeDetailPanel();
                } else if (todoOverlay.classList.contains('open')) {
                    closeTodoPanel();
                } else if (meetingOverlay.classList.contains('open')) {
                    closeMeetingPanel();
                } else if (mailboxOverlay.classList.contains('open')) {
                    closeMailbox();
                }
            }
        });

        /* ── Update Mailbox Badge ───────────────────── */
        function updateMailboxBadge() {
            var unreadCount = LIVE_MESSAGES.filter(function(msg) { return !msg.read; }).length;
            var badge = document.getElementById('mailboxBadge');
            if (badge) {
                badge.textContent = unreadCount;
                if (unreadCount === 0) {
                    badge.style.opacity = '0.5';
                } else {
                    badge.style.opacity = '1';
                }
            }
            
            // Update mailbox button aria-label
            if (mailboxBtn) {
                var label = 'Open mailbox — ' + unreadCount + ' unread message' + (unreadCount === 1 ? '' : 's');
                mailboxBtn.setAttribute('aria-label', label);
            }
        }

        /* ── Load Live Messages — with priority + dispatch parsing ─── */
        async function loadLiveMessages() {
            if (!window.spawnkitAPI || !await window.spawnkitAPI.isAvailable()) {
                console.log('🏢 [Executive] No live data — showing empty inbox');
                LIVE_MESSAGES = [
                    { sender: 'System', color: '#636366', time: 'Now', text: 'Connect to OpenClaw for live inbox', read: true }
                ];
                renderMessages(LIVE_MESSAGES);
                return;
            }
            
            try {
                var transcript = await window.spawnkitAPI.getTranscript('agent:main:main', 8);
                LIVE_MESSAGES = transcript.map(function(msg, idx) {
                    var text = (msg.text || '').substring(0, 200);
                    var textLower = text.toLowerCase();
                    
                    // FIX #3: Parse priority from message content
                    var priority = 'normal';
                    if (textLower.match(/\b(urgent|critical|bug|hotfix|broken|crash)\b/)) {
                        priority = 'urgent';
                    } else if (textLower.match(/\b(info|update|note|fyi|status)\b/)) {
                        priority = 'info';
                    }
                    
                    // FIX #3: Parse assignedTo from agent mentions
                    var assignedTo = null;
                    var agentMentions = {
                        '@forge': 'Forge (CTO)', '@atlas': 'Atlas (COO)',
                        '@hunter': 'Hunter (CRO)', '@echo': 'Echo (CMO)',
                        '@sentinel': 'Sentinel (QA)',
                        'forge': 'Forge', 'atlas': 'Atlas',
                        'hunter': 'Hunter', 'echo': 'Echo', 'sentinel': 'Sentinel'
                    };
                    for (var mention in agentMentions) {
                        if (mention.startsWith('@') && textLower.includes(mention)) {
                            assignedTo = agentMentions[mention];
                            break;
                        }
                    }
                    // Only check non-@ mentions if no @ mention found
                    if (!assignedTo) {
                        for (var m in agentMentions) {
                            if (!m.startsWith('@') && textLower.match(new RegExp('\\b' + m + '\\b', 'i'))) {
                                assignedTo = agentMentions[m];
                                break;
                            }
                        }
                    }
                    
                    // FIX #6: Mark last 2 messages as unread for badge count
                    var isRecent = idx >= transcript.length - 2;
                    
                    return {
                        sender: msg.role === 'user' ? 'Kira' : 'ApoMac',
                        color: msg.role === 'user' ? '#FF2D55' : '#007AFF',
                        time: msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('en-US', { 
                            hour: '2-digit', minute: '2-digit', hour12: false 
                        }) : 'Now',
                        text: text + (msg.text && msg.text.length > 200 ? '...' : ''),
                        read: !isRecent,
                        priority: priority,
                        assignedTo: assignedTo
                    };
                }).reverse().slice(0, 6);
                
                if (LIVE_MESSAGES.length === 0) {
                    LIVE_MESSAGES = [{ sender: 'System', color: '#636366', time: 'Now', text: 'No recent messages', read: true }];
                }
                
                console.log('🏢 [Executive] Loaded', LIVE_MESSAGES.length, 'live messages');
            } catch (e) {
                console.warn('🏢 [Executive] Failed to load transcript:', e);
                LIVE_MESSAGES = [
                    { sender: 'System', color: '#636366', time: 'Error', text: 'Failed to load messages', read: true }
                ];
            }
            
            renderMessages(LIVE_MESSAGES);
        }

        /* ── Render Messages ────────────────────────── */
        function renderMessages(messages) {
            mailboxMessages.innerHTML = '';
            messages.forEach(function(msg, i) {
                if (i > 0) {
                    var divider = document.createElement('div');
                    divider.className = 'mail-divider';
                    divider.setAttribute('aria-hidden', 'true');
                    mailboxMessages.appendChild(divider);
                }

                var item = document.createElement('div');
                item.className = 'mail-item' + (msg.read ? ' mail-item--read' : '');
                item.dataset.messageIndex = i;

                // Use SVG avatar if available, else fallback to letter
                var avatarId = AVATAR_MAP[msg.sender];
                var avatarContent;
                if (avatarId) {
                    avatarContent = '<svg><use href="#' + avatarId + '"/></svg>';
                } else {
                    avatarContent = (msg.sender || '?').charAt(0);
                }

                var unreadIndicator = msg.read ? '' : '<div class="mail-unread-dot" aria-hidden="true"></div>';

                // Priority flag
                var priorityFlag = '';
                var pri = msg.priority || 'normal';
                if (pri === 'urgent') priorityFlag = '<span class="mail-flag mail-flag--urgent">🔴 Urgent</span>';
                else if (pri === 'info') priorityFlag = '<span class="mail-flag mail-flag--info">🟢 Info</span>';
                else priorityFlag = '<span class="mail-flag mail-flag--normal">🟡 Normal</span>';

                // Dispatch indicator
                var dispatchHtml = '';
                if (msg.assignedTo) {
                    dispatchHtml = '<div class="mail-dispatch"><span>📨</span> <span class="mail-dispatch-arrow">→</span> <strong>' + msg.assignedTo + '</strong></div>';
                }

                item.innerHTML =
                    '<div class="mail-avatar" style="background: ' + msg.color + ';" aria-hidden="true">' + avatarContent + '</div>' +
                    '<div class="mail-content">' +
                        '<div class="mail-header">' +
                            '<span class="mail-sender">' + msg.sender + '</span>' +
                            '<span class="mail-time">' + msg.time + '</span>' +
                        '</div>' +
                        '<div class="mail-preview">' + msg.text + '</div>' +
                        '<div class="mail-flags">' + priorityFlag + '</div>' +
                        dispatchHtml +
                    '</div>' + unreadIndicator;

                // Click to mark as read
                item.addEventListener('click', function() {
                    if (!msg.read) {
                        msg.read = true;
                        item.classList.add('mail-item--read');
                        var dot = item.querySelector('.mail-unread-dot');
                        if (dot) dot.remove();
                        updateMailboxBadge();
                    }
                });

                mailboxMessages.appendChild(item);
            });
            
            updateMailboxBadge();
        }

        // Load live data
        loadLiveMessages();
        loadLiveAgentData();

        /* ═══════════════════════════════════════════════
           Agent Room — Click to Show TODO Panel
           ═══════════════════════════════════════════════ */

        var expandedRoom = null;

        // Handle agent room clicks in both grid and hierarchy views
        document.addEventListener('click', function(e) {
            var agentElement = e.target.closest('[data-agent]');
            if (agentElement) {
                // Don't toggle if clicking mailbox button
                if (e.target.closest('.ceo-mailbox')) return;

                var agentId = agentElement.dataset.agent;
                openTodoPanel(agentId);
                return;
            }

            // Handle meeting room clicks
            var meetingElement = e.target.closest('[data-room="meeting"]');
            if (meetingElement) {
                openMeetingPanel();
                return;
            }

            // Handle detail expansion (legacy behavior for non-agent elements)
            var room = e.target.closest('.exec-room[data-agent]');
            if (room && !e.target.closest('.ceo-mailbox')) {
                var agentId = room.dataset.agent;
                var detail = document.getElementById('detail-' + agentId);
                if (detail) {
                    if (expandedRoom && expandedRoom !== detail) {
                        expandedRoom.classList.remove('visible');
                    }
                    detail.classList.toggle('visible');
                    expandedRoom = detail.classList.contains('visible') ? detail : null;
                }
            }

            // Close detail when clicking outside
            if (!room && expandedRoom) {
                expandedRoom.classList.remove('visible');
                expandedRoom = null;
            }
        });

        // Keyboard: Enter/Space to open TODO panel
        document.querySelectorAll('[data-agent]').forEach(function(element) {
            element.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    var agentId = element.dataset.agent;
                    openTodoPanel(agentId);
                }
            });
        });

        // Keyboard: Enter/Space to open Meeting panel
        document.querySelectorAll('[data-room="meeting"]').forEach(function(element) {
            element.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    openMeetingPanel();
                }
            });
        });

        /* ═══════════════════════════════════════════════
           Command Input — Enter to send via postMessage
           ═══════════════════════════════════════════════ */

        commandInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && commandInput.value.trim()) {
                var cmd = commandInput.value.trim();
                commandInput.value = '';
                SoundEngine.sendSwoosh();
                // Open chat panel and send as mission
                openChatPanel();
                chatInput.value = cmd;
                sendChatMessage();
            }
        });

        /* ═══════════════════════════════════════════════
           postMessage Bridge — Communication with Parent
           ═══════════════════════════════════════════════ */

        window.addEventListener('message', function(e) {
            if (!e.data || typeof e.data !== 'object') return;
            var isSameOrigin = (e.origin === window.location.origin || e.origin === 'null');
            if (!isSameOrigin) return;

            switch (e.data.type) {
                case 'spawnkit:data':
                    handleDataUpdate(e.data.payload);
                    break;

                case 'spawnkit:agents':
                    handleAgentsUpdate(e.data.agents);
                    break;

                case 'spawnkit:messages':
                    handleMessagesUpdate(e.data.messages);
                    break;

                case 'spawnkit:theme':
                    handleThemeChange(e.data.theme);
                    break;

                case 'spawnkit:ping':
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'executive:pong',
                            theme: 'executive',
                            timestamp: Date.now()
                        }, '*');
                    }
                    break;
            }
        });

        /* ── Data Update Handlers ───────────────────── */

        function handleDataUpdate(payload) {
            if (!payload) return;

            if (payload.agents) {
                handleAgentsUpdate(payload.agents);
            }

            if (payload.agents) {
                var count = payload.agents.length;
                document.getElementById('statusAgentCount').textContent = count + ' Agent' + (count !== 1 ? 's' : '');
            }
        }

        var _prevAgentStatuses = {};
        function handleAgentsUpdate(agents) {
            if (!agents || !Array.isArray(agents)) return;

            agents.forEach(function(agent) {
                if (!agent || !agent.name) return;
                var id = agent.name.toLowerCase();

                // Sound on status change
                if (agent.status && _prevAgentStatuses[id] && _prevAgentStatuses[id] !== agent.status) {
                    SoundEngine.ping();
                }
                if (agent.status) _prevAgentStatuses[id] = agent.status;

                // Update in both grid and hierarchy views
                document.querySelectorAll('[data-agent="' + id + '"]').forEach(function(el) {
                    var dot = el.querySelector('.agent-status-dot');
                    if (dot && agent.status) {
                        dot.className = 'agent-status-dot';
                        var statusMap = { active: 'active', working: 'active', building: 'busy', idle: 'idle', error: 'idle' };
                        dot.classList.add('agent-status-dot--' + (statusMap[agent.status] || 'idle'));
                    }
                    
                    // Update agent name to show Agent OS format if available
                    var nameEl = el.querySelector('.agent-name');
                    if (nameEl && agent.role && window.AgentOSNaming) {
                        // Try to construct Agent OS name format for main agents
                        var parentMap = { Hunter: 'Hunter', Forge: 'Forge', Echo: 'Echo', Atlas: 'Atlas', Sentinel: 'Sentinel', ApoMac: 'Main' };
                        var parent = parentMap[agent.name] || agent.name;
                        var roleMap = { CTO: 'CodeBuilder', CRO: 'Researcher', CMO: 'ContentCreator', COO: 'OpsRunner', CEO: 'Coordinator', 'QA & Security': 'Auditor' };
                        var role = roleMap[agent.role] || 'TaskRunner';
                        var agentOSName = parent + '.' + role + '-01';
                        nameEl.textContent = agentOSName;
                        
                        // Add model badge if available
                        if (agent.model && window.ModelIdentity) {
                            var modelIdentity = window.ModelIdentity.getIdentity(agent.model);
                            var badge = el.querySelector('.model-badge') || document.createElement('span');
                            badge.className = 'model-badge';
                            badge.textContent = modelIdentity.level;
                            badge.style.color = modelIdentity.color;
                            badge.style.marginLeft = '6px';
                            badge.style.fontSize = '10px';
                            badge.style.fontWeight = '600';
                            if (!el.querySelector('.model-badge')) {
                                nameEl.appendChild(badge);
                            }
                        }
                    }
                });

                // Update detail if exists
                var detail = document.getElementById('detail-' + id);
                if (detail && agent.currentTask) {
                    var taskEl = detail.querySelectorAll('.agent-detail-value')[1];
                    if (taskEl) taskEl.textContent = agent.currentTask;
                }
            });
        }

        var _prevMessageCount = -1;
        function handleMessagesUpdate(messages) {
            if (!messages || !Array.isArray(messages)) return;
            // Play mail ding if new messages arrived
            if (_prevMessageCount >= 0 && messages.length > _prevMessageCount) {
                SoundEngine.mailDing();
            }
            _prevMessageCount = messages.length;
            renderMessages(messages);
            var badge = document.getElementById('mailboxBadge');
            if (badge) {
                badge.textContent = messages.length;
            }
        }

        function handleThemeChange(theme) {
            // Could apply light/dark mode in future
        }

        /* ═══════════════════════════════════════════════
           Status Bar — Clock & System Status
           ═══════════════════════════════════════════════ */

        function updateClock() {
            var now = new Date();
            var h = now.getHours().toString().padStart(2, '0');
            var m = now.getMinutes().toString().padStart(2, '0');
            var statusEl = document.getElementById('statusSystem');
            if (statusEl) {
                statusEl.textContent = 'All systems nominal • ' + h + ':' + m;
            }
        }

        updateClock();
        setInterval(updateClock, 30000);

        /* ═══════════════════════════════════════════════
           CEO Chat Panel (Feature 2)
           ═══════════════════════════════════════════════ */
        var chatOverlay  = document.getElementById('chatOverlay');
        var chatBackdrop = document.getElementById('chatBackdrop');
        var chatCloseBtn = document.getElementById('chatClose');
        var chatMsgsEl   = document.getElementById('chatMessages');
        var chatInput    = document.getElementById('chatInput');
        var chatSendBtn  = document.getElementById('chatSend');
        var chatEmptyEl  = document.getElementById('chatEmpty');

        function openChatPanel() {
            closeAllPanels();
            chatOverlay.classList.add('open');
            chatInput.focus();
            document.body.style.overflow = 'hidden';
            loadChatTranscript();
            SoundEngine.whooshOpen();
        }
        function closeChatPanel() {
            if (chatOverlay.classList.contains('open')) SoundEngine.whooshClose();
            chatOverlay.classList.remove('open');
            document.body.style.overflow = '';
        }

        document.getElementById('chatBtn').addEventListener('click', openChatPanel);
        chatBackdrop.addEventListener('click', closeChatPanel);
        chatCloseBtn.addEventListener('click', closeChatPanel);

        function loadChatTranscript() {
            if (!API) return;
            try {
                var transcript = API.getTranscript('agent:main:main');
                if (transcript && transcript.length > 0) {
                    chatHistory = transcript.slice(-50).map(function(m) {
                        return {
                            role: m.role === 'user' ? 'user' : 'system',
                            text: m.text || m.content || '',
                            time: m.timestamp ? new Date(m.timestamp).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) : ''
                        };
                    });
                    renderChatMessages();
                }
            } catch(e) { console.warn('Chat transcript load:', e); }
        }

        function renderChatMessages() {
            if (chatHistory.length === 0) {
                chatEmptyEl.style.display = '';
                return;
            }
            chatEmptyEl.style.display = 'none';
            chatMsgsEl.innerHTML = '';
            chatHistory.forEach(function(m) {
                var div = document.createElement('div');
                div.className = 'chat-msg chat-msg--' + m.role;
                var preview = m.text.length > 300 ? m.text.substring(0, 300) + '…' : m.text;
                div.innerHTML = '<div>' + preview.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>' +
                    (m.time ? '<div class="chat-msg-time">' + m.time + '</div>' : '');
                chatMsgsEl.appendChild(div);
            });
            chatMsgsEl.scrollTop = chatMsgsEl.scrollHeight;
        }

        async function sendChatMessage() {
            var text = chatInput.value.trim();
            if (!text) return;
            chatInput.value = '';
            SoundEngine.sendSwoosh();

            var now = new Date();
            var timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
            chatHistory.push({ role: 'user', text: text, time: timeStr });
            renderChatMessages();

            // Determine target from route dropdown (NEW #6)
            var routeDropdown = document.getElementById('chatRouteSelect');
            var targetAgent = routeDropdown ? routeDropdown.value : 'ceo';

            // Send via API — FIX #2: actually check success
            if (API && typeof API.sendMission === 'function') {
                try {
                    var result = await API.sendMission(text, targetAgent);
                    if (result && result.success) {
                        var targetLabel = targetAgent === 'ceo' ? 'CEO inbox' : targetAgent + ' inbox';
                        chatHistory.push({ role: 'system', text: '✅ Mission dispatched to ' + targetLabel, time: timeStr });
                        renderChatMessages();
                    } else {
                        chatHistory.push({ role: 'system', text: '⚠️ Dispatch failed: ' + (result.error || 'Unknown error'), time: timeStr });
                        renderChatMessages();
                    }
                } catch(e) {
                    chatHistory.push({ role: 'system', text: '⚠️ Could not dispatch: ' + e.message, time: timeStr });
                    renderChatMessages();
                }
            } else {
                chatHistory.push({ role: 'system', text: '📡 API not connected — message queued', time: timeStr });
                renderChatMessages();
            }
        }

        chatSendBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); sendChatMessage(); }
        });

        // Auto-refresh chat every 10s when open
        setInterval(function() {
            if (chatOverlay.classList.contains('open')) loadChatTranscript();
        }, 10000);

        /* ═══════════════════════════════════════════════
           Cron / Calendar Panel (Feature 4)
           ═══════════════════════════════════════════════ */
        var cronOverlay = document.getElementById('cronOverlay');
        var cronBackdropEl = document.getElementById('cronBackdrop');
        var cronCloseBtn = document.getElementById('cronClose');
        var cronBody = document.getElementById('cronBody');

        function openCronPanel() {
            closeAllPanels();
            cronOverlay.classList.add('open');
            document.body.style.overflow = 'hidden';
            renderCronJobs();
            SoundEngine.whooshOpen();
        }
        function closeCronPanel() {
            if (cronOverlay.classList.contains('open')) SoundEngine.whooshClose();
            cronOverlay.classList.remove('open');
            document.body.style.overflow = '';
        }

        document.getElementById('cronBtn').addEventListener('click', openCronPanel);
        cronBackdropEl.addEventListener('click', closeCronPanel);
        cronCloseBtn.addEventListener('click', closeCronPanel);

        function humanCron(schedule) {
            if (!schedule) return '—';
            var m = { '*/30 * * * *': 'Every 30 min', '0 * * * *': 'Every hour',
                      '0 9 * * *': 'Daily 9:00', '0 9 * * 1': 'Mon 9:00',
                      '*/5 * * * *': 'Every 5 min', '0 */2 * * *': 'Every 2h',
                      '0 8 * * 1-5': 'Weekdays 8:00' };
            return m[schedule] || schedule;
        }

        function renderCronJobs() {
            var crons = liveCronData;
            if (API && !crons) {
                try { crons = API.getCrons(); } catch(e) {}
            }

            if (!crons || !Array.isArray(crons) || crons.length === 0) {
                cronBody.innerHTML = '<div class="cron-empty">No cron jobs found.' +
                    (API ? '' : '<br><br><em>Connect to OpenClaw to see live crons.</em>') + '</div>';
                return;
            }

            // Group by owner
            var groups = {};
            crons.forEach(function(c) {
                var owner = c.owner || 'System';
                if (!groups[owner]) groups[owner] = [];
                groups[owner].push(c);
            });

            var html = '';
            Object.keys(groups).forEach(function(owner) {
                html += '<div class="cron-group">';
                html += '<div class="cron-group-title">' + owner + '</div>';
                groups[owner].forEach(function(c) {
                    var statusCls = c.status === 'active' ? 'active' : c.status === 'error' ? 'error' : 'paused';
                    var icon = c.status === 'active' ? '⏰' : c.status === 'error' ? '❌' : '⏸️';
                    var nextRun = c.nextRun ? new Date(c.nextRun).toLocaleString('en-GB', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '—';
                    html += '<div class="cron-item">';
                    html += '<span class="cron-item-icon">' + icon + '</span>';
                    html += '<div class="cron-item-info">';
                    html += '<div class="cron-item-name">' + (c.name || c.id || 'Unnamed') + '</div>';
                    html += '<div class="cron-item-schedule">' + humanCron(c.schedule) + '</div>';
                    html += '<div class="cron-item-next">Next: ' + nextRun + '</div>';
                    html += '</div>';
                    html += '<span class="cron-item-status cron-item-status--' + statusCls + '">' + (c.status || 'unknown') + '</span>';
                    html += '<button class="cron-toggle ' + (c.status === 'active' ? 'on' : '') + '" data-cron-id="' + (c.id || '') + '" aria-label="Toggle"></button>';
                    html += '</div>';
                });
                html += '</div>';
            });
            cronBody.innerHTML = html;

            // Toggle click → toast
            cronBody.querySelectorAll('.cron-toggle').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    btn.classList.toggle('on');
                    showToast('Connect to OpenClaw CLI to modify cron jobs');
                });
            });
        }

        /* ═══════════════════════════════════════════════
           Memory View Panel (Feature 5)
           ═══════════════════════════════════════════════ */
        var memoryOverlay = document.getElementById('memoryOverlay');
        var memoryBackdropEl = document.getElementById('memoryBackdrop');
        var memoryCloseBtn = document.getElementById('memoryClose');
        var memoryBody = document.getElementById('memoryBody');

        function openMemoryPanel() {
            closeAllPanels();
            memoryOverlay.classList.add('open');
            document.body.style.overflow = 'hidden';
            renderMemory();
            SoundEngine.whooshOpen();
        }
        function closeMemoryPanel() {
            if (memoryOverlay.classList.contains('open')) SoundEngine.whooshClose();
            memoryOverlay.classList.remove('open');
            document.body.style.overflow = '';
        }

        document.getElementById('memoryBtn').addEventListener('click', openMemoryPanel);
        memoryBackdropEl.addEventListener('click', closeMemoryPanel);
        memoryCloseBtn.addEventListener('click', closeMemoryPanel);

        function renderMarkdown(md) {
            if (!md) return '<em>No content</em>';
            return md
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.+?)`/g, '<code>$1</code>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/\n{2,}/g, '<br><br>')
                .replace(/\n/g, '<br>');
        }

        function renderMemory() {
            var mem = liveMemoryData;
            if (API && !mem) {
                try { mem = API.getMemory(); } catch(e) {}
            }

            if (!mem) {
                memoryBody.innerHTML = '<div class="cron-empty">No memory data available.' +
                    (API ? '' : '<br><br><em>Connect to OpenClaw to see fleet memory.</em>') + '</div>';
                return;
            }

            var html = '';

            // Golden rules — extract 🔴 sections from long-term
            if (mem.longTerm && mem.longTerm.content) {
                var content = mem.longTerm.content;
                var goldenMatch = content.match(/## 🔴[^\n]*\n[\s\S]*?(?=\n## |$)/g);
                if (goldenMatch && goldenMatch.length > 0) {
                    html += '<div class="memory-section">';
                    html += '<div class="memory-section-title">Golden Rules</div>';
                    goldenMatch.forEach(function(rule) {
                        html += '<div class="memory-golden-rules">';
                        html += '<div class="memory-content-md">' + renderMarkdown(rule.trim()) + '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                }

                // Full MEMORY.md
                html += '<div class="memory-section">';
                html += '<div class="memory-section-title">MEMORY.md <span style="font-weight:400;color:var(--text-tertiary);text-transform:none;letter-spacing:0">(' + (mem.longTerm.size ? (mem.longTerm.size / 1024).toFixed(1) + ' KB' : '—') + ')</span></div>';
                html += '<div class="memory-content-md">' + renderMarkdown(content.substring(0, 3000)) + '</div>';
                if (content.length > 3000) {
                    html += '<div style="color:var(--text-tertiary);font-size:11px;margin-top:8px">…truncated (' + content.length + ' chars total)</div>';
                }
                html += '</div>';
            }

            // Daily memory files
            if (mem.daily && mem.daily.length > 0) {
                html += '<div class="memory-section">';
                html += '<div class="memory-section-title">Daily Notes</div>';
                html += '<div class="memory-daily-list">';
                mem.daily.slice(0, 14).forEach(function(d) {
                    html += '<div class="memory-daily-item">';
                    html += '<span class="memory-daily-item-date">' + (d.date || d.name || '—') + '</span>';
                    html += '<span>' + (d.preview || d.description || 'Daily log') + '</span>';
                    html += '<span class="memory-daily-item-size">' + (d.size ? (d.size / 1024).toFixed(1) + ' KB' : '') + '</span>';
                    html += '</div>';
                });
                html += '</div>';
                html += '</div>';
            }

            // Heartbeat state
            if (mem.heartbeat) {
                html += '<div class="memory-section">';
                html += '<div class="memory-section-title">Heartbeat State</div>';
                html += '<div class="memory-content-md"><pre style="font-size:11px;background:var(--bg-tertiary);padding:10px;border-radius:8px;overflow-x:auto">' + JSON.stringify(mem.heartbeat, null, 2).replace(/</g,'&lt;') + '</pre></div>';
                html += '</div>';
            }

            // Read-only label
            html += '<div class="memory-section">';
            html += '<div class="memory-readonly">🔒 Only the CEO can edit memory</div>';
            html += '</div>';

            memoryBody.innerHTML = html;
        }

        /* Toast helper */
        function showToast(msg) {
            var t = document.getElementById('execToast');
            if (!t) return;
            t.textContent = msg;
            t.classList.add('show');
            SoundEngine.chime();
            clearTimeout(t._timer);
            t._timer = setTimeout(function() { t.classList.remove('show'); }, 2500);
        }

        /* Close all panels helper */
        function closeAllPanels() {
            closeMailbox();
            closeTodoPanel();
            closeMeetingPanel();
            closeDetailPanel();
            closeChatPanel();
            closeCronPanel();
            closeMemoryPanel();
        }

        /* ═══════════════════════════════════════════════
           Announce readiness to parent
           ═══════════════════════════════════════════════ */

        if (window.parent !== window) {
            window.parent.postMessage({
                type: 'executive:ready',
                theme: 'executive',
                timestamp: Date.now()
            }, '*');
        }

        /* ═══════════════════════════════════════════════
           Shared scripts compatibility
           ═══════════════════════════════════════════════ */

        window.__EXEC_THEME = 'executive';

        /* ═══════════════════════════════════════════════
           Live Activity Simulation — Makes it feel alive
           ═══════════════════════════════════════════════ */

        var ACTIVITY_VERBS = {
            ceo:      ['Orchestrating', 'Reviewing', 'Synthesizing', 'Delegating', 'Planning'],
            atlas:    ['Coordinating', 'Documenting', 'Syncing', 'Auditing', 'Scheduling'],
            forge:    ['Building', 'Deploying', 'Optimizing', 'Refactoring', 'Testing'],
            hunter:   ['Prospecting', 'Analyzing', 'Pricing', 'Pitching', 'Converting'],
            echo:     ['Crafting', 'Writing', 'Designing', 'Scripting', 'Publishing'],
            sentinel: ['Scanning', 'Auditing', 'Reviewing', 'Monitoring', 'Verifying']
        };

        var ACTIVITY_OBJECTS = {
            ceo:      ['fleet operations', 'quality pipeline', 'revenue strategy', 'sprint goals', 'SS+ roadmap'],
            atlas:    ['workflows', 'FeedCast ops', 'deployment pipeline', 'cron schedules', 'fleet status'],
            forge:    ['security middleware', 'executive dashboard', 'API endpoints', 'live data bridge', 'Hetzner infra'],
            hunter:   ['Stripe payments', 'lead pipeline', 'pricing tiers', 'market segments', 'conversion funnel'],
            echo:     ['TikTok scripts', 'brand story', 'video pipeline', 'landing page copy', 'social content'],
            sentinel: ['codebase', 'fleet deliverables', 'security posture', 'compliance gates', 'deploy artifacts']
        };

        function randomActivity(agentId) {
            var verbs = ACTIVITY_VERBS[agentId] || ACTIVITY_VERBS.ceo;
            var objects = ACTIVITY_OBJECTS[agentId] || ACTIVITY_OBJECTS.ceo;
            return verbs[Math.floor(Math.random() * verbs.length)] + ' ' + objects[Math.floor(Math.random() * objects.length)];
        }

        /* Rotate agent tasks every 15-45 seconds for liveness */
        function simulateActivity() {
            var agentIds = Object.keys(AGENTS);
            var targetId = agentIds[Math.floor(Math.random() * agentIds.length)];
            var newTask = randomActivity(targetId);
            AGENTS[targetId].task = newTask;

            /* Update visible task text in grid view */
            document.querySelectorAll('[data-agent="' + targetId + '"]').forEach(function(el) {
                var taskEl = el.querySelector('.agent-task');
                if (taskEl) {
                    taskEl.style.opacity = '0';
                    setTimeout(function() {
                        taskEl.textContent = newTask;
                        taskEl.style.opacity = '1';
                    }, 200);
                }
            });

            /* Schedule next update — random 15-45s */
            setTimeout(simulateActivity, 15000 + Math.random() * 30000);
        }

        /* Start after 8 seconds */
        setTimeout(simulateActivity, 8000);

        /* ── Uptime Counter in Status Bar ───────────── */
        var startTime = Date.now() - (8 * 3600000 + 23 * 60000); /* Simulate 8h23m uptime */
        function updateUptime() {
            var elapsed = Date.now() - startTime;
            var h = Math.floor(elapsed / 3600000);
            var m = Math.floor((elapsed % 3600000) / 60000);
            var uptimeEl = document.getElementById('statusAgentCount');
            if (uptimeEl) {
                uptimeEl.textContent = '6 Agents • ' + h + 'h' + m.toString().padStart(2, '0') + 'm uptime';
            }
        }
        updateUptime();
        setInterval(updateUptime, 60000);

        // ── SpawnKit Integration for Agent OS Names ─────────────────────
        function handleSubagentsUpdate(subagents) {
            if (!subagents || !Array.isArray(subagents)) return;
            
            // Update existing subagent cards with Agent OS names
            subagents.forEach(function(subagent) {
                if (!subagent.agentOSName) return;
                
                // Find subagent elements and update names
                document.querySelectorAll('.sub-agent-name').forEach(function(el) {
                    // Check if this element matches our subagent (by parent or task context)
                    var card = el.closest('.org-sub-card');
                    if (card && window.AgentOSNaming) {
                        var displayName = window.AgentOSNaming.displayName(subagent.agentOSName, 'full');
                        el.textContent = displayName;
                        
                        // Add model badge if available
                        if (subagent.model && window.ModelIdentity) {
                            var modelIdentity = window.ModelIdentity.getIdentity(subagent.model);
                            var roleEl = card.querySelector('.sub-agent-role');
                            if (roleEl) {
                                roleEl.innerHTML = subagent.task + ' <span class="model-badge" style="color: ' + 
                                    modelIdentity.color + '; font-size: 8px; font-weight: 600;">(' + 
                                    modelIdentity.level + ')</span>';
                            }
                        }
                    }
                });
            });
        }

        // Listen for SpawnKit data updates
        if (window.SpawnKit) {
            SpawnKit.on('data:refresh', function(data) {
                if (data.agents) handleAgentsUpdate(data.agents);
                if (data.subagents) handleSubagentsUpdate(data.subagents);
            });
        }

        // Wire up live data if available
        if (window.SpawnKit && window.SpawnKit.mode === 'live') {
            SpawnKit.on('data:refresh', function(data) {
                if (typeof handleDataUpdate === 'function') handleDataUpdate(data);
            });
            SpawnKit.refresh();
        }

        /* ═══════════════════════════════════════════════
           Missions Panel (NEW #2)
           ═══════════════════════════════════════════════ */
        var missionsOverlay = document.getElementById('missionsOverlay');
        var missionsBackdropEl = document.getElementById('missionsBackdrop');
        var missionsCloseBtn = document.getElementById('missionsClose');
        var missionsBody = document.getElementById('missionsBody');

        function openMissionsPanel() {
            closeAllPanels();
            missionsOverlay.classList.add('open');
            document.body.style.overflow = 'hidden';
            renderMissions();
            SoundEngine.whooshOpen();
        }
        function closeMissionsPanel() {
            if (missionsOverlay.classList.contains('open')) SoundEngine.whooshClose();
            missionsOverlay.classList.remove('open');
            document.body.style.overflow = '';
        }

        document.getElementById('missionsBtn').addEventListener('click', openMissionsPanel);
        missionsBackdropEl.addEventListener('click', closeMissionsPanel);
        missionsCloseBtn.addEventListener('click', closeMissionsPanel);

        async function renderMissions() {
            if (!API) {
                missionsBody.innerHTML = '<div class="cron-empty">Connect to OpenClaw for live missions.</div>';
                return;
            }

            try {
                var sessions = await API.getSessions();
                var subagents = sessions.subagents || [];
                var running = subagents.filter(function(sa) { return sa.status === 'running'; });
                var completed = subagents.filter(function(sa) { return sa.status === 'completed'; }).slice(0, 5);
                var errored = subagents.filter(function(sa) { return sa.status === 'error'; }).slice(0, 3);

                if (running.length === 0 && completed.length === 0) {
                    missionsBody.innerHTML = '<div class="cron-empty">No active missions. All sub-agents have completed.</div>';
                    return;
                }

                var html = '';

                // Active missions
                if (running.length > 0) {
                    html += '<div class="cron-group"><div class="cron-group-title">🔴 Active (' + running.length + ')</div>';
                    running.forEach(function(sa) {
                        var duration = sa.durationMs ? Math.floor(sa.durationMs / 60000) : 0;
                        var progress = sa.progress || 0.5;
                        html += '<div class="cron-item">';
                        html += '<span class="cron-item-icon">🚀</span>';
                        html += '<div class="cron-item-info">';
                        html += '<div class="cron-item-name">' + (sa.name || sa.label || sa.id) + '</div>';
                        html += '<div class="cron-item-schedule">Parent: ' + (sa.parentAgent || 'main') + ' • ' + duration + 'm</div>';
                        html += '<div style="margin-top:4px;height:4px;background:var(--bg-tertiary);border-radius:2px;overflow:hidden;"><div style="width:' + Math.round(progress * 100) + '%;height:100%;background:var(--exec-blue);border-radius:2px;transition:width 0.3s;"></div></div>';
                        html += '</div>';
                        html += '<span class="cron-item-status cron-item-status--active">' + Math.round(progress * 100) + '%</span>';
                        html += '</div>';
                    });
                    html += '</div>';
                }

                // Completed
                if (completed.length > 0) {
                    html += '<div class="cron-group"><div class="cron-group-title">✅ Completed (' + completed.length + ')</div>';
                    completed.forEach(function(sa) {
                        html += '<div class="cron-item" style="opacity:0.7">';
                        html += '<span class="cron-item-icon">✅</span>';
                        html += '<div class="cron-item-info">';
                        html += '<div class="cron-item-name">' + (sa.name || sa.label || sa.id) + '</div>';
                        html += '<div class="cron-item-schedule">Parent: ' + (sa.parentAgent || 'main') + '</div>';
                        html += '</div>';
                        html += '<span class="cron-item-status" style="color:var(--status-active);">Done</span>';
                        html += '</div>';
                    });
                    html += '</div>';
                }

                // Errored
                if (errored.length > 0) {
                    html += '<div class="cron-group"><div class="cron-group-title">❌ Errors (' + errored.length + ')</div>';
                    errored.forEach(function(sa) {
                        html += '<div class="cron-item" style="opacity:0.6">';
                        html += '<span class="cron-item-icon">❌</span>';
                        html += '<div class="cron-item-info">';
                        html += '<div class="cron-item-name">' + (sa.name || sa.label || sa.id) + '</div>';
                        html += '</div>';
                        html += '<span class="cron-item-status cron-item-status--error">Error</span>';
                        html += '</div>';
                    });
                    html += '</div>';
                }

                missionsBody.innerHTML = html;
            } catch(e) {
                missionsBody.innerHTML = '<div class="cron-empty">Error loading missions: ' + e.message + '</div>';
            }
        }

        // Auto-refresh missions every 15s when open
        setInterval(function() {
            if (missionsOverlay.classList.contains('open')) renderMissions();
        }, 15000);

        /* ═══════════════════════════════════════════════
           Settings Panel (NEW #3: API Keys + NEW #5: Mapping)
           ═══════════════════════════════════════════════ */
        var settingsOverlay = document.getElementById('settingsOverlay');
        var settingsBackdropEl = document.getElementById('settingsBackdrop');
        var settingsCloseBtn = document.getElementById('settingsClose');
        var settingsBody = document.getElementById('settingsBody');

        function openSettingsPanel() {
            closeAllPanels();
            settingsOverlay.classList.add('open');
            document.body.style.overflow = 'hidden';
            renderSettings();
            SoundEngine.whooshOpen();
        }
        function closeSettingsPanel() {
            if (settingsOverlay.classList.contains('open')) SoundEngine.whooshClose();
            settingsOverlay.classList.remove('open');
            document.body.style.overflow = '';
        }

        document.getElementById('settingsBtn').addEventListener('click', openSettingsPanel);

        /* ── Sound Toggle Button ──────────────────────── */
        (function() {
            var soundBtn = document.getElementById('soundToggleBtn');
            var soundIcon = document.getElementById('soundToggleIcon');
            var soundLabel = document.getElementById('soundToggleLabel');
            function updateSoundUI() {
                if (SoundEngine.enabled) {
                    soundIcon.textContent = '🔊';
                    soundLabel.textContent = 'Sound';
                    soundBtn.title = 'Sounds on — click to mute';
                } else {
                    soundIcon.textContent = '🔇';
                    soundLabel.textContent = 'Muted';
                    soundBtn.title = 'Sounds muted — click to enable';
                }
            }
            updateSoundUI();
            soundBtn.addEventListener('click', function() {
                var nowEnabled = SoundEngine.toggle();
                updateSoundUI();
                if (nowEnabled) {
                    SoundEngine.click(); // Confirm with a tap sound
                }
            });
        })();
        settingsBackdropEl.addEventListener('click', closeSettingsPanel);
        settingsCloseBtn.addEventListener('click', closeSettingsPanel);

        async function renderSettings() {
            var html = '';

            // API Keys section (NEW #3)
            html += '<div class="cron-group"><div class="cron-group-title">🔑 API Keys</div>';
            
            var providers = ['anthropic', 'openai', 'elevenlabs', 'google'];
            var providerLabels = { anthropic: 'Anthropic', openai: 'OpenAI', elevenlabs: 'ElevenLabs', google: 'Google' };
            var providerPrefixes = { anthropic: 'sk-ant-', openai: 'sk-', elevenlabs: '', google: '' };
            
            var currentKeys = {};
            if (API) {
                try { currentKeys = await API.getApiKeys(); } catch(e) {}
            }

            providers.forEach(function(prov) {
                var info = currentKeys[prov] || {};
                var masked = info.hasKey ? info.masked : 'Not set';
                var hasKey = info.hasKey || false;
                
                html += '<div class="cron-item" style="flex-wrap:wrap;">';
                html += '<div class="cron-item-info" style="flex:1;min-width:150px;">';
                html += '<div class="cron-item-name">' + providerLabels[prov] + '</div>';
                html += '<div class="cron-item-schedule" style="font-family:monospace;font-size:11px;">' + masked + '</div>';
                html += '</div>';
                html += '<div style="display:flex;gap:4px;align-items:center;">';
                html += '<input type="password" id="apikey-' + prov + '" placeholder="' + (providerPrefixes[prov] || '') + '..." style="width:160px;padding:4px 8px;border-radius:6px;border:1px solid var(--border-medium);font-size:11px;font-family:monospace;background:var(--bg-tertiary);color:var(--text-primary);" />';
                html += '<button class="apikey-save-btn" data-provider="' + prov + '" style="padding:4px 10px;border-radius:6px;border:none;background:var(--exec-blue);color:#fff;font-size:11px;cursor:pointer;font-weight:500;">Save</button>';
                if (hasKey) {
                    html += '<button class="apikey-delete-btn" data-provider="' + prov + '" style="padding:4px 8px;border-radius:6px;border:1px solid var(--status-error);background:transparent;color:var(--status-error);font-size:11px;cursor:pointer;">🗑️</button>';
                }
                html += '</div>';
                html += '</div>';
            });
            html += '</div>';

            // OpenClaw ↔ SpawnKit Mapping (NEW #5)
            html += '<div class="cron-group"><div class="cron-group-title">🗺️ OpenClaw ↔ SpawnKit Mapping</div>';
            var mappings = [
                { openclaw: 'Skills', spawnkit: 'Skills Panel', icon: '⚡' },
                { openclaw: 'Cron Jobs', spawnkit: 'Calendar / Crons', icon: '📅' },
                { openclaw: 'Sessions', spawnkit: 'Agents / Rooms', icon: '👥' },
                { openclaw: 'Memory (MEMORY.md)', spawnkit: 'Memory Panel', icon: '🧠' },
                { openclaw: 'Tools', spawnkit: 'Skills (extended)', icon: '🔧' },
                { openclaw: 'Sub-agents', spawnkit: 'Missions / Boardroom', icon: '🎯' },
                { openclaw: 'Workspace', spawnkit: 'Fleet Directory', icon: '📁' }
            ];
            
            html += '<div style="display:grid;grid-template-columns:auto 24px auto;gap:6px 12px;align-items:center;padding:8px 0;">';
            html += '<div style="font-size:10px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px;">OpenClaw</div>';
            html += '<div></div>';
            html += '<div style="font-size:10px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px;">SpawnKit</div>';
            mappings.forEach(function(m) {
                html += '<div style="font-size:13px;padding:4px 0;">' + m.icon + ' ' + m.openclaw + '</div>';
                html += '<div style="font-size:12px;color:var(--exec-blue);text-align:center;">→</div>';
                html += '<div style="font-size:13px;padding:4px 0;color:var(--text-secondary);">' + m.spawnkit + '</div>';
            });
            html += '</div>';
            html += '</div>';

            // Reset Onboarding section
            html += '<div class="cron-group"><div class="cron-group-title">🎓 Onboarding</div>';
            html += '<div class="cron-item">';
            html += '<span class="cron-item-icon">🔄</span>';
            html += '<div class="cron-item-info">';
            html += '<div class="cron-item-name">First-Run Walkthrough</div>';
            html += '<div class="cron-item-schedule">' + (localStorage.getItem('spawnkit-onboarded') === 'true' ? 'Completed ✓' : 'Not completed') + '</div>';
            html += '</div>';
            html += '<button id="resetOnboardingBtn" style="padding:6px 14px;border-radius:8px;border:1px solid var(--border-medium);background:transparent;color:var(--text-secondary);font-size:12px;font-weight:500;cursor:pointer;transition:all 0.2s;">Reset</button>';
            html += '</div>';
            html += '</div>';

            settingsBody.innerHTML = html;

            // Wire up Reset Onboarding button
            var resetOB = document.getElementById('resetOnboardingBtn');
            if (resetOB) {
                resetOB.addEventListener('click', function() {
                    if (typeof window.resetOnboarding === 'function') {
                        window.resetOnboarding();
                    } else {
                        localStorage.removeItem('spawnkit-onboarded');
                        showToast('🔄 Onboarding reset — refresh to replay');
                    }
                });
            }

            // Wire up API key save buttons
            document.querySelectorAll('.apikey-save-btn').forEach(function(btn) {
                btn.addEventListener('click', async function() {
                    var prov = btn.dataset.provider;
                    var input = document.getElementById('apikey-' + prov);
                    var key = input ? input.value.trim() : '';
                    if (!key) { showToast('Please enter an API key'); return; }
                    if (API) {
                        var result = await API.saveApiKey(prov, key);
                        if (result && result.success) {
                            showToast('✅ ' + providerLabels[prov] + ' key saved');
                            input.value = '';
                            renderSettings();
                        } else {
                            showToast('⚠️ Failed: ' + (result.error || 'unknown'));
                        }
                    }
                });
            });

            // Wire up API key delete buttons
            document.querySelectorAll('.apikey-delete-btn').forEach(function(btn) {
                btn.addEventListener('click', async function() {
                    var prov = btn.dataset.provider;
                    if (API) {
                        var result = await API.deleteApiKey(prov);
                        if (result && result.success) {
                            showToast('🗑️ ' + providerLabels[prov] + ' key deleted');
                            renderSettings();
                        }
                    }
                });
            });
        }

        /* ═══════════════════════════════════════════════
           Decommission Animation (NEW #7)
           ═══════════════════════════════════════════════ */
        var previousSubagentIds = new Set();
        
        function checkForDecommissions() {
            if (!API) return;
            API.getSessions().then(function(sessions) {
                var currentIds = new Set((sessions.subagents || []).filter(function(sa) { return sa.status === 'running'; }).map(function(sa) { return sa.id; }));
                
                // Find decommissioned (was running, now gone)
                previousSubagentIds.forEach(function(oldId) {
                    if (!currentIds.has(oldId)) {
                        // Find the name from previous data
                        var sa = (sessions.subagents || []).find(function(s) { return s.id === oldId; });
                        var name = sa ? (sa.name || sa.label || oldId) : oldId;
                        triggerDecommission(name);
                    }
                });
                
                previousSubagentIds = currentIds;
            }).catch(function() {});
        }
        
        function triggerDecommission(agentName) {
            // Dramatic decommission sound
            SoundEngine.decommission();
            // Show toast
            showToast('🔥 ' + agentName + ' decommissioned');
            
            // Find and animate any matching org-sub-card
            document.querySelectorAll('.org-sub-card').forEach(function(card) {
                var nameEl = card.querySelector('.sub-agent-name');
                if (nameEl && nameEl.textContent.toLowerCase().includes(agentName.toLowerCase().split('-')[0])) {
                    card.classList.add('decommission-anim');
                    
                    // Add particles
                    var rect = card.getBoundingClientRect();
                    for (var p = 0; p < 8; p++) {
                        var particle = document.createElement('div');
                        particle.className = 'decommission-particle';
                        particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
                        particle.style.top = (rect.top + Math.random() * rect.height) + 'px';
                        particle.style.animationDelay = (Math.random() * 200) + 'ms';
                        document.body.appendChild(particle);
                        setTimeout(function() { particle.remove(); }, 800);
                    }
                    
                    // Remove card after animation
                    setTimeout(function() { card.remove(); }, 800);
                }
            });
        }
        
        // Check for decommissions every 10s
        setInterval(checkForDecommissions, 10000);
        // Initialize the set
        if (API) {
            API.getSessions().then(function(sessions) {
                (sessions.subagents || []).filter(function(sa) { return sa.status === 'running'; }).forEach(function(sa) {
                    previousSubagentIds.add(sa.id);
                });
            }).catch(function() {});
        }

        /* ═══════════════════════════════════════════════
           Update meeting room preview on load (FIX #7)
           ═══════════════════════════════════════════════ */
        async function updateMeetingPreview() {
            var preview = document.getElementById('meetingPreview');
            var count = document.getElementById('meetingCount');
            if (!preview || !API) return;
            
            try {
                var active = await API.getActiveSubagents();
                if (active && active.length > 0) {
                    if (count) count.textContent = active.length;
                    preview.innerHTML = active.slice(0, 2).map(function(sa) {
                        return '<div class="meeting-active">🔴 ' + (sa.label || 'sub-agent') + '</div>';
                    }).join('');
                    if (active.length > 2) {
                        preview.innerHTML += '<div class="meeting-active" style="opacity:0.6">+' + (active.length - 2) + ' more</div>';
                    }
                } else {
                    if (count) count.textContent = '0';
                    preview.innerHTML = '<div class="meeting-active" style="opacity:0.5">💤 No active sessions</div>';
                }
            } catch(e) {
                preview.innerHTML = '<div class="meeting-active" style="opacity:0.5">—</div>';
            }
        }
        updateMeetingPreview();
        setInterval(updateMeetingPreview, 15000);

        /* Update closeAllPanels to include new panels */
        var _origCloseAll = closeAllPanels;
        closeAllPanels = function() {
            _origCloseAll();
            closeMissionsPanel();
            closeSettingsPanel();
        };

        /* ═══════════════════════════════════════════════
           Sound Hooks — Button Clicks & Hover (Delegated)
           ═══════════════════════════════════════════════ */

        // Click sound on all statusbar buttons, card clicks, and interactive elements
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('button, .statusbar-action, .view-toggle-btn, .exec-room, .org-card, .mail-item, .cron-toggle, .detail-skill-chip');
            if (btn && !e.target.closest('#soundToggleBtn')) {
                SoundEngine.click();
            }
        }, true); // capture phase so it fires before handlers

        // Hover tick on statusbar actions and agent cards
        var _lastHoverTick = 0;
        document.addEventListener('mouseenter', function(e) {
            var el = e.target.closest('.statusbar-action, .exec-room, .org-card, .view-toggle-btn, .mail-item');
            if (el) {
                var now = Date.now();
                if (now - _lastHoverTick > 80) { // Throttle to avoid machine-gun ticks
                    SoundEngine.tick();
                    _lastHoverTick = now;
                }
            }
        }, true);

        // Start ambient hum after first user interaction (AudioContext policy)
        var _ambientStarted = false;
        document.addEventListener('click', function() {
            if (!_ambientStarted && SoundEngine.enabled) {
                _ambientStarted = true;
                setTimeout(function() { SoundEngine.startAmbient(); }, 2000);
            }
        }, { once: true });

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof SpawnKitUX !== 'undefined') {
                SpawnKitUX.init({ theme: 'executive' });
            }
            if (typeof OpenClawHelpers !== 'undefined') {
                OpenClawHelpers.init({ theme: 'executive' });
            }
            if (typeof initThemeSwitcher === 'function') {
                initThemeSwitcher();
            }
            if (typeof SpawnKitUX !== 'undefined') {
                SpawnKitUX.ready();
            }
        });

        /* ═══════════════════════════════════════════════
           Spawn Agent System (OBJ4)
           ═══════════════════════════════════════════════ */
        (function initSpawnSystem() {
            var STORAGE_KEY = 'spawnkit-custom-agents';

            // Available character avatars
            var CHARACTERS = [
                { id: 'avatar-ceo', label: 'CEO', color: '#007AFF' },
                { id: 'avatar-atlas', label: 'Atlas', color: '#BF5AF2' },
                { id: 'avatar-forge', label: 'Forge', color: '#FF9F0A' },
                { id: 'avatar-hunter', label: 'Hunter', color: '#FF453A' },
                { id: 'avatar-echo', label: 'Echo', color: '#0A84FF' },
                { id: 'avatar-sentinel', label: 'Sentinel', color: '#30D158' },
                { id: 'avatar-spark', label: 'Spark', color: '#5856D6' },
                { id: 'avatar-nova', label: 'Nova', color: '#FF6B9D' },
                { id: 'avatar-bolt', label: 'Bolt', color: '#FFD60A' },
                { id: 'avatar-pixel', label: 'Pixel', color: '#64D2FF' },
                { id: 'avatar-cipher', label: 'Cipher', color: '#1C3A1C' },
                { id: 'avatar-flux', label: 'Flux', color: '#AF52DE' }
            ];

            // Available skills for multi-select
            var AVAILABLE_SKILLS = [
                '🛠️ Engineering', '📊 Analytics', '✍️ Writing', '🎨 Design',
                '🔍 Research', '📈 Growth', '🛡️ Security', '⚙️ Operations',
                '📱 Content', '💰 Sales', '🔄 Automation', '📋 Documentation',
                '🧪 Testing', '🎯 Strategy', '🔮 Forecasting', '🤖 AI/ML'
            ];

            // DOM refs
            var spawnOverlay = document.getElementById('spawnOverlay');
            var spawnBackdrop = document.getElementById('spawnBackdrop');
            var spawnCloseBtn = document.getElementById('spawnClose');
            var spawnCard = document.getElementById('spawnAgentCard');
            var spawnBody = document.getElementById('spawnBody');
            var spawnCharGrid = document.getElementById('spawnCharGrid');
            var spawnSkillsGrid = document.getElementById('spawnSkillsGrid');
            var spawnPrevBtn = document.getElementById('spawnPrevBtn');
            var spawnNextBtn = document.getElementById('spawnNextBtn');
            var spawnSteps = document.getElementById('spawnSteps');

            // State
            var currentSpawnStep = 1;
            var spawnData = {
                characterId: null,
                characterColor: null,
                name: '',
                role: '',
                traits: [],
                skills: [],
                soul: ''
            };

            // ── Load custom agents from localStorage ──
            function loadCustomAgents() {
                try {
                    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                } catch(e) { return []; }
            }

            function saveCustomAgents(agents) {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(agents));
                } catch(e) { console.warn('Failed to save custom agents:', e); }
            }

            // ── Populate character grid ──
            function buildCharGrid() {
                spawnCharGrid.innerHTML = '';
                CHARACTERS.forEach(function(ch) {
                    var opt = document.createElement('div');
                    opt.className = 'spawn-char-option';
                    opt.setAttribute('role', 'radio');
                    opt.setAttribute('aria-checked', 'false');
                    opt.setAttribute('aria-label', ch.label + ' character');
                    opt.setAttribute('tabindex', '0');
                    opt.dataset.charId = ch.id;
                    opt.dataset.charColor = ch.color;
                    opt.innerHTML =
                        '<div class="spawn-char-avatar"><svg><use href="#' + ch.id + '"/></svg></div>' +
                        '<div class="spawn-char-name">' + ch.label + '</div>';
                    opt.addEventListener('click', function() { selectCharacter(opt, ch); });
                    opt.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectCharacter(opt, ch); }
                    });
                    spawnCharGrid.appendChild(opt);
                });
            }

            function selectCharacter(el, ch) {
                spawnCharGrid.querySelectorAll('.spawn-char-option').forEach(function(o) {
                    o.classList.remove('selected');
                    o.setAttribute('aria-checked', 'false');
                });
                el.classList.add('selected');
                el.setAttribute('aria-checked', 'true');
                spawnData.characterId = ch.id;
                spawnData.characterColor = ch.color;
                SoundEngine.click();
                updateNavButtons();
            }

            // ── Populate skills grid ──
            function buildSkillsGrid() {
                spawnSkillsGrid.innerHTML = '';
                AVAILABLE_SKILLS.forEach(function(skill) {
                    var opt = document.createElement('div');
                    opt.className = 'spawn-skill-option';
                    opt.setAttribute('role', 'checkbox');
                    opt.setAttribute('aria-checked', 'false');
                    opt.setAttribute('tabindex', '0');
                    opt.textContent = skill;
                    opt.addEventListener('click', function() { toggleSkill(opt, skill); });
                    opt.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSkill(opt, skill); }
                    });
                    spawnSkillsGrid.appendChild(opt);
                });
            }

            function toggleSkill(el, skill) {
                el.classList.toggle('selected');
                var isSelected = el.classList.contains('selected');
                el.setAttribute('aria-checked', isSelected ? 'true' : 'false');
                if (isSelected) {
                    if (spawnData.skills.indexOf(skill) === -1) spawnData.skills.push(skill);
                } else {
                    spawnData.skills = spawnData.skills.filter(function(s) { return s !== skill; });
                }
                SoundEngine.tick();
            }

            // ── Traits tag input ──
            var traitsInput = document.getElementById('spawnTraitsInput');
            var traitsContainer = document.getElementById('spawnTraitsContainer');

            if (traitsInput && traitsContainer) {
                traitsContainer.addEventListener('click', function() { traitsInput.focus(); });
                traitsInput.addEventListener('keydown', function(e) {
                    if ((e.key === 'Enter' || e.key === ',') && traitsInput.value.trim()) {
                        e.preventDefault();
                        addTrait(traitsInput.value.trim().replace(/,/g, ''));
                        traitsInput.value = '';
                    }
                    if (e.key === 'Backspace' && !traitsInput.value && spawnData.traits.length > 0) {
                        removeTrait(spawnData.traits.length - 1);
                    }
                });
            }

            function addTrait(text) {
                if (spawnData.traits.length >= 8) return;
                if (spawnData.traits.indexOf(text) !== -1) return;
                spawnData.traits.push(text);
                renderTraits();
                SoundEngine.tick();
            }

            function removeTrait(idx) {
                spawnData.traits.splice(idx, 1);
                renderTraits();
            }

            function renderTraits() {
                var tags = traitsContainer.querySelectorAll('.spawn-trait-tag');
                tags.forEach(function(t) { t.remove(); });
                spawnData.traits.forEach(function(trait, idx) {
                    var tag = document.createElement('span');
                    tag.className = 'spawn-trait-tag';
                    tag.innerHTML = trait + '<button aria-label="Remove ' + trait + '">×</button>';
                    tag.querySelector('button').addEventListener('click', function(e) {
                        e.stopPropagation();
                        removeTrait(idx);
                    });
                    traitsContainer.insertBefore(tag, traitsInput);
                });
            }

            // ── Step navigation ──
            function showSpawnStep(step) {
                currentSpawnStep = step;
                // Update step indicators
                spawnSteps.querySelectorAll('.spawn-step-indicator').forEach(function(ind) {
                    var s = parseInt(ind.dataset.step);
                    ind.classList.remove('active', 'done');
                    if (s === step) ind.classList.add('active');
                    else if (s < step) ind.classList.add('done');
                });
                spawnSteps.querySelectorAll('.spawn-step-divider').forEach(function(div, i) {
                    div.classList.toggle('done', (i + 1) < step);
                });
                // Show content
                document.querySelectorAll('.spawn-step-content').forEach(function(el) {
                    el.classList.remove('active');
                });
                var stepEl = document.getElementById('spawnStep' + step);
                if (stepEl) stepEl.classList.add('active');

                // Build review on step 3
                if (step === 3) buildReview();

                updateNavButtons();
            }

            function updateNavButtons() {
                spawnPrevBtn.style.visibility = currentSpawnStep === 1 ? 'hidden' : 'visible';
                if (currentSpawnStep === 3) {
                    spawnNextBtn.textContent = '🚀 Deploy Agent';
                    spawnNextBtn.className = 'spawn-btn spawn-btn--deploy';
                    spawnNextBtn.disabled = false;
                } else if (currentSpawnStep === 2) {
                    spawnNextBtn.textContent = 'Review →';
                    spawnNextBtn.className = 'spawn-btn spawn-btn--primary';
                    // Require at least name and role
                    var nameVal = document.getElementById('spawnName').value.trim();
                    var roleVal = document.getElementById('spawnRole').value.trim();
                    spawnNextBtn.disabled = !nameVal || !roleVal;
                } else {
                    spawnNextBtn.textContent = 'Next →';
                    spawnNextBtn.className = 'spawn-btn spawn-btn--primary';
                    spawnNextBtn.disabled = !spawnData.characterId;
                }
            }

            // Wire up input listeners for step 2 validation
            ['spawnName', 'spawnRole'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', function() {
                        if (currentSpawnStep === 2) updateNavButtons();
                    });
                }
            });

            spawnNextBtn.addEventListener('click', function() {
                if (spawnNextBtn.disabled) return;
                if (currentSpawnStep === 1) {
                    showSpawnStep(2);
                } else if (currentSpawnStep === 2) {
                    // Gather data from form
                    spawnData.name = document.getElementById('spawnName').value.trim();
                    spawnData.role = document.getElementById('spawnRole').value.trim();
                    spawnData.soul = document.getElementById('spawnSoul').value.trim();
                    showSpawnStep(3);
                } else if (currentSpawnStep === 3) {
                    deployAgent();
                }
                SoundEngine.click();
            });

            spawnPrevBtn.addEventListener('click', function() {
                if (currentSpawnStep > 1) {
                    showSpawnStep(currentSpawnStep - 1);
                    SoundEngine.click();
                }
            });

            // ── Build Review ──
            function buildReview() {
                var review = document.getElementById('spawnReview');
                var html = '<div class="spawn-review-card">';
                html += '<div class="spawn-review-header">';
                if (spawnData.characterId) {
                    html += '<div class="spawn-review-avatar"><svg><use href="#' + spawnData.characterId + '"/></svg></div>';
                }
                html += '<div>';
                html += '<div class="spawn-review-name">' + (spawnData.name || 'Unnamed') + '</div>';
                html += '<div class="spawn-review-role">' + (spawnData.role || 'No role') + '</div>';
                html += '</div>';
                html += '</div>';

                // Traits
                if (spawnData.traits.length > 0) {
                    html += '<div class="spawn-review-row">';
                    html += '<span class="spawn-review-label">Traits</span>';
                    html += '<div class="spawn-review-traits">';
                    spawnData.traits.forEach(function(t) {
                        html += '<span class="spawn-review-trait">' + t + '</span>';
                    });
                    html += '</div></div>';
                }

                // Skills
                if (spawnData.skills.length > 0) {
                    html += '<div class="spawn-review-row">';
                    html += '<span class="spawn-review-label">Skills</span>';
                    html += '<span class="spawn-review-value">' + spawnData.skills.join(', ') + '</span>';
                    html += '</div>';
                }

                // SOUL
                if (spawnData.soul) {
                    html += '<div class="spawn-review-row" style="flex-direction:column;gap:6px;">';
                    html += '<span class="spawn-review-label">SOUL</span>';
                    html += '<span class="spawn-review-value" style="max-width:100%;text-align:left;font-size:12px;color:var(--text-secondary);line-height:1.5;white-space:pre-wrap;">' + spawnData.soul.substring(0, 300).replace(/</g,'&lt;') + (spawnData.soul.length > 300 ? '…' : '') + '</span>';
                    html += '</div>';
                }

                html += '</div>';
                review.innerHTML = html;
            }

            // ── Deploy Agent ──
            function deployAgent() {
                var agentId = 'custom-' + Date.now();
                var newAgent = {
                    id: agentId,
                    name: spawnData.name,
                    role: spawnData.role,
                    characterId: spawnData.characterId,
                    characterColor: spawnData.characterColor,
                    traits: spawnData.traits.slice(),
                    skills: spawnData.skills.slice(),
                    soul: spawnData.soul,
                    status: 'active',
                    task: 'Initializing...',
                    createdAt: new Date().toISOString()
                };

                // Save to localStorage
                var agents = loadCustomAgents();
                agents.push(newAgent);
                saveCustomAgents(agents);

                // Register in AGENTS map
                AGENTS[agentId] = {
                    name: newAgent.name,
                    role: newAgent.role,
                    color: newAgent.characterColor,
                    status: 'active',
                    task: 'Ready for assignments',
                    isCustom: true
                };

                // Add to grid
                addAgentToGrid(newAgent, true);
                // Add to hierarchy
                addAgentToHierarchy(newAgent);

                // Update status bar count
                var totalAgents = 6 + loadCustomAgents().length;
                var uptimeEl = document.getElementById('statusAgentCount');
                if (uptimeEl) {
                    uptimeEl.textContent = totalAgents + ' Agents';
                }

                // Close panel
                closeSpawnPanel();

                // Show deploy toast
                showToast('🚀 ' + newAgent.name + ' has joined the team!');
                SoundEngine.chime();
            }

            // ── Add agent to grid view ──
            function addAgentToGrid(agent, animate) {
                var room = document.createElement('div');
                room.className = 'exec-room exec-room--custom' + (animate ? ' deploy-anim' : '');
                room.setAttribute('role', 'button');
                room.setAttribute('tabindex', '0');
                room.setAttribute('aria-label', agent.name + ' — ' + agent.role);
                room.dataset.agent = agent.id;

                room.innerHTML =
                    '<span class="exec-room-label">' + agent.name + '</span>' +
                    '<div class="agent-avatar" aria-hidden="true">' +
                        '<svg><use href="#' + agent.characterId + '"/></svg>' +
                        '<span class="agent-status-dot agent-status-dot--active" aria-label="Active"></span>' +
                    '</div>' +
                    '<span class="agent-name">' + agent.name + '</span>' +
                    '<span class="agent-role">' + agent.role + '</span>' +
                    '<button class="custom-decommission" aria-label="Decommission ' + agent.name + '" data-custom-id="' + agent.id + '" title="Decommission">🔥</button>';

                // Insert before the spawn card
                var spawnCardEl = document.getElementById('spawnAgentCard');
                if (spawnCardEl) {
                    gridView.insertBefore(room, spawnCardEl);
                } else {
                    gridView.appendChild(room);
                }

                // Click to open detail
                room.addEventListener('click', function(e) {
                    if (e.target.closest('.custom-decommission')) return;
                    openDetailPanel(agent.id);
                });
                room.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openDetailPanel(agent.id); }
                });

                // Decommission button
                room.querySelector('.custom-decommission').addEventListener('click', function(e) {
                    e.stopPropagation();
                    decommissionCustomAgent(agent.id, room);
                });

                // Pulse animation
                if (animate) {
                    setTimeout(function() { room.classList.add('deploy-pulse'); }, 600);
                    setTimeout(function() { room.classList.remove('deploy-anim', 'deploy-pulse'); }, 1400);
                }

                // Adjust grid layout for extra rows
                adjustGridLayout();
            }

            // ── Add agent to hierarchy view ──
            function addAgentToHierarchy(agent) {
                var orgChildren = hierarchyView.querySelector('.org-children');
                if (!orgChildren) return;

                var child = document.createElement('div');
                child.className = 'org-child';
                child.dataset.customAgent = agent.id;
                child.innerHTML =
                    '<div class="org-connector--branch"></div>' +
                    '<div class="org-card" data-agent="' + agent.id + '" tabindex="0" role="button" aria-label="' + agent.name + ' — ' + agent.role + '">' +
                        '<div class="agent-avatar" aria-hidden="true">' +
                            '<svg><use href="#' + agent.characterId + '"/></svg>' +
                            '<span class="agent-status-dot agent-status-dot--active"></span>' +
                        '</div>' +
                        '<div class="org-card-info">' +
                            '<span class="agent-name">' + agent.name + '</span>' +
                            '<span class="agent-role">' + agent.role + '</span>' +
                        '</div>' +
                    '</div>';

                orgChildren.appendChild(child);

                // Click handler
                child.querySelector('.org-card').addEventListener('click', function() {
                    openDetailPanel(agent.id);
                });
            }

            // ── Decommission custom agent ──
            function decommissionCustomAgent(agentId, roomEl) {
                // Animate
                SoundEngine.decommission();
                if (roomEl) {
                    roomEl.classList.add('decommission-anim');
                    // Particles
                    var rect = roomEl.getBoundingClientRect();
                    for (var p = 0; p < 8; p++) {
                        var particle = document.createElement('div');
                        particle.className = 'decommission-particle';
                        particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
                        particle.style.top = (rect.top + Math.random() * rect.height) + 'px';
                        particle.style.animationDelay = (Math.random() * 200) + 'ms';
                        document.body.appendChild(particle);
                        setTimeout(function() { particle.remove(); }, 800);
                    }
                }

                // Remove from localStorage
                var agents = loadCustomAgents();
                var agent = agents.find(function(a) { return a.id === agentId; });
                agents = agents.filter(function(a) { return a.id !== agentId; });
                saveCustomAgents(agents);

                // Remove from AGENTS
                delete AGENTS[agentId];

                // Remove from grid after animation
                setTimeout(function() {
                    if (roomEl) roomEl.remove();
                    // Remove from hierarchy
                    var hierEl = hierarchyView.querySelector('[data-custom-agent="' + agentId + '"]');
                    if (hierEl) hierEl.remove();
                    adjustGridLayout();
                    // Update count
                    var totalAgents = 6 + loadCustomAgents().length;
                    var uptimeEl = document.getElementById('statusAgentCount');
                    if (uptimeEl) uptimeEl.textContent = totalAgents + ' Agents';
                }, 800);

                showToast('🔥 ' + (agent ? agent.name : 'Agent') + ' decommissioned');
            }

            // ── Adjust grid to accommodate extra agents ──
            function adjustGridLayout() {
                var customAgents = loadCustomAgents();
                var totalRooms = 7 + customAgents.length; // 6 agents + meeting + custom + spawn
                var floor = document.getElementById('gridView');
                if (totalRooms > 8) {
                    floor.style.gridTemplateRows = '1fr ' + 'repeat(' + Math.ceil((totalRooms - 1) / 3) + ', 1fr)';
                } else {
                    floor.style.gridTemplateRows = '';
                }
            }

            // ── Open / Close Spawn Panel ──
            function openSpawnPanel() {
                closeAllPanels();
                // Reset state
                currentSpawnStep = 1;
                spawnData = { characterId: null, characterColor: null, name: '', role: '', traits: [], skills: [], soul: '' };
                // Reset UI
                showSpawnStep(1);
                buildCharGrid();
                buildSkillsGrid();
                // Clear form fields
                var nameEl = document.getElementById('spawnName');
                var roleEl = document.getElementById('spawnRole');
                var soulEl = document.getElementById('spawnSoul');
                if (nameEl) nameEl.value = '';
                if (roleEl) roleEl.value = '';
                if (soulEl) soulEl.value = '';
                // Clear traits
                spawnData.traits = [];
                renderTraits();

                spawnOverlay.classList.add('open');
                document.body.style.overflow = 'hidden';
                SoundEngine.whooshOpen();
            }

            function closeSpawnPanel() {
                if (spawnOverlay.classList.contains('open')) SoundEngine.whooshClose();
                spawnOverlay.classList.remove('open');
                document.body.style.overflow = '';
            }

            // ── Wire up events ──
            spawnCard.addEventListener('click', openSpawnPanel);
            spawnCard.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openSpawnPanel(); }
            });
            spawnBackdrop.addEventListener('click', closeSpawnPanel);
            spawnCloseBtn.addEventListener('click', closeSpawnPanel);

            // ── Escape key ──
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && spawnOverlay.classList.contains('open')) {
                    closeSpawnPanel();
                    e.stopPropagation();
                }
            });

            // ── Register custom agents' data for detail panel ──
            function registerCustomAgentData(agent) {
                AGENTS[agent.id] = {
                    name: agent.name,
                    role: agent.role,
                    color: agent.characterColor,
                    status: 'active',
                    task: 'Ready for assignments',
                    isCustom: true
                };

                // Add to AVATAR_MAP
                AVATAR_MAP[agent.name] = agent.characterId;

                // Add to LIVE_AGENT_DATA for detail panel
                LIVE_AGENT_DATA[agent.id] = {
                    currentTask: 'Ready for assignments',
                    todos: [],
                    skills: (agent.skills || []).map(function(s, idx) {
                        return { name: s, percentage: 80, description: '' };
                    })
                };
            }

            // ── Load existing custom agents on page load ──
            function loadExistingCustomAgents() {
                var agents = loadCustomAgents();
                agents.forEach(function(agent) {
                    registerCustomAgentData(agent);
                    addAgentToGrid(agent, false);
                    addAgentToHierarchy(agent);
                });
                if (agents.length > 0) {
                    var totalAgents = 6 + agents.length;
                    var uptimeEl = document.getElementById('statusAgentCount');
                    if (uptimeEl) uptimeEl.textContent = totalAgents + ' Agents';
                }
            }

            // Override deployAgent to also register data
            var origDeploy = deployAgent;
            deployAgent = function() {
                var agentId = 'custom-' + Date.now();
                var newAgent = {
                    id: agentId,
                    name: spawnData.name,
                    role: spawnData.role,
                    characterId: spawnData.characterId,
                    characterColor: spawnData.characterColor,
                    traits: spawnData.traits.slice(),
                    skills: spawnData.skills.slice(),
                    soul: spawnData.soul,
                    status: 'active',
                    task: 'Initializing...',
                    createdAt: new Date().toISOString()
                };

                var agents = loadCustomAgents();
                agents.push(newAgent);
                saveCustomAgents(agents);

                registerCustomAgentData(newAgent);
                addAgentToGrid(newAgent, true);
                addAgentToHierarchy(newAgent);

                var totalAgents = 6 + loadCustomAgents().length;
                var uptimeEl = document.getElementById('statusAgentCount');
                if (uptimeEl) uptimeEl.textContent = totalAgents + ' Agents';

                closeSpawnPanel();
                showToast('🚀 ' + newAgent.name + ' has joined the team!');
                SoundEngine.chime();
            };

            // Expose closeSpawnPanel for closeAllPanels
            window._closeSpawnPanel = closeSpawnPanel;

            // ── Initialize ──
            buildCharGrid();
            buildSkillsGrid();
            loadExistingCustomAgents();

        })();

        // Update closeAllPanels to include spawn panel
        var _origCloseAll2 = closeAllPanels;
        closeAllPanels = function() {
            _origCloseAll2();
            if (window._closeSpawnPanel) window._closeSpawnPanel();
        };

        /* ═══════════════════════════════════════════════
           Edit Agent Enhancement in Detail Panel
           ═══════════════════════════════════════════════ */
        (function enhanceDetailPanelEdit() {
            // Monkey-patch the openDetailPanel to add edit section for custom agents
            var origOpenDetail = openDetailPanel;
            openDetailPanel = async function(agentId) {
                await origOpenDetail(agentId);

                // Check if this is a custom agent
                var customAgents = [];
                try { customAgents = JSON.parse(localStorage.getItem('spawnkit-custom-agents') || '[]'); } catch(e) {}
                var customAgent = customAgents.find(function(a) { return a.id === agentId; });

                if (!customAgent) return; // Not a custom agent, skip

                var body = document.getElementById('detailBody');
                if (!body) return;

                // Add Edit Agent section at the top of body
                var editSection = document.createElement('div');
                editSection.className = 'detail-section';
                editSection.style.borderBottom = '1px solid var(--border-subtle)';
                editSection.innerHTML =
                    '<div class="detail-section-title">Edit Agent</div>' +
                    '<div style="display:flex;flex-direction:column;gap:10px;" id="customEditForm">' +
                        '<div style="display:flex;gap:8px;">' +
                            '<div style="flex:1;"><label style="font-size:11px;color:var(--text-tertiary);display:block;margin-bottom:4px;">Name</label>' +
                            '<input type="text" id="editCustomName" value="' + (customAgent.name || '').replace(/"/g,'&quot;') + '" style="width:100%;padding:6px 10px;border-radius:8px;border:1px solid var(--border-medium);font-size:13px;background:var(--bg-tertiary);color:var(--text-primary);font-family:var(--font-family);" /></div>' +
                            '<div style="flex:1;"><label style="font-size:11px;color:var(--text-tertiary);display:block;margin-bottom:4px;">Role</label>' +
                            '<input type="text" id="editCustomRole" value="' + (customAgent.role || '').replace(/"/g,'&quot;') + '" style="width:100%;padding:6px 10px;border-radius:8px;border:1px solid var(--border-medium);font-size:13px;background:var(--bg-tertiary);color:var(--text-primary);font-family:var(--font-family);" /></div>' +
                        '</div>' +
                        '<div><label style="font-size:11px;color:var(--text-tertiary);display:block;margin-bottom:4px;">Traits (comma-separated)</label>' +
                        '<input type="text" id="editCustomTraits" value="' + (customAgent.traits || []).join(', ').replace(/"/g,'&quot;') + '" style="width:100%;padding:6px 10px;border-radius:8px;border:1px solid var(--border-medium);font-size:13px;background:var(--bg-tertiary);color:var(--text-primary);font-family:var(--font-family);" /></div>' +
                        '<div><label style="font-size:11px;color:var(--text-tertiary);display:block;margin-bottom:4px;">SOUL</label>' +
                        '<textarea id="editCustomSoul" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border-medium);font-size:12px;background:var(--bg-tertiary);color:var(--text-primary);font-family:var(--font-family);min-height:60px;resize:vertical;">' + (customAgent.soul || '').replace(/</g,'&lt;') + '</textarea></div>' +
                        '<div style="display:flex;gap:8px;">' +
                            '<button id="saveCustomEditBtn" style="padding:8px 20px;border-radius:8px;border:none;background:var(--exec-blue);color:#fff;font-size:13px;font-weight:600;cursor:pointer;font-family:var(--font-family);">Save Changes</button>' +
                            '<button id="decommissionCustomBtn" style="padding:8px 16px;border-radius:8px;border:1px solid var(--status-error);background:transparent;color:var(--status-error);font-size:13px;font-weight:500;cursor:pointer;font-family:var(--font-family);">🔥 Decommission</button>' +
                        '</div>' +
                    '</div>';

                body.insertBefore(editSection, body.firstChild);

                // Wire up save
                document.getElementById('saveCustomEditBtn').addEventListener('click', function() {
                    var name = document.getElementById('editCustomName').value.trim();
                    var role = document.getElementById('editCustomRole').value.trim();
                    var traits = document.getElementById('editCustomTraits').value.split(',').map(function(t) { return t.trim(); }).filter(Boolean);
                    var soul = document.getElementById('editCustomSoul').value;

                    if (!name || !role) { showToast('Name and role are required'); return; }

                    // Update localStorage
                    var agents = [];
                    try { agents = JSON.parse(localStorage.getItem('spawnkit-custom-agents') || '[]'); } catch(e) {}
                    var idx = agents.findIndex(function(a) { return a.id === agentId; });
                    if (idx >= 0) {
                        agents[idx].name = name;
                        agents[idx].role = role;
                        agents[idx].traits = traits;
                        agents[idx].soul = soul;
                        try { localStorage.setItem('spawnkit-custom-agents', JSON.stringify(agents)); } catch(e) {}
                    }

                    // Update AGENTS
                    if (AGENTS[agentId]) {
                        AGENTS[agentId].name = name;
                        AGENTS[agentId].role = role;
                    }

                    // Update grid room
                    var roomEl = gridView.querySelector('[data-agent="' + agentId + '"]');
                    if (roomEl) {
                        var nameEl = roomEl.querySelector('.agent-name');
                        var roleEl = roomEl.querySelector('.agent-role');
                        var labelEl = roomEl.querySelector('.exec-room-label');
                        if (nameEl) nameEl.textContent = name;
                        if (roleEl) roleEl.textContent = role;
                        if (labelEl) labelEl.textContent = name;
                    }

                    // Update hierarchy
                    var hierCards = hierarchyView.querySelectorAll('[data-agent="' + agentId + '"]');
                    hierCards.forEach(function(card) {
                        var n = card.querySelector('.agent-name');
                        var r = card.querySelector('.agent-role');
                        if (n) n.textContent = name;
                        if (r) r.textContent = role;
                    });

                    // Update detail hero
                    document.getElementById('detailName').textContent = name;
                    document.getElementById('detailRole').textContent = role;

                    showToast('✅ ' + name + ' updated');
                    SoundEngine.chime();
                });

                // Wire up decommission
                document.getElementById('decommissionCustomBtn').addEventListener('click', function() {
                    closeDetailPanel();
                    var roomEl = gridView.querySelector('[data-agent="' + agentId + '"]');
                    // Use decommission logic
                    SoundEngine.decommission();
                    if (roomEl) {
                        roomEl.classList.add('decommission-anim');
                        var rect = roomEl.getBoundingClientRect();
                        for (var p = 0; p < 8; p++) {
                            var particle = document.createElement('div');
                            particle.className = 'decommission-particle';
                            particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
                            particle.style.top = (rect.top + Math.random() * rect.height) + 'px';
                            document.body.appendChild(particle);
                            setTimeout(function() { particle.remove(); }, 800);
                        }
                    }
                    // Remove from localStorage
                    var agents = [];
                    try { agents = JSON.parse(localStorage.getItem('spawnkit-custom-agents') || '[]'); } catch(e) {}
                    var removed = agents.find(function(a) { return a.id === agentId; });
                    agents = agents.filter(function(a) { return a.id !== agentId; });
                    try { localStorage.setItem('spawnkit-custom-agents', JSON.stringify(agents)); } catch(e) {}
                    delete AGENTS[agentId];
                    setTimeout(function() {
                        if (roomEl) roomEl.remove();
                        var hierEl = hierarchyView.querySelector('[data-custom-agent="' + agentId + '"]');
                        if (hierEl) hierEl.remove();
                        var totalAgents = 6 + agents.length;
                        var uptimeEl = document.getElementById('statusAgentCount');
                        if (uptimeEl) uptimeEl.textContent = totalAgents + ' Agents';
                    }, 800);
                    showToast('🔥 ' + (removed ? removed.name : 'Agent') + ' decommissioned');
                });
            };
        })();

        /* ═══════════════════════════════════════════════
           Onboarding — First-Run Walkthrough (OBJ5)
           Apple-quality 5-step experience
           ═══════════════════════════════════════════════ */
        (function initOnboarding() {
            var ONBOARDED_KEY = 'spawnkit-onboarded';

            // Check if user has already been onboarded
            if (localStorage.getItem(ONBOARDED_KEY) === 'true') return;

            var overlay   = document.getElementById('onboardingOverlay');
            var scrim     = document.getElementById('onboardingScrim');
            var spotlight = document.getElementById('onboardingSpotlight');
            var card      = document.getElementById('onboardingCard');
            var title     = document.getElementById('onboardingTitle');
            var text      = document.getElementById('onboardingText');
            var cta       = document.getElementById('onboardingCta');
            var avatar    = document.getElementById('onboardingAvatar');
            var skipBtn   = document.getElementById('onboardingSkip');
            var dots      = document.getElementById('onboardingDots');
            var dotEls    = dots.querySelectorAll('.onboarding-dot');

            var currentStep = 0;
            var totalSteps = 5;

            // Step definitions
            var steps = [
                {
                    type: 'welcome',
                    title: 'Welcome to your Executive Office',
                    text: "I'm your CEO. This is where your AI fleet lives and works. Let me give you a quick tour of the space.",
                    cta: "Let's go →",
                    showAvatar: true,
                    target: null
                },
                {
                    type: 'spotlight',
                    title: 'Your C-Level Executives',
                    text: 'These are your agents — each one manages a different department. Atlas runs operations, Forge builds, Hunter sells, Echo markets, and Sentinel guards quality. Click any agent to see their details.',
                    cta: 'Next →',
                    showAvatar: false,
                    target: function() {
                        // Target the agent rooms area (rows 2-3 of grid)
                        var rooms = document.querySelectorAll('.exec-floor .exec-room:not(.exec-room--ceo):not(.exec-room--meeting)');
                        if (rooms.length === 0) return null;
                        return getBoundingRectMultiple(rooms);
                    },
                    cardPosition: 'top'
                },
                {
                    type: 'spotlight',
                    title: 'Your Command Center',
                    text: 'Missions, schedules, memory, chat — everything is here. Try the command input to chat with me directly. This is your control surface.',
                    cta: 'Next →',
                    showAvatar: false,
                    target: function() {
                        var bar = document.querySelector('.exec-statusbar');
                        return bar ? bar.getBoundingClientRect() : null;
                    },
                    cardPosition: 'above'
                },
                {
                    type: 'spotlight',
                    title: 'The Boardroom',
                    text: "Active work sessions appear here. When your agents collaborate on complex tasks, the boardroom shows what's happening in real time.",
                    cta: 'Next →',
                    showAvatar: false,
                    target: function() {
                        var room = document.querySelector('.exec-room--meeting');
                        return room ? room.getBoundingClientRect() : null;
                    },
                    cardPosition: 'left'
                },
                {
                    type: 'complete',
                    title: "You're all set!",
                    text: 'Your office is live and your agents are ready to work. Click any agent to dive deeper, or use the command bar to send a mission.',
                    cta: 'Start Working →',
                    showAvatar: true,
                    target: null
                }
            ];

            // Helper: get bounding rect encompassing multiple elements
            function getBoundingRectMultiple(elements) {
                var minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                elements.forEach(function(el) {
                    var r = el.getBoundingClientRect();
                    if (r.left < minX) minX = r.left;
                    if (r.top < minY) minY = r.top;
                    if (r.right > maxX) maxX = r.right;
                    if (r.bottom > maxY) maxY = r.bottom;
                });
                return { left: minX, top: minY, right: maxX, bottom: maxY, width: maxX - minX, height: maxY - minY };
            }

            // Position the card relative to a spotlight
            function positionCard(step, rect) {
                card.className = 'onboarding-card';

                if (step.type === 'welcome' || step.type === 'complete') {
                    card.classList.add('onboarding-card--' + step.type);
                    card.style.left = '';
                    card.style.top = '';
                    card.style.right = '';
                    card.style.bottom = '';
                    return;
                }

                // For spotlight steps, position intelligently
                var vw = window.innerWidth;
                var vh = window.innerHeight;
                var cardW = Math.min(380, vw - 48);
                var margin = 20;

                card.style.left = '';
                card.style.top = '';
                card.style.right = '';
                card.style.bottom = '';

                if (!rect) return;

                if (step.cardPosition === 'above') {
                    // Above the target
                    var centerX = rect.left + rect.width / 2;
                    var left = Math.max(24, Math.min(centerX - cardW / 2, vw - cardW - 24));
                    card.style.left = left + 'px';
                    card.style.bottom = (vh - rect.top + margin) + 'px';
                } else if (step.cardPosition === 'top') {
                    // Above the spotlight (agent grid)
                    var centerX = rect.left + rect.width / 2;
                    var left = Math.max(24, Math.min(centerX - cardW / 2, vw - cardW - 24));
                    card.style.left = left + 'px';
                    card.style.bottom = (vh - rect.top + margin) + 'px';
                    // If it goes off screen top, put below instead
                    if (vh - rect.top + margin + 200 > vh) {
                        card.style.bottom = '';
                        card.style.top = (rect.bottom + margin) + 'px';
                    }
                } else if (step.cardPosition === 'left') {
                    // Left of the target
                    var left = rect.left - cardW - margin;
                    if (left < 24) {
                        // Not enough space on left, put below
                        left = Math.max(24, Math.min(rect.left, vw - cardW - 24));
                        card.style.left = left + 'px';
                        card.style.top = (rect.bottom + margin) + 'px';
                    } else {
                        card.style.left = left + 'px';
                        card.style.top = Math.max(24, rect.top) + 'px';
                    }
                } else {
                    // Default: below target
                    var centerX = rect.left + rect.width / 2;
                    var left = Math.max(24, Math.min(centerX - cardW / 2, vw - cardW - 24));
                    card.style.left = left + 'px';
                    card.style.top = (rect.bottom + margin) + 'px';
                }
            }

            // Update dots
            function updateDots(step) {
                dotEls.forEach(function(dot, i) {
                    dot.classList.toggle('active', i === step);
                    dot.setAttribute('aria-selected', i === step ? 'true' : 'false');
                    dot.setAttribute('tabindex', i === step ? '0' : '-1');
                });
            }

            // Show a specific step
            function showStep(stepIdx) {
                if (stepIdx < 0 || stepIdx >= totalSteps) return;
                currentStep = stepIdx;
                var step = steps[stepIdx];

                // Fade out card first
                card.classList.remove('visible');

                setTimeout(function() {
                    // Update content
                    title.textContent = step.title;
                    text.textContent = step.text;
                    cta.textContent = step.cta;

                    // Avatar visibility
                    avatar.style.display = step.showAvatar ? '' : 'none';

                    // Spotlight
                    if (step.target) {
                        var rect = typeof step.target === 'function' ? step.target() : step.target;
                        if (rect) {
                            var pad = 10;
                            spotlight.style.display = '';
                            spotlight.style.left = (rect.left - pad) + 'px';
                            spotlight.style.top = (rect.top - pad) + 'px';
                            spotlight.style.width = (rect.width + pad * 2) + 'px';
                            spotlight.style.height = (rect.height + pad * 2) + 'px';
                            scrim.style.opacity = '0';
                            positionCard(step, rect);
                        } else {
                            spotlight.style.display = 'none';
                            scrim.style.opacity = '1';
                            positionCard(step, null);
                        }
                    } else {
                        spotlight.style.display = 'none';
                        scrim.style.opacity = '1';
                        positionCard(step, null);
                    }

                    // Update dots
                    updateDots(stepIdx);

                    // Fade in card
                    requestAnimationFrame(function() {
                        card.classList.add('visible');
                    });
                }, 200);
            }

            // Next step
            function nextStep() {
                if (currentStep >= totalSteps - 1) {
                    completeOnboarding();
                    return;
                }
                showStep(currentStep + 1);
            }

            // Complete
            function completeOnboarding() {
                localStorage.setItem(ONBOARDED_KEY, 'true');
                card.classList.remove('visible');
                dots.classList.remove('visible');
                skipBtn.classList.remove('visible');

                setTimeout(function() {
                    overlay.classList.remove('active');
                    // Clean up: allow body scroll
                    document.body.style.overflow = '';
                }, 300);

                // Show a welcome toast after closing
                setTimeout(function() {
                    if (typeof showToast === 'function') {
                        showToast('🎉 Welcome to your Executive Office!');
                    }
                }, 800);
            }

            // Skip
            function skipOnboarding() {
                completeOnboarding();
            }

            // Event listeners
            cta.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                nextStep();
            });

            skipBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                skipOnboarding();
            });

            // Keyboard navigation
            overlay.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    skipOnboarding();
                } else if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    nextStep();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    nextStep();
                } else if (e.key === 'ArrowLeft' && currentStep > 0) {
                    e.preventDefault();
                    showStep(currentStep - 1);
                }
            });

            // Dot click navigation
            dotEls.forEach(function(dot, i) {
                dot.addEventListener('click', function() {
                    showStep(i);
                });
            });

            // Handle window resize — reposition spotlight + card
            var resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    if (overlay.classList.contains('active')) {
                        showStep(currentStep);
                    }
                }, 150);
            });

            // START: Launch onboarding after a brief delay for page to settle
            setTimeout(function() {
                overlay.classList.add('active');
                dots.classList.add('visible');
                skipBtn.classList.add('visible');
                document.body.style.overflow = 'hidden';
                showStep(0);
                cta.focus();
            }, 600);

        })();

        /* Expose onboarding reset for Settings panel */
        window.resetOnboarding = function() {
            localStorage.removeItem('spawnkit-onboarded');
            location.reload();
        };

    })();
    </script>

</body>
</html>